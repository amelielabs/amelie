env_open E0 "cluster_shards": 3
connect E0 S0
connect: on_connect
# test: select expr
explain select system.config().cluster_shards
"
bytecode [coordinator]
--------
 0                call        0      -      0      # system.config()
 1              string        1      0      0      # cluster_shards
 2                 idx        2      0      1
 3                send        2      0      0
 4                 ret        0      0      0

"
select system.config().cluster_shards
3
# test: select from expr
explain select * from [1,2,3]
"
bytecode [coordinator]
--------
 0                 int        0      1      0
 1                push        0      0      0
 2                 int        0      2      0
 3                push        0      0      0
 4                 int        0      3      0
 5                push        0      0      0
 6               array        0      3      0
 7    cursor_open_expr        0      0      9
 8                 jmp       12      0      0
 9         cursor_read        1      0      0
10                send        1      0      0
11         cursor_next        0      9      0
12        cursor_close        0      0      0
13                 ret        0      0      0

"
select * from [1,2,3]
1
2
3
# test: select (select expr)
explain select (select 123)
"
bytecode [coordinator]
--------
 0                 int        0    123      0
 1                send        0      0      0
 2                 ret        0      0      0

"
select (select 123)
123
# test: select (select expr) from expr
explain select (select a.*) from [1,2,3] a
"
bytecode [coordinator]
--------
 0                 int        0      1      0
 1                push        0      0      0
 2                 int        0      2      0
 3                push        0      0      0
 4                 int        0      3      0
 5                push        0      0      0
 6               array        0      3      0
 7    cursor_open_expr        0      0      9
 8                 jmp       12      0      0
 9         cursor_read        1      0      0
10                send        1      0      0
11         cursor_next        0      9      0
12        cursor_close        0      0      0
13                 ret        0      0      0

"
select (select a.*) from [1,2,3] a
1
2
3
# test: select (select from expr)
explain select (select * from [1, 2, 3])
"
bytecode [coordinator]
--------
 0                 set        0      0      0
 1                 int        1      1      0
 2                push        1      0      0
 3                 int        1      2      0
 4                push        1      0      0
 5                 int        1      3      0
 6                push        1      0      0
 7               array        1      3      0
 8    cursor_open_expr        0      1     10
 9                 jmp       13      0      0
10         cursor_read        2      0      0
11             set_add        0      2      0
12         cursor_next        0     10      0
13        cursor_close        0      0      0
14                send        0      0      0
15                 ret        0      0      0

"
select (select * from [1, 2, 3])
[1, 2, 3]
# test: select from (select expr)
explain select * from (select [1,2,3])
"
bytecode [coordinator]
--------
 0                 int        0      1      0
 1                push        0      0      0
 2                 int        0      2      0
 3                push        0      0      0
 4                 int        0      3      0
 5                push        0      0      0
 6               array        0      3      0
 7    cursor_open_expr        0      0      9
 8                 jmp       12      0      0
 9         cursor_read        1      0      0
10                send        1      0      0
11         cursor_next        0      9      0
12        cursor_close        0      0      0
13                 ret        0      0      0

"
select * from (select [1,2,3])
1
2
3
# test: select (select expr from) from expr
explain select (select a.*, * from [3,2,1]) from [1,2,3] a
"
bytecode [coordinator]
--------
 0                 int        0      1      0
 1                push        0      0      0
 2                 int        0      2      0
 3                push        0      0      0
 4                 int        0      3      0
 5                push        0      0      0
 6               array        0      3      0
 7    cursor_open_expr        1      0      9
 8                 jmp       29      0      0
 9                 set        1      0      0
10                 int        2      3      0
11                push        2      0      0
12                 int        2      2      0
13                push        2      0      0
14                 int        2      1      0
15                push        2      0      0
16               array        2      3      0
17    cursor_open_expr        0      2     19
18                 jmp       26      0      0
19         cursor_read        3      1      0
20                push        3      0      0
21         cursor_read        3      0      0
22                push        3      0      0
23               array        3      2      0
24             set_add        1      3      0
25         cursor_next        0     19      0
26        cursor_close        0      0      0
27                send        1      0      0
28         cursor_next        1      9      0
29        cursor_close        1      0      0
30                 ret        0      0      0

"
select (select a.*, * from [3,2,1]) from [1,2,3] a
[[1, 3], [1, 2], [1, 1]]
[[2, 3], [2, 2], [2, 1]]
[[3, 3], [3, 2], [3, 1]]
# test: select (select expr from) from (select from expr)
explain select (select a.*, * from [3,2,1]) from (select * from [1,2,3]) a
"
bytecode [coordinator]
--------
 0                 set        0      0      0
 1                 int        1      1      0
 2                push        1      0      0
 3                 int        1      2      0
 4                push        1      0      0
 5                 int        1      3      0
 6                push        1      0      0
 7               array        1      3      0
 8    cursor_open_expr        1      1     10
 9                 jmp       13      0      0
10         cursor_read        2      1      0
11             set_add        0      2      0
12         cursor_next        1     10      0
13        cursor_close        1      0      0
14    cursor_open_expr        2      0     16
15                 jmp       36      0      0
16                 set        1      0      0
17                 int        2      3      0
18                push        2      0      0
19                 int        2      2      0
20                push        2      0      0
21                 int        2      1      0
22                push        2      0      0
23               array        2      3      0
24    cursor_open_expr        0      2     26
25                 jmp       33      0      0
26         cursor_read        3      2      0
27                push        3      0      0
28         cursor_read        3      0      0
29                push        3      0      0
30               array        3      2      0
31             set_add        1      3      0
32         cursor_next        0     26      0
33        cursor_close        0      0      0
34                send        1      0      0
35         cursor_next        2     16      0
36        cursor_close        2      0      0
37                 ret        0      0      0

"
select (select a.*, * from [3,2,1]) from (select * from [1,2,3]) a
[[1, 3], [1, 2], [1, 1]]
[[2, 3], [2, 2], [2, 1]]
[[3, 3], [3, 2], [3, 1]]
disconnect S0
env_close E0
