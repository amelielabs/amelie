open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }]
connect E0 S0 127.0.0.1:3485
# test: for parsing
for
{"msg": "for ⟵ name expected"}
for 1
{"msg": "for ❰1❱ ⟵ name expected"}
for it
{"msg": "for it ⟵ IN expected"}
for it 1
{"msg": "for it ❰1❱ ⟵ IN expected"}
for it in
{"msg": "for it in ⟵ unexpected end of statement"}
for it in 1
{"msg": "for it in 1 ⟵ unexpected statement"}
for it in ;
{"msg": "for it in ; ⟵ unexpected statement"}
for it in [1,2,3]
{"msg": "for it in [❰1❱ ⟵ unexpected statement"}
for it in select [1,2,3]
{"msg": "for it in select [1,2,3] ⟵ DO expected"}
for it in select [1,2,3];
{"msg": "for it in select [1,2,3]❰;❱ ⟵ DO expected"}
for it in select [1,2,3] then
{"msg": "for it in select [1,2,3] ❰then❱ ⟵ DO expected"}
for it in select [1,2,3] do
{"msg": "for it in select [1,2,3] do ⟵ END expected"}
# test: for
explain for it in select [1,2,3] do end
[{
  "bytecode": {
    "frontend": {
      "00": "json                0      0      0     ",
      "01": "ref                 1      0      0     ",
      "02": "json_open           2      1      4     ",
      "03": "json_next           2      3      0     ",
      "04": "free                2      0      0     ",
      "05": "free                1      0      0     ",
      "06": "free                0      0      0     ",
      "07": "ret                 0      0      0     "
    }
  },
  "access": []
}]
for it in select [1,2,3] do end
declare n int; n := 0; for it in select [1,2,3] do n := n + 1; end; select n
[3]
# test: for if
declare n int; n := 0; for it in select [1,2,3,4] as it do if it::int % 2 = 0 then n := n + 1; end; end; select n
[2]
# test: for for
declare n int; n := 0; for i in select [1,2,3] do for j in select [1,2,3] do n := n + 1; end; end; select n
[9]
explain declare n int; n := 0; for i in select [1,2,3] as i do for j in select [1,2,3] as j do n := n + i.i::int + j.j::int; end; end; select n
[{
  "bytecode": {
    "frontend": {
      "00": "int                 1      -      0     # 0",
      "01": "assign              0      1      0     ",
      "02": "json                1      0      0     ",
      "03": "ref                 2      1      0     ",
      "04": "json_open           3      2      23    ",
      "05": "json                4      5      0     ",
      "06": "ref                 5      4      0     ",
      "07": "json_open           6      5      19    ",
      "08": "ref                 7      0      0     ",
      "09": "json_read           8      3      0     ",
      "10": "push                8      0      0     ",
      "11": "call                8      -      1     # public.int()",
      "12": "json_read           9      6      0     ",
      "13": "push                9      0      0     ",
      "14": "call                9      -      1     # public.int()",
      "15": "addii               10     8      9     ",
      "16": "addii               8      7      10    ",
      "17": "assign              0      8      0     ",
      "18": "json_next           6      8      0     ",
      "19": "free                6      0      0     ",
      "20": "free                5      0      0     ",
      "21": "free                4      0      0     ",
      "22": "json_next           3      5      0     ",
      "23": "free                3      0      0     ",
      "24": "free                2      0      0     ",
      "25": "free                1      0      0     ",
      "26": "ref                 1      0      0     ",
      "27": "content             1      -      -     ",
      "28": "ret                 0      0      0     "
    }
  },
  "access": []
}]
declare n int; n := 0; for i in select [1,2,3] as i do for j in select [1,2,3] as j do n := n + i.i::int + j.j::int; end; end; select n
[36]
# test: for for for
declare n int; n := 0; for i in select [1,2,3] do for j in select [1,2,3] do for k in select [1,2,3] do n := n + 1; end; end; end; select n
[27]
declare n int; n := 0; for i in select [1,2,3] as i do for j in select [1,2,3] as j do for k in select [1,2,3] as k do n := n + i.i::int + j.j::int + k.k::int; end; end; end; select n
[162]
# test: for in select
create table test (id int primary key)
insert into test values (1), (2), (3)
explain declare n int; n := 0; for i in select * from test do n := n + 1; end; select n
[{
  "bytecode": {
    "frontend": {
      "00": "int                 1      -      0     # 0",
      "01": "assign              0      1      0     ",
      "02": "union               1      0      0     ",
      "03": "send_all            0      -      1     # public.test (last)",
      "04": "union_recv          1      0      0     ",
      "05": "union_set           1      0      -1    ",
      "06": "ref                 2      1      0     ",
      "07": "store_open          3      2      13    ",
      "08": "ref                 4      0      0     ",
      "09": "int                 5      -      0     # 1",
      "10": "addii               6      4      5     ",
      "11": "assign              0      6      0     ",
      "12": "store_next          3      8      0     ",
      "13": "free                3      0      0     ",
      "14": "free                2      0      0     ",
      "15": "free                1      0      0     ",
      "16": "ref                 1      0      0     ",
      "17": "content             1      -      -     ",
      "18": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      1      0     ",
      "01": "table_open_part     2      0      6     # public.test (primary)",
      "02": "table_readi32       3      2      0     ",
      "03": "push                3      0      0     ",
      "04": "set_add             1      0      0     ",
      "05": "table_next          2      2      0     ",
      "06": "free                2      0      0     ",
      "07": "result              1      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
declare n int; n := 0; for i in select * from test do n := n + 1; end; select n
[3]
declare n int; n := 0; for i in select * from test do n := n + i.id; end; select n
[6]
drop table test
# test: for in select for int select
create table test (id int primary key)
insert into test values (1), (2), (3)
explain declare n int; n := 0; for i in select * from test do  for j in select * from test do n := n + 1; end; end; select n
[{
  "bytecode": {
    "frontend": {
      "00": "int                 1      -      0     # 0",
      "01": "assign              0      1      0     ",
      "02": "union               1      0      0     ",
      "03": "send_all            0      -      1     # public.test",
      "04": "union_recv          1      0      0     ",
      "05": "union_set           1      0      -1    ",
      "06": "ref                 2      1      0     ",
      "07": "store_open          3      2      23    ",
      "08": "union               4      0      0     ",
      "09": "send_all            9      -      4     # public.test",
      "10": "union_recv          4      0      0     ",
      "11": "union_set           4      0      -1    ",
      "12": "ref                 5      4      0     ",
      "13": "store_open          6      5      19    ",
      "14": "ref                 7      0      0     ",
      "15": "int                 8      -      0     # 1",
      "16": "addii               9      7      8     ",
      "17": "assign              0      9      0     ",
      "18": "store_next          6      14     0     ",
      "19": "free                6      0      0     ",
      "20": "free                5      0      0     ",
      "21": "free                4      0      0     ",
      "22": "store_next          3      8      0     ",
      "23": "free                3      0      0     ",
      "24": "free                2      0      0     ",
      "25": "free                1      0      0     ",
      "26": "close               0      0      0     ",
      "27": "ref                 1      0      0     ",
      "28": "content             1      -      -     ",
      "29": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      1      0     ",
      "01": "table_open_part     2      0      6     # public.test (primary)",
      "02": "table_readi32       3      2      0     ",
      "03": "push                3      0      0     ",
      "04": "set_add             1      0      0     ",
      "05": "table_next          2      2      0     ",
      "06": "free                2      0      0     ",
      "07": "result              1      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 4      1      0     ",
      "10": "table_open_part     5      20     15    # public.test (primary)",
      "11": "table_readi32       6      5      0     ",
      "12": "push                6      0      0     ",
      "13": "set_add             4      0      0     ",
      "14": "table_next          5      11     0     ",
      "15": "free                5      0      0     ",
      "16": "result              4      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
declare n int; n := 0; for i in select * from test do  for j in select * from test do n := n + 1; end; end; select n
[9]
declare n int; n := 0; for i in select * from test do  for j in select * from test do n := n + i.id + j.id; end; end; select n
[36]
drop table test
# test: for .. select
create table test (id int primary key)
insert into test values (1), (2), (3)
explain declare total int; n int; total := 0; for i in select [1,2,3] do n := select count(id) from test; total := total + n; end; select total;
[{
  "bytecode": {
    "frontend": {
      "00": "int                 2      -      0     # 0",
      "01": "assign              0      2      0     ",
      "02": "json                2      0      0     ",
      "03": "ref                 3      2      0     ",
      "04": "json_open           4      3      24    ",
      "05": "union               5      0      0     ",
      "06": "send_all            0      -      5     # public.test",
      "07": "union_recv          5      0      0     ",
      "08": "union_set           5      1      -1    ",
      "09": "union_set_aggs      5      26     0     ",
      "10": "set                 6      1      0     ",
      "11": "store_open          7      5      16    ",
      "12": "count               8      7      0     ",
      "13": "push                8      0      0     ",
      "14": "set_add             6      0      0     ",
      "15": "store_next          7      12     0     ",
      "16": "free                7      0      0     ",
      "17": "free                5      0      0     ",
      "18": "assign              1      6      0     ",
      "19": "ref                 5      0      0     ",
      "20": "ref                 6      1      0     ",
      "21": "addii               7      5      6     ",
      "22": "assign              0      7      0     ",
      "23": "json_next           4      5      0     ",
      "24": "free                4      0      0     ",
      "25": "free                3      0      0     ",
      "26": "free                2      0      0     ",
      "27": "close               0      0      0     ",
      "28": "ref                 2      0      0     ",
      "29": "content             2      -      -     ",
      "30": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set_ordered         5      1      1     ",
      "01": "table_open_part     6      6      9     # public.test (primary)",
      "02": "bool                7      1      0     ",
      "03": "push                7      0      0     ",
      "04": "set_get             7      5      0     ",
      "05": "table_readi32       8      6      0     ",
      "06": "push                8      0      0     ",
      "07": "set_agg             5      7      26    ",
      "08": "table_next          6      2      0     ",
      "09": "free                6      0      0     ",
      "10": "bool                6      1      0     ",
      "11": "push                6      0      0     ",
      "12": "set_get             6      5      0     ",
      "13": "null                7      0      0     ",
      "14": "push                7      0      0     ",
      "15": "set_agg             5      6      26    ",
      "16": "set_sort            5      0      0     ",
      "17": "result              5      0      0     ",
      "18": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
declare total int; n int; total := 0; for i in select [1,2,3] do n := select count(id) from test; total := total + n; end; select total;
[9]
drop table test
# test: for .. returning
create table test (id int primary key, data int)
insert into test values (1, 0), (2, 0), (3, 0)
explain declare n int; n := 0; for i in update test set data = id returning id do n := n + i.id; end; select n
[{
  "bytecode": {
    "frontend": {
      "00": "int                 1      -      0     # 0",
      "01": "assign              0      1      0     ",
      "02": "union               1      0      0     ",
      "03": "send_all            0      -      1     # public.test (last)",
      "04": "union_recv          1      0      0     ",
      "05": "ref                 2      1      0     ",
      "06": "store_open          3      2      12    ",
      "07": "ref                 4      0      0     ",
      "08": "store_read          5      3      0     ",
      "09": "addii               6      4      5     ",
      "10": "assign              0      6      0     ",
      "11": "store_next          3      7      0     ",
      "12": "free                3      0      0     ",
      "13": "free                2      0      0     ",
      "14": "free                1      0      0     ",
      "15": "ref                 1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      1      0     ",
      "01": "table_open_part     2      0      11    # public.test (primary)",
      "02": "int                 3      -      0     # 1",
      "03": "push                3      0      0     ",
      "04": "table_readi32       3      2      0     ",
      "05": "push                3      0      0     ",
      "06": "update              2      1      0     ",
      "07": "table_readi32       3      2      0     ",
      "08": "push                3      0      0     ",
      "09": "set_add             1      0      0     ",
      "10": "table_next          2      2      0     ",
      "11": "free                2      0      0     ",
      "12": "result              1      0      0     ",
      "13": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "rw"]]
}]
declare n int; n := 0; for i in update test set data = id returning id do n := n + i.id; end; select n
[6]
drop table test
# test: for .. upsert
create table test (id int primary key, data int)
insert into test values (1, 0)
explain for i in select [1,2,3] do insert into test values (1, 0) on conflict do update set data = data + 1; end
[{
  "bytecode": {
    "frontend": {
      "00": "json                0      0      0     ",
      "01": "ref                 1      0      0     ",
      "02": "json_open           2      1      6     ",
      "03": "set_ptr             3      -      0     ",
      "04": "send_shard          0      -      3     # public.test",
      "05": "json_next           2      3      0     ",
      "06": "free                2      0      0     ",
      "07": "free                1      0      0     ",
      "08": "free                0      0      0     ",
      "09": "close               0      0      0     ",
      "10": "ret                 0      0      0     "
    },
    "backend": {
      "00": "table_prepare       3      -      0     # public.test",
      "01": "jmp                 9      0      0     ",
      "02": "int                 4      -      0     # 1",
      "03": "push                4      0      0     ",
      "04": "table_readi32       4      3      1     ",
      "05": "int                 5      -      0     # 1",
      "06": "addii               6      4      5     ",
      "07": "push                6      0      0     ",
      "08": "update              3      1      0     ",
      "09": "upsert              3      2      -1    ",
      "10": "free                3      0      0     ",
      "11": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "rw"]]
}]
for i in select [1,2,3] do insert into test values (1, 0) on conflict do update set data = data + 1; end
select * from test;
[[1, 3]]
drop table test
disconnect S0
close E0
