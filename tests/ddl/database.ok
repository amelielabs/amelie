open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;
# test: ensure system databases exists
show databases;
[{
  "name": "main"
}]
# test: create database statement parsing
create;
{"msg": "create❰;❱ ⟵ USER|REPLICA|STORAGE|DATABASE|TABLE|INDEX|TIER|FUNCTION expected"}
create database;
{"msg": "create database❰;❱ ⟵ name expected"}
create database 123;
{"msg": "create database ❰123❱ ⟵ name expected"}
create database if;
{"msg": "create database if❰;❱ ⟵ NOT expected"}
create database if not;
{"msg": "create database if not❰;❱ ⟵ EXISTS expected"}
create database if not 123;
{"msg": "create database if not ❰123❱ ⟵ EXISTS expected"}
create database if not exists;
{"msg": "create database if not exists❰;❱ ⟵ name expected"}
create database test abc;
{"msg": "create database test ❰abc❱ ⟵ ; expected"}
# test: create database
create database test;
show databases;
[{
  "name": "main"
}, {
  "name": "test"
}]
select show('databases');
[[{
  "name": "main"
}, {
  "name": "test"
}]]
# test: create database if not exists
create database test;
{"msg": "database 'test': already exists"}
create database if not exists test;
show databases;
[{
  "name": "main"
}, {
  "name": "test"
}]
# test: drop database statement parsing
drop database;
{"msg": "drop database❰;❱ ⟵ name expected"}
drop database 123;
{"msg": "drop database ❰123❱ ⟵ name expected"}
drop database if;
{"msg": "drop database if❰;❱ ⟵ EXISTS expected"}
drop database if exists;
{"msg": "drop database if exists❰;❱ ⟵ name expected"}
drop database test abc;
{"msg": "drop database test ❰abc❱ ⟵ ; expected"}
# test: drop database
drop database test;
show databases;
[{
  "name": "main"
}]
# test: drop database if exists
drop database test;
{"msg": "database 'test': not exists"}
drop database if exists test;
show databases;
[{
  "name": "main"
}]
# test: drop main database
drop database main;
{"msg": "database 'main': system db cannot be dropped"}
show databases;
[{
  "name": "main"
}]
# test: drop database cascade
create database test;
drop database test cascade;
show databases;
[{
  "name": "main"
}]
# test: drop connected database
create database test;
show databases;
[{
  "name": "main"
}, {
  "name": "test"
}]
connect E0 S1 127.0.0.1:3485/test;
switch S1;
drop database test;
select 1;
{"msg": "database 'test': not exists"}
disconnect S1;
switch S0;
# test: drop database cascade (with relations)
create database test;
connect E0 S1 127.0.0.1:3485/test;
switch S1;
create table a(id int primary key);
create table b(id int primary key);
create function fn() begin select * from a; end;
drop database test;
{"msg": "table 'a' depends on db 'test"}
drop database test cascade;
select 1;
{"msg": "database 'test': not exists"}
disconnect S1;
switch S0;
show tables;
[]
show functions;
[]
show databases;
[{
  "name": "main"
}]
# test: alter database statment parsing
alter database;
{"msg": "alter database❰;❱ ⟵ name expected"}
alter database 123;
{"msg": "alter database ❰123❱ ⟵ name expected"}
alter database test;
{"msg": "alter database test❰;❱ ⟵ RENAME expected"}
alter database test rename;
{"msg": "alter database test rename❰;❱ ⟵ TO expected"}
alter database test rename to;
{"msg": "alter database test rename to❰;❱ ⟵ name expected"}
alter database test rename "hello";
{"msg": "alter database test rename ❰\"hello\"❱ ⟵ TO expected"}
# test: alter database rename
create database test;
show databases;
[{
  "name": "main"
}, {
  "name": "test"
}]
alter database test rename to test2;
show databases;
[{
  "name": "main"
}, {
  "name": "test2"
}]
drop database test2;
# test: alter database main
alter database main rename to _public;
{"msg": "database 'main': system db cannot be renamed"}
# test: alter database rename cascade (udf dep)
create database test;
connect E0 S1 127.0.0.1:3485/test;
switch S1;
create table a(id int primary key);
insert into a values (1), (2), (3);
create table b(id int primary key);
create function fn() return int
begin
	total int = 0;
	select count(*) into total from a;
	return total;
end;
select fn();
[3]
alter database test rename to test2;
{"msg": "function 'fn' is using database 'test"}
drop function fn;
# test: alter database rename cascade
alter database test rename to test2;
select 1;
{"msg": "database 'test': not exists"}
disconnect S1;
connect E0 S1 127.0.0.1:3485/test2;
switch S1;
show tables;
[{
  "db": "test2",
  "name": "a"
}, {
  "db": "test2",
  "name": "b"
}]
show functions;
[]
show databases;
[{
  "name": "main"
}, {
  "name": "test2"
}]
disconnect S1;
switch S0;
show tables;
[]
show functions;
[]
show databases;
[{
  "name": "main"
}, {
  "name": "test2"
}]
drop database test2;
{"msg": "table 'a' depends on db 'test2"}
drop database test2 cascade;
disconnect S0;
close E0;
