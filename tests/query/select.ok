open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;
# test: select statement parsing
select;
{"msg": "select❰;❱ ⟵ bad expression"}
select,;
{"msg": "select❰,❱ ⟵ bad expression"}
select null null;
{"msg": "select null ❰null❱ ⟵ ; expected"}
select null 1;
{"msg": "select null ❰1❱ ⟵ ; expected"}
select from;
{"msg": "select ❰from❱ ⟵ bad expression"}
select 1 from;
{"msg": "select 1 from❰;❱ ⟵ name expected"}
select 1 from "test";
{"msg": "select 1 from ❰\"test\"❱ ⟵ name expected"}
select 1 from name;
{"msg": "select 1 from ❰name❱ ⟵ relation not found"}
select 1 from 1 where;
{"msg": "select 1 from ❰1❱ ⟵ name expected"}
select 1 from 1 where null;
{"msg": "select 1 from ❰1❱ ⟵ name expected"}
# test: select expr
select 1;
[1]
select 1, 2;
[[1, 2]]
select [1, 2];
[[1, 2]]
select {};
[{}]
select null;
[null]
select null, null;
[[null, null]]
explain select 1;
[{
  "main": {
    "00": "int                 0      -      0     # 1",
    "01": "ret                 0      0      -     "
  },
  "access": []
}]
explain select [1, 2, 3];
[{
  "main": {
    "00": "json                0      0      0     ",
    "01": "ret                 0      0      -     "
  },
  "access": []
}]
# test: select name
select name;
{"msg": "select ❰name❱ ⟵ column not found"}
select name.name;
{"msg": "select ❰name.name❱ ⟵ target not found"}
select name.name.name;
{"msg": "select ❰name.name.name❱ ⟵ target not found"}
# test: select *
select *;
{"msg": "select ❰*❱ ⟵ no targets defined"}
select *, *;
{"msg": "select ❰*❱ ⟵ no targets defined"}
# test: select * from table
create table test (id serial primary key);
insert into test () values ();
insert into test () values ();
insert into test () values ();
explain select * from test;
[{
  "main": {
    "00": "send_all            0      0      18    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # test (primary)",
    "02": "table_readi64       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select * from test;
[0, 1, 2]
# test: select *, * from table
select *, * from test;
[[0, 0], [1, 1], [2, 2]]
# test: select target.* from table
select test.* from test;
[0, 1, 2]
select test.*, *, test.* from test;
[[0, 0, 0], [1, 1, 1], [2, 2, 2]]
select `test.*` from test;
[0, 1, 2]
drop table test;
# test: select column from table
create table test (id serial primary key, data int default 0);
insert into test () values ();
insert into test () values ();
insert into test () values ();
select * from test;
[[0, 0], [1, 0], [2, 0]]
explain select id, data from test;
[{
  "main": {
    "00": "send_all            0      0      18    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readi64       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select id, data from test;
[[0, 0], [1, 0], [2, 0]]
select `id`, data from test;
[[0, 0], [1, 0], [2, 0]]
drop table test;
# test: select column.path from table
create table test (id serial primary key, data json);
insert into test (data) values ({"data": 123});
insert into test (data) values ({"data": 123});
insert into test (`data`) values ({"data": 123});
select * from test;
[[0, {
  "data": 123
}], [1, {
  "data": 123
}], [2, {
  "data": 123
}]]
explain select data.data from test;
[{
  "main": {
    "00": "send_all            0      0      23    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readj         2      1      1     ",
    "03": "string              3      18     0     # data",
    "04": "dotjs               4      2      3     ",
    "05": "push                4      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select data.data from test;
[123, 123, 123]
drop table test;
# test: select column.path from table #2
create table test (id serial primary key, data json);
insert into test (data) values ({"data": {"data": 123}});
insert into test (data) values ({"data": {"data": 123}});
insert into test (data) values ({"data": {"data": 123}});
select * from test;
[[0, {
  "data": {
    "data": 123
  }
}], [1, {
  "data": {
    "data": 123
  }
}], [2, {
  "data": {
    "data": 123
  }
}]]
explain select data.data.data from test;
[{
  "main": {
    "00": "send_all            0      0      28    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readj         2      1      1     ",
    "03": "string              3      18     0     # data.data",
    "04": "dotjs               4      2      3     ",
    "05": "push                4      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select data.data.data from test;
[123, 123, 123]
drop table test;
# test: select target.column from table
create table test (id serial primary key, data int default 0);
insert into test () values ();
insert into test () values ();
insert into test () values ();
explain select test.id, test.data from test;
[{
  "main": {
    "00": "send_all            0      0      18    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readi64       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select test.id, test.data from test;
[[0, 0], [1, 0], [2, 0]]
drop table test;
# test: select target.column.path from table
create table test (id serial primary key, data json);
insert into test (data) values ({"data": 123});
insert into test (data) values ({"data": 123});
insert into test (data) values ({"data": 123});
explain select test.data.data from test;
[{
  "main": {
    "00": "send_all            0      0      23    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readj         2      1      1     ",
    "03": "string              3      18     0     # data",
    "04": "dotjs               4      2      3     ",
    "05": "push                4      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select test.data.data from test;
[123, 123, 123]
select test.data.data, * from test;
[[123, 0, {
  "data": 123
}], [123, 1, {
  "data": 123
}], [123, 2, {
  "data": 123
}]]
select test.data.data, *, test.* from test;
[[123, 0, {
  "data": 123
}, 0, {
  "data": 123
}], [123, 1, {
  "data": 123
}, 1, {
  "data": 123
}], [123, 2, {
  "data": 123
}, 2, {
  "data": 123
}]]
drop table test;
# test: select alias.column from table
create table test (id serial primary key, data int default 0);
insert into test () values ();
insert into test () values ();
insert into test () values ();
select * from test;
[[0, 0], [1, 0], [2, 0]]
explain select alias.id, alias.data from test alias;
[{
  "main": {
    "00": "send_all            0      0      18    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readi64       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select alias.id, alias.data from test alias;
[[0, 0], [1, 0], [2, 0]]
drop table test;
# test: select alias.column.path from table
create table test (id serial primary key, data json);
insert into test (data) values ({"data": 123});
insert into test (data) values ({"data": 123});
insert into test (data) values ({"data": 123});
explain select alias.data.data from test alias;
[{
  "main": {
    "00": "send_all            0      0      23    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readj         2      1      1     ",
    "03": "string              3      18     0     # data",
    "04": "dotjs               4      2      3     ",
    "05": "push                4      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select alias.data.data from test alias;
[123, 123, 123]
select alias.data['data'] from test alias;
[123, 123, 123]
drop table test;
# test: select alias.* from table
create table test (id serial primary key, data int default 0);
insert into test () values ();
insert into test () values ();
insert into test () values ();
select * from test;
[[0, 0], [1, 0], [2, 0]]
explain select alias.id, alias.data from test alias;
[{
  "main": {
    "00": "send_all            0      0      18    # test (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # test (primary)",
    "02": "table_readi64       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["test", "ro"]]
}]
select alias.id, alias.* from test alias;
[[0, 0, 0], [1, 1, 0], [2, 2, 0]]
drop table test;
# test: select * from function() (missing)
select * from unknown();
{"msg": "select * from ❰unknown❱ ⟵ function not found"}
# test: select * from function() (unsupported json type)
select * from show('wal');
{"msg": "FROM: json array expected"}
create user test;
select * from show('users');
[{
  "name": "test"
}]
explain select * from show('users');
[{
  "main": {
    "00": "set                 0      1      0     ",
    "01": "push_string         0      0      0     # users",
    "02": "call                1      -      1     # show()",
    "03": "json_open           2      1      8     ",
    "04": "json_read           3      2      0     ",
    "05": "push                3      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "json_next           2      4      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": []
}]
# test: select column from function()
select name from show('users');
["test"]
explain select name from show('users');
[{
  "main": {
    "00": "set                 0      1      0     ",
    "01": "push_string         0      0      0     # users",
    "02": "call                1      -      1     # show()",
    "03": "json_open           2      1      10    ",
    "04": "string              3      6      0     # name",
    "05": "json_read           4      2      0     ",
    "06": "dotjs               5      4      3     ",
    "07": "push                5      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "json_next           2      4      0     ",
    "10": "free                1      0      0     ",
    "11": "ret                 0      0      -     "
  },
  "access": []
}]
select non_exists_column from show('users');
[null]
# test: select alias.column from function()
select t.name from show('users') t;
["test"]
drop user test;
# test: select target.column.path from function()
create table test (id serial primary key);
select indexes[0].type from show('tables', true);
[2]
select t.indexes[0].type from show('tables', true) t;
[2]
drop table test;
# test: select * from (expr)
select * from (;
{"msg": "select * from (❰;❱ ⟵ bad expression"}
select * from (1;
{"msg": "select * from (1❰;❱ ⟵ ) expected"}
select * from (1);
{"msg": "select * from (1)❰;❱ ⟵ subquery must have an alias"}
# test: select * from (unsupported type)
select * from (1) t;
[1]
# test: select * from ({})
select * from ({}) t;
{"msg": "FROM: json array expected"}
# test: select * from ([])
explain select * from ([]) t;
[{
  "main": {
    "00": "set                 0      1      0     ",
    "01": "json                1      0      0     ",
    "02": "json_open           2      1      7     ",
    "03": "json_read           3      2      0     ",
    "04": "push                3      0      0     ",
    "05": "set_add             0      0      0     ",
    "06": "json_next           2      3      0     ",
    "07": "free                1      0      0     ",
    "08": "ret                 0      0      -     "
  },
  "access": []
}]
select * from ([]) t;
[]
# test: select target from ([])
select t from ([]) t;
[]
select t.t from ([]) t;
[]
select t.x from ([]) t;
[]
# test: select name from a,b (name resolve)
create table a (x int primary key);
create table b (y int primary key);
insert into a values (1);
insert into b values (2);
select x, y from a, b;
[[1, 2]]
drop table a;
drop table b;
disconnect S0;
close E0;
