open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
# test: select from table
create table test (id int primary key, data int default 0)
insert into test (id) values (1), (2), (3)
explain select * from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 8      0      0     ",
      "05": "cursor_read         1      0      0     ",
      "06": "set_add             0      1      0     ",
      "07": "cursor_next         0      5      0     ",
      "08": "cursor_close        0      0      0     ",
      "09": "result              0      0      0     ",
      "10": "ret                 0      0      0     "
    }
  }
}]
select * from test
[[1, 0], [2, 0], [3, 0]]
# test: select from table where
explain select * from test where id > 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 12     0      0     ",
      "05": "cursor_idx          1      0      0     ",
      "06": "int                 2      -      0     # 1",
      "07": "gt                  3      1      2     ",
      "08": "jntr                11     3      0     ",
      "09": "cursor_read         1      0      0     ",
      "10": "set_add             0      1      0     ",
      "11": "cursor_next         0      5      0     ",
      "12": "cursor_close        0      0      0     ",
      "13": "result              0      0      0     ",
      "14": "ret                 0      0      0     "
    }
  }
}]
select * from test where id > 1
[[2, 0], [3, 0]]
select * from test where id > 2
[[3, 0]]
select * from test where id > 3
[]
# test: select from table where point lookup
explain select * from test where id = 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_hash           0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary, lookup)",
      "04": "jmp                 12     0      0     ",
      "05": "cursor_idx          1      0      0     ",
      "06": "int                 2      -      0     # 1",
      "07": "equ                 3      1      2     ",
      "08": "jntr                4      3      0     ",
      "09": "cursor_read         1      0      0     ",
      "10": "set_add             0      1      0     ",
      "11": "jmp                 4      0      0     ",
      "12": "cursor_close        0      0      0     ",
      "13": "result              0      0      0     ",
      "14": "ret                 0      0      0     "
    }
  }
}]
select * from test where id = 1
[[1, 0]]
select * from test where id = 2
[[2, 0]]
select * from test where id = 3
[[3, 0]]
select * from test where id = 4
[]
select * from test where id = 0
[]
# test: select (select expr) from table
explain select (select test.*) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 8      0      0     ",
      "05": "cursor_read         1      0      0     ",
      "06": "set_add             0      1      0     ",
      "07": "cursor_next         0      5      0     ",
      "08": "cursor_close        0      0      0     ",
      "09": "result              0      0      0     ",
      "10": "ret                 0      0      0     "
    }
  }
}]
select (select test.*) from test
[[1, 0], [2, 0], [3, 0]]
# test: select (select (select expr)) from table
explain select (select (select (test.*))) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 8      0      0     ",
      "05": "cursor_read         1      0      0     ",
      "06": "set_add             0      1      0     ",
      "07": "cursor_next         0      5      0     ",
      "08": "cursor_close        0      0      0     ",
      "09": "result              0      0      0     ",
      "10": "ret                 0      0      0     "
    }
  }
}]
select (select (select (test.*))) from test
[[1, 0], [2, 0], [3, 0]]
# test: select (select (select from expr)) from table
explain select (select (select * from [1,2,3])) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         1      0      5     # public.test (primary)",
      "04": "jmp                 21     0      0     ",
      "05": "set                 1      0      0     ",
      "06": "int                 2      -      0     # 1",
      "07": "push                2      0      0     ",
      "08": "int                 2      -      0     # 2",
      "09": "push                2      0      0     ",
      "10": "int                 2      -      0     # 3",
      "11": "push                2      0      0     ",
      "12": "array               2      3      0     ",
      "13": "cursor_open_expr    0      2      15    ",
      "14": "jmp                 18     0      0     ",
      "15": "cursor_read         3      0      0     ",
      "16": "set_add             1      3      0     ",
      "17": "cursor_next         0      15     0     ",
      "18": "cursor_close        0      0      0     ",
      "19": "set_add             0      1      0     ",
      "20": "cursor_next         1      5      0     ",
      "21": "cursor_close        1      0      0     ",
      "22": "result              0      0      0     ",
      "23": "ret                 0      0      0     "
    }
  }
}]
select (select (select * from [1,2,3])) from test
[[1, 2, 3], [1, 2, 3], [1, 2, 3]]
# test: select (select (select from table)) from table
explain select (select (select * from test t)) from test
{"msg": "subqueries to distributed tables are not supported"}
# test: select (select (select from shared)) from table
create shared table ref (id int primary key, data int default 0)
insert into ref (id) values (1), (2), (3)
explain select (select (select * from ref)) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         1      0      5     # public.test (primary)",
      "04": "jmp                 16     0      0     ",
      "05": "set                 1      0      0     ",
      "06": "int_min             2      0      0     ",
      "07": "push                2      0      0     ",
      "08": "cursor_open         0      20     10    # public.ref (primary)",
      "09": "jmp                 13     0      0     ",
      "10": "cursor_read         2      0      0     ",
      "11": "set_add             1      2      0     ",
      "12": "cursor_next         0      10     0     ",
      "13": "cursor_close        0      0      0     ",
      "14": "set_add             0      1      0     ",
      "15": "cursor_next         1      5      0     ",
      "16": "cursor_close        1      0      0     ",
      "17": "result              0      0      0     ",
      "18": "ret                 0      0      0     "
    }
  }
}]
select (select (select * from ref)) from test
[[[1, 0], [2, 0], [3, 0]], [[1, 0], [2, 0], [3, 0]], [[1, 0], [2, 0], [3, 0]]]
# test: select from table where (select from expr)
explain select * from test where (select * from [1,2,3])
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 23     0      0     ",
      "05": "set                 1      0      0     ",
      "06": "int                 2      -      0     # 1",
      "07": "push                2      0      0     ",
      "08": "int                 2      -      0     # 2",
      "09": "push                2      0      0     ",
      "10": "int                 2      -      0     # 3",
      "11": "push                2      0      0     ",
      "12": "array               2      3      0     ",
      "13": "cursor_open_expr    1      2      15    ",
      "14": "jmp                 18     0      0     ",
      "15": "cursor_read         3      1      0     ",
      "16": "set_add             1      3      0     ",
      "17": "cursor_next         1      15     0     ",
      "18": "cursor_close        1      0      0     ",
      "19": "jntr                22     1      0     ",
      "20": "cursor_read         1      0      0     ",
      "21": "set_add             0      1      0     ",
      "22": "cursor_next         0      5      0     ",
      "23": "cursor_close        0      0      0     ",
      "24": "result              0      0      0     ",
      "25": "ret                 0      0      0     "
    }
  }
}]
select * from test where (select * from [1,2,3])
[[1, 0], [2, 0], [3, 0]]
# test: select from table where (select from table)
explain select * from test where (select * from test t)
{"msg": "subqueries to distributed tables are not supported"}
# test: select from table where (select from shared)
explain select * from test where (select * from ref)
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      0      0     ",
      "01": "int_min             1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 18     0      0     ",
      "05": "set                 1      0      0     ",
      "06": "int_min             2      0      0     ",
      "07": "push                2      0      0     ",
      "08": "cursor_open         1      20     10    # public.ref (primary)",
      "09": "jmp                 13     0      0     ",
      "10": "cursor_read         2      1      0     ",
      "11": "set_add             1      2      0     ",
      "12": "cursor_next         1      10     0     ",
      "13": "cursor_close        1      0      0     ",
      "14": "jntr                17     1      0     ",
      "15": "cursor_read         1      0      0     ",
      "16": "set_add             0      1      0     ",
      "17": "cursor_next         0      5      0     ",
      "18": "cursor_close        0      0      0     ",
      "19": "result              0      0      0     ",
      "20": "ret                 0      0      0     "
    }
  }
}]
select * from test where (select * from ref)
[[1, 0], [2, 0], [3, 0]]
drop table ref
drop table test
disconnect S0
close E0
