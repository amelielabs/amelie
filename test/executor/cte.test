#

open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485

# test: with(table), expr
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test) select * from a
explain with a as (select * from test) select * from a
drop table test

# test: with(shared), expr
create shared table test (id int primary key)
insert into test 1,2,3
with a as (select * from test) select * from a
explain with a as (select * from test) select * from a
drop table test

# test: with(table), table
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test) select * from test
explain with a as (select * from test) select * from test
drop table test

# test: with(shared), shared (pushdown)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test) select * from test
explain with a as (select * from test) select * from test
drop table test

# test: with(expr), table (pushdown)
create table test (id int primary key)
insert into test 1,2,3
explain with a as (select * from [5,6,7]) select test.*, a.* from test, a
with a as (select * from [5,6,7]) select test.*, a.* from test, a
drop table test

# test: with(expr), table (pushdown)
create table test (id int primary key)
insert into test 1,2,3
explain with a as (select * from [5,6,7]) select test.*, a.* from test, a
with a as (select * from [5,6,7]) select test.*, a.* from test, a
drop table test

# test: with(table), table (pushdown join)
create table test (id int primary key)
insert into test 1,2,3
with a (id) as (select * from test) select test.* from test join a on test.id = a.id
explain with a (id) as (select * from test) select test.* from test join a on test.id = a.id

with a (id) as (select * from test) select test.* from test join a on test.id = a.id order by test.id
explain with a (id) as (select * from test) select test.* from test join a on test.id = a.id order by test.id
drop table test

# test: with (expr), with(table), table (pushdown join)
create table test (id int primary key)
insert into test 1,2,3
with z (id) as (select [*] from [1,2,3]), a (id) as (select * from test) select test.* from test join a on test.id = a.id join z on test.id = z.id
explain with z (id) as (select [*] from [1,2,3]), a (id) as (select * from test) select test.* from test join a on test.id = a.id join z on test.id = z.id
drop table test

# test: a(table), b(a)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select * from a) select * from b
explain with a as (select * from test), b as (select * from a) select * from b
drop table test

# test: a(table), b(expr), c(a)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c
drop table test

# test: a(table), b(expr), c(table)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c
drop table test

# test: a(table), b(table), c(expr)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c
drop table test

# test: a(table), b(table), c(expr), d(table)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d
drop table test

# test: a(expr), b(table), c(expr)
create table test (id int primary key)
insert into test 1,2,3
with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c
explain with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c
drop table test

# test: a(expr), b(table), c(table)
create table test (id int primary key)
insert into test 1,2,3
with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c
explain with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c
drop table test

# test: a(table), b(a), c(table)
create table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
drop table test

create shared table test (id int primary key)
insert into test 1,2,3
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
drop table test

# test: with(insert returning), expr
create shared table test (id int primary key, data int)
with a as (insert into test values (2, 0) returning *); select * from a
explain with a as (insert into test values (2, 0) returning *); select * from a
# redefine
with a as (insert into test values (2, 0) returning * into b); select * from a
drop table test

# test: insert returning into, expr
create shared table test (id int primary key, data int)
insert into test values (2, 0) returning * into a; select * from a
explain insert into test values (2, 0) returning * into a; select * from a
drop table test

# test: with(update returning), expr
create shared table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
with a as (update test set data = data + 1 returning *) select * from a
explain with a as (update test set data = data + 1 returning *) select * from a
drop table test

# test: update returning into, expr
create shared table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
update test set data = data + 1 returning * into a; select * from a
explain update test set data = data + 1 returning * into a; select * from a
drop table test

# test: with(delete returning), expr
create shared table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
with a as (delete from test returning *) select * from a
explain with a as (delete from test returning *) select * from a
drop table test

# test: delete returning into, expr
create shared table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
delete from test returning * into a; select * from a
explain delete from test returning * into a; select * from a
drop table test

# test: a(expr), stmt, b(expr), stmt
create table test (id int primary key)
insert into test 1,2,3
with a as (select [1,2,3]); select * from a; with b as (select * from test); select b.*, a.* from b,a
drop table test

# test: into a(expr), stmt, into b(expr), stmt
create table test (id int primary key)
insert into test 1,2,3
select [1,2,3] into a; select * from a; select * into b from test; select b.*, a.* from b,a
select [1,2,3] into a; select * from a; select * into b from test; select b
drop table test

# test: a(expr), a(expr)
create table test (id int primary key)
insert into test 1,2,3
with a as (select [4,5,6]); with a as (select * from test); select * from a
explain with a as (select [4,5,6]); with a as (select * from test); select * from a
with a as (select [4,5,6]); with a as (select [1,2,3]); select * from a
drop table test

# test: into a(expr), into a(expr)
create table test (id int primary key)
insert into test 1,2,3
select [4,5,6] into a; select * into a from test; select * from a
explain select [4,5,6] into a; select * into a from test; select * from a
select [4,5,6] into a; select [1,2,3] into a; select * from a
drop table test

# test: := a(expr), := a(expr)
create table test (id int primary key)
insert into test 1,2,3
a := select [4,5,6]; a := select * from test; select * from a
explain a := select [4,5,6]; a := select * from test; select * from a
a := select [4,5,6]; a := select [1,2,3]; select * from a
drop table test

create table test (id int primary key)
insert into test 1,2,3

# test: return (expr)
1;
explain 1;

explain select 1;
select 1;

explain return select 1;
return select 1;

explain return 1;
return 1;

explain return 1; 2
return 1; 2

explain return 1; return 2
return 1; return 2

explain 1; return 2
1; return 2

explain 1; 2
1; 2

# test: return (table)
explain return select id from test;
return select id from test;

explain return select id from test; return select id from test
return select id from test; return select id from test

explain return select id from test; select id from test
return select id from test; select id from test

explain insert into test 4,5; return select id from test;
insert into test 4,5; return select id from test;

explain insert into test 6,7; insert into test 8, 9
explain insert into test 6,7; return insert into test 8, 9
insert into test 6,7; insert into test 8, 9

explain insert into test 10; return insert into test 11; insert into test 12;
insert into test 10; return insert into test 11; insert into test 12;
select * from test

explain insert into test 12; insert into test 13; insert into test 14;
explain insert into test 12; insert into test 13; return insert into test 14;
insert into test 12; insert into test 13; insert into test 14;

explain insert into test 15; return 1; insert into test 16;

explain a := 123; return a
a := 123; return a

# test: return (cte)
explain a := select * from test; return a;
a := select * from test; return a;

explain a := [1,2,3]; return a; return 48
a := [1,2,3]; return a; return 48

explain a := [1,2,3]; return a; select * from test
a := [1,2,3]; return a; select * from test

explain a := [1,2,3]; return a; select * from test; select * from test
a := [1,2,3]; return a; select * from test; select * from test

explain a := [1,2,3]; select * from test; return a;
a := [1,2,3]; select * from test; return a;

explain return a;
return a;

drop table test

disconnect S0
close E0
