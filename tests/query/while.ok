open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;
# test: while parsing
while end;
{"msg": "while ❰end❱ ⟵ bad expression"}
while 1 end;
{"msg": "while 1 ❰end❱ ⟵ DO expected"}
while do end;
{"msg": "while ❰do❱ ⟵ bad expression"}
# test: while
explain begin
	declare i int := 0;
	while i < 3 do
		i := i + 1;
	end;
	select i;
end;
[{
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "var                 0      0      0     ",
    "04": "int                 1      -      0     # 3",
    "05": "ltii                2      0      1     ",
    "06": "jntr                12     2      0     ",
    "07": "var                 0      0      0     ",
    "08": "int                 1      -      0     # 1",
    "09": "addii               2      0      1     ",
    "10": "var_set             0      0      2     ",
    "11": "jmp                 3      0      0     ",
    "12": "var                 0      0      0     ",
    "13": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	while i < 3 do
		i := i + 1;
	end;
	select i;
end;
[3]
# test: while while
explain begin
	declare i int := 0;
	declare j int := 0;
	declare n int := 0;
	while i < 3 do
		j := 0;
		while j < 3 do
			j := j + 1;
			n := n + 1;
		end;
		i := i + 1;
	end;
	select i, j, n;
end;
[{
  "main": {
    "00": "push_nulls          3      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "int                 0      -      0     # 0",
    "04": "var_set             1      0      0     ",
    "05": "int                 0      -      0     # 0",
    "06": "var_set             2      0      0     ",
    "07": "var                 0      0      0     ",
    "08": "int                 1      -      0     # 3",
    "09": "ltii                2      0      1     ",
    "10": "jntr                31     2      0     ",
    "11": "int                 0      -      0     # 0",
    "12": "var_set             1      0      0     ",
    "13": "var                 0      1      0     ",
    "14": "int                 1      -      0     # 3",
    "15": "ltii                2      0      1     ",
    "16": "jntr                26     2      0     ",
    "17": "var                 0      1      0     ",
    "18": "int                 1      -      0     # 1",
    "19": "addii               2      0      1     ",
    "20": "var_set             1      0      2     ",
    "21": "var                 0      2      0     ",
    "22": "int                 1      -      0     # 1",
    "23": "addii               2      0      1     ",
    "24": "var_set             2      0      2     ",
    "25": "jmp                 13     0      0     ",
    "26": "var                 0      0      0     ",
    "27": "int                 1      -      0     # 1",
    "28": "addii               2      0      1     ",
    "29": "var_set             0      0      2     ",
    "30": "jmp                 7      0      0     ",
    "31": "set                 0      3      0     ",
    "32": "var                 1      0      0     ",
    "33": "push                1      0      0     ",
    "34": "var                 1      1      0     ",
    "35": "push                1      0      0     ",
    "36": "var                 1      2      0     ",
    "37": "push                1      0      0     ",
    "38": "set_add             0      0      0     ",
    "39": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	declare j int := 0;
	declare n int := 0;
	while i < 3 do
		j := 0;
		while j < 3 do
			j := j + 1;
			n := n + 1;
		end;
		i := i + 1;
	end;
	select i, j, n;
end;
[[3, 3, 9]]
# test: while if
begin
	declare i int := 0;
	declare n int := 0;
	while i < 4 do
		if i % 2 = 0 then
			n := n + 1;
		end;
		i := i + 1;
	end;
	select n;
end;
[2]
# test: while var
create table test (id int primary key);
insert into test values (4);
explain begin
	declare i int := 0;
	declare x int := 0;
	declare n int := 0;
	select id into x from test;
	while i < x do
		if i % 2 = 0 then
			n := n + 1;
		end;
		i := i + 1;
	end;
	select n, x;
end;
[{
  "main": {
    "00": "push_nulls          3      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "int                 0      -      0     # 0",
    "04": "var_set             1      0      0     ",
    "05": "int                 0      -      0     # 0",
    "06": "var_set             2      0      0     ",
    "07": "send_all            0      0      20    # public.test (select, closing)",
    "08": "recv                1      0      -1    ",
    "09": "var_set             1      0      1     ",
    "10": "free                1      0      0     ",
    "11": "var                 0      0      0     ",
    "12": "var                 1      1      0     ",
    "13": "ltii                2      0      1     ",
    "14": "jntr                30     2      0     ",
    "15": "var                 0      0      0     ",
    "16": "int                 1      -      0     # 2",
    "17": "modii               2      0      1     ",
    "18": "int                 0      -      0     # 0",
    "19": "equii               1      2      0     ",
    "20": "jntr                25     1      0     ",
    "21": "var                 0      2      0     ",
    "22": "int                 1      -      0     # 1",
    "23": "addii               2      0      1     ",
    "24": "var_set             2      0      2     ",
    "25": "var                 0      0      0     ",
    "26": "int                 1      -      0     # 1",
    "27": "addii               2      0      1     ",
    "28": "var_set             0      0      2     ",
    "29": "jmp                 11     0      0     ",
    "30": "set                 0      2      0     ",
    "31": "var                 1      2      0     ",
    "32": "push                1      0      0     ",
    "33": "var                 1      1      0     ",
    "34": "push                1      0      0     ",
    "35": "set_add             0      0      0     ",
    "36": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
begin
	declare i int := 0;
	declare x int := 0;
	declare n int := 0;
	select id into x from test;
	while i < x do
		if i % 2 = 0 then
			n := n + 1;
		end;
		i := i + 1;
	end;
	select n, x;
end;
[[2, 4]]
# test: while select
while select 123 do end;
{"msg": "while ❰select❱ ⟵ unexpected subquery"}
# test: while do insert
begin
	declare i int := 0;
	declare x int := 0;
	select max(id) into x from test;
	while i < x do
		insert into test values (i);
		i := i + 1;
	end;
	select x;
end;
[4]
select * from test;
[0, 1, 2, 3, 4]
# test: while do insert returning
explain begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	while i < x do
		insert into test values (i) returning *;
		i := i + 1;
	end;
	select x;
end;
[{
  "main": {
    "00": "push_nulls          2      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "send_all            0      0      25    # public.test (select)",
    "04": "recv_aggs           1      0      21    ",
    "05": "set                 2      1      0     ",
    "06": "store_open          3      1      11    ",
    "07": "agg                 4      3      0     ",
    "08": "push                4      0      0     ",
    "09": "set_add             2      0      0     ",
    "10": "store_next          3      7      0     ",
    "11": "free                3      0      0     ",
    "12": "free                1      0      0     ",
    "13": "var_set             0      0      2     ",
    "14": "free                2      0      0     ",
    "15": "var                 0      0      0     ",
    "16": "int                 1      -      0     # 1",
    "17": "addii               2      0      1     ",
    "18": "var_set             0      0      2     ",
    "19": "var                 0      0      0     ",
    "20": "int                 1      -      0     # 10",
    "21": "addii               2      0      1     ",
    "22": "var_set             1      0      2     ",
    "23": "var                 0      0      0     ",
    "24": "var                 1      1      0     ",
    "25": "ltii                2      0      1     ",
    "26": "jntr                37     2      0     ",
    "27": "push_var            0      0      1     ",
    "28": "set_ptr             1      -      0     ",
    "29": "send_shard          0      1      1     # public.test (insert)",
    "30": "var                 1      0      0     ",
    "31": "int                 2      -      0     # 1",
    "32": "addii               3      1      2     ",
    "33": "var_set             0      0      3     ",
    "34": "recv                1      0      -1    ",
    "35": "free                1      0      0     ",
    "36": "jmp                 23     0      0     ",
    "37": "close               0      0      0     ",
    "38": "var                 0      1      0     ",
    "39": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set_ordered         0      1      1     ",
    "01": "table_open_part     1      1      9     # public.test (primary)",
    "02": "bool                2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_get             2      0      0     ",
    "05": "table_readi32       3      1      0     ",
    "06": "push                3      0      0     ",
    "07": "set_agg             0      2      21    ",
    "08": "table_next          1      2      0     ",
    "09": "free                1      0      0     ",
    "10": "bool                1      1      0     ",
    "11": "push                1      0      0     ",
    "12": "set_get             1      0      0     ",
    "13": "null                2      0      0     ",
    "14": "push                2      0      0     ",
    "15": "set_agg             0      1      21    ",
    "16": "set_sort            0      0      0     ",
    "17": "ret                 0      0      -     ",
    "18": "set                 0      1      0     ",
    "19": "table_prepare       1      -      0     # public.test",
    "20": "jmp                 27     0      0     ",
    "21": "string              2      49     0     # unique key constraint violation",
    "22": "push                2      0      0     ",
    "23": "call                2      -      1     # public.error()",
    "24": "table_readi32       2      1      0     ",
    "25": "push                2      0      0     ",
    "26": "set_add             0      0      0     ",
    "27": "upsert              1      21     24    ",
    "28": "free                1      0      0     ",
    "29": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	while i < x do
		insert into test values (i) returning *;
		i := i + 1;
	end;
	select x;
end;
[15]
select * from test;
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
# test: while do insert returning into
explain begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	declare l int := 0;

	while i < x do
		insert into test values (i) returning id into l;
		i := i + 1;
	end;
	select x, l;
end;
[{
  "main": {
    "00": "push_nulls          3      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "send_all            0      0      25    # public.test (select)",
    "04": "recv_aggs           1      0      21    ",
    "05": "set                 2      1      0     ",
    "06": "store_open          3      1      11    ",
    "07": "agg                 4      3      0     ",
    "08": "push                4      0      0     ",
    "09": "set_add             2      0      0     ",
    "10": "store_next          3      7      0     ",
    "11": "free                3      0      0     ",
    "12": "free                1      0      0     ",
    "13": "var_set             0      0      2     ",
    "14": "free                2      0      0     ",
    "15": "var                 0      0      0     ",
    "16": "int                 1      -      0     # 1",
    "17": "addii               2      0      1     ",
    "18": "var_set             0      0      2     ",
    "19": "var                 0      0      0     ",
    "20": "int                 1      -      0     # 10",
    "21": "addii               2      0      1     ",
    "22": "var_set             1      0      2     ",
    "23": "int                 0      -      0     # 0",
    "24": "var_set             2      0      0     ",
    "25": "var                 0      0      0     ",
    "26": "var                 1      1      0     ",
    "27": "ltii                2      0      1     ",
    "28": "jntr                40     2      0     ",
    "29": "push_var            0      0      1     ",
    "30": "set_ptr             1      -      0     ",
    "31": "send_shard          0      1      1     # public.test (insert)",
    "32": "var                 1      0      0     ",
    "33": "int                 2      -      0     # 1",
    "34": "addii               3      1      2     ",
    "35": "var_set             0      0      3     ",
    "36": "recv                1      0      -1    ",
    "37": "var_set             2      0      1     ",
    "38": "free                1      0      0     ",
    "39": "jmp                 25     0      0     ",
    "40": "close               0      0      0     ",
    "41": "set                 0      2      0     ",
    "42": "var                 1      1      0     ",
    "43": "push                1      0      0     ",
    "44": "var                 1      2      0     ",
    "45": "push                1      0      0     ",
    "46": "set_add             0      0      0     ",
    "47": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set_ordered         0      1      1     ",
    "01": "table_open_part     1      1      9     # public.test (primary)",
    "02": "bool                2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_get             2      0      0     ",
    "05": "table_readi32       3      1      0     ",
    "06": "push                3      0      0     ",
    "07": "set_agg             0      2      21    ",
    "08": "table_next          1      2      0     ",
    "09": "free                1      0      0     ",
    "10": "bool                1      1      0     ",
    "11": "push                1      0      0     ",
    "12": "set_get             1      0      0     ",
    "13": "null                2      0      0     ",
    "14": "push                2      0      0     ",
    "15": "set_agg             0      1      21    ",
    "16": "set_sort            0      0      0     ",
    "17": "ret                 0      0      -     ",
    "18": "set                 0      1      0     ",
    "19": "table_prepare       1      -      0     # public.test",
    "20": "jmp                 27     0      0     ",
    "21": "string              2      49     0     # unique key constraint violation",
    "22": "push                2      0      0     ",
    "23": "call                2      -      1     # public.error()",
    "24": "table_readi32       2      1      0     ",
    "25": "push                2      0      0     ",
    "26": "set_add             0      0      0     ",
    "27": "upsert              1      21     24    ",
    "28": "free                1      0      0     ",
    "29": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	declare l int := 0;

	while i < x do
		insert into test values (i) returning id into l;
		i := i + 1;
	end;
	select x, l;
end;
[[25, 24]]
select * from test;
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]
# test: while utility
while true do show all; end;
{"msg": "while true do ❰show❱ ⟵ utility statement cannot be used here"}
# test: cte while
with a as (while true do end) select 1;
{"msg": "with a as (❰while❱ ⟵ statement cannot be used inside CTE"}
with a as (select 1) while true do end;
{"msg": "with a as (select 1) ❰while❱ ⟵ statement cannot be used inside CTE"}
# test: break without loop
break;
{"msg": "❰break❱ ⟵ used out of loop"}
if true then break; end;
{"msg": "if true then ❰break❱ ⟵ used out of loop"}
# test: while break
begin
	while true do
		break;
	end;
	select 123;
end;
[123]
# test: while if break
explain begin
	declare i int := 0;
	while true do
		if i = 10 then
			break;
		end;
		i := i + 1;
	end;
	select i;
end;
[{
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "bool                0      1      0     ",
    "04": "jntr                15     0      0     ",
    "05": "var                 0      0      0     ",
    "06": "int                 1      -      0     # 10",
    "07": "equii               2      0      1     ",
    "08": "jntr                10     2      0     ",
    "09": "jmp                 15     0      0     ",
    "10": "var                 0      0      0     ",
    "11": "int                 1      -      0     # 1",
    "12": "addii               2      0      1     ",
    "13": "var_set             0      0      2     ",
    "14": "jmp                 3      0      0     ",
    "15": "var                 0      0      0     ",
    "16": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	while true do
		if i = 10 then
			break;
		end;
		i := i + 1;
	end;
	select i;
end;
[10]
# test: while while break
explain begin
	declare i int := 0;
	while true do
		while true do
			break;
			i := i + 1;
		end;
		break;
		i := i + 1;
	end;
	select i;
end;
[{
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "bool                0      1      0     ",
    "04": "jntr                19     0      0     ",
    "05": "bool                0      1      0     ",
    "06": "jntr                13     0      0     ",
    "07": "jmp                 13     0      0     ",
    "08": "var                 0      0      0     ",
    "09": "int                 1      -      0     # 1",
    "10": "addii               2      0      1     ",
    "11": "var_set             0      0      2     ",
    "12": "jmp                 5      0      0     ",
    "13": "jmp                 19     0      0     ",
    "14": "var                 0      0      0     ",
    "15": "int                 1      -      0     # 1",
    "16": "addii               2      0      1     ",
    "17": "var_set             0      0      2     ",
    "18": "jmp                 3      0      0     ",
    "19": "var                 0      0      0     ",
    "20": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	while true do
		while true do
			break;
			i := i + 1;
		end;
		break;
		i := i + 1;
	end;
	select i;
end;
[0]
# test: continue without loop
continue;
{"msg": "❰continue❱ ⟵ used out of loop"}
if true then continue; end;
{"msg": "if true then ❰continue❱ ⟵ used out of loop"}
# test: while if continue
explain begin
	declare i int := 0;
	while true do
		if i < 10 then
			i := i + 1;
			continue;
		end;
		break;
	end;
	select i;
end;
[{
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "bool                0      1      0     ",
    "04": "jntr                16     0      0     ",
    "05": "var                 0      0      0     ",
    "06": "int                 1      -      0     # 10",
    "07": "ltii                2      0      1     ",
    "08": "jntr                14     2      0     ",
    "09": "var                 0      0      0     ",
    "10": "int                 1      -      0     # 1",
    "11": "addii               2      0      1     ",
    "12": "var_set             0      0      2     ",
    "13": "jmp                 3      0      0     ",
    "14": "jmp                 16     0      0     ",
    "15": "jmp                 3      0      0     ",
    "16": "var                 0      0      0     ",
    "17": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	while true do
		if i < 10 then
			i := i + 1;
			continue;
		end;
		break;
	end;
	select i;
end;
[10]
# test: while while continue
explain begin
	declare i int := 0;
	declare j int := 0;
	while i < 10 do
		while true do
			if j < 10 then
				j := j + 1;
				continue;
			end;
		end;
		i := i + 1;
	end;
	select i, j;
end;
[{
  "main": {
    "00": "push_nulls          2      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "int                 0      -      0     # 0",
    "04": "var_set             1      0      0     ",
    "05": "var                 0      0      0     ",
    "06": "int                 1      -      0     # 10",
    "07": "ltii                2      0      1     ",
    "08": "jntr                26     2      0     ",
    "09": "bool                0      1      0     ",
    "10": "jntr                21     0      0     ",
    "11": "var                 0      1      0     ",
    "12": "int                 1      -      0     # 10",
    "13": "ltii                2      0      1     ",
    "14": "jntr                20     2      0     ",
    "15": "var                 0      1      0     ",
    "16": "int                 1      -      0     # 1",
    "17": "addii               2      0      1     ",
    "18": "var_set             1      0      2     ",
    "19": "jmp                 9      0      0     ",
    "20": "jmp                 9      0      0     ",
    "21": "var                 0      0      0     ",
    "22": "int                 1      -      0     # 1",
    "23": "addii               2      0      1     ",
    "24": "var_set             0      0      2     ",
    "25": "jmp                 5      0      0     ",
    "26": "set                 0      2      0     ",
    "27": "var                 1      0      0     ",
    "28": "push                1      0      0     ",
    "29": "var                 1      1      0     ",
    "30": "push                1      0      0     ",
    "31": "set_add             0      0      0     ",
    "32": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	declare j int := 0;
	while i < 10 do
		while true do
			if j < 10 then
				j := j + 1;
				continue;
			end;
			break;
		end;
		j := 0;
		i := i + 1;
	end;
	select i, j;
end;
[[10, 0]]
disconnect S0;
close E0;
