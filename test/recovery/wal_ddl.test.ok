open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
# test: create table
create table test (id int serial primary key, data int default 0)
show lsn
[2]
select serial("public", "test")
[0]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[2]
select serial("public", "test")
[0]
# test: alter table rename
alter table test rename to test2
show lsn
[3]
select serial("public", "test")
{"msg": "table 'test': not exists"}
select serial("public", "test2")
[0]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[3]
select serial("public", "test")
{"msg": "table 'test': not exists"}
select serial("public", "test2")
[0]
# test: alter table column add
insert into test2() values (), (), ()
select * from test2
[[0, 0], [1, 0], [2, 0]]
show lsn
[4]
select serial("public", "test2")
[3]
alter table test2 add column obj json
select * from test2
[[0, 0, null], [1, 0, null], [2, 0, null]]
select obj from test2
[null, null, null]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[5]
select serial("public", "test2")
[0]
select * from test2
[[0, 0, null], [1, 0, null], [2, 0, null]]
# test: alter table column rename
alter table test2 rename column data to abc
select * from test2
[[0, 0, null], [1, 0, null], [2, 0, null]]
select data from test2
{"msg": "<test2.data> column not found"}
select abc from test2
[0, 0, 0]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[6]
select serial("public", "test2")
[0]
select data from test2
{"msg": "<test2.data> column not found"}
select abc from test2
[0, 0, 0]
# test: alter table set default
alter table test2 set column abc default 123
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": 123
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[7]
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": 123
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: alter table unset default
alter table test2 unset column abc default
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[8]
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: alter table set stored
alter table test2 set column abc as (1 + 1) stored
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "1 + 1",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[9]
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "1 + 1",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: alter table unset stored
alter table test2 unset column abc stored
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[10]
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: alter table set resolved
alter table test2 set column abc as (1 + 1) resolved
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "1 + 1",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[11]
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "1 + 1",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: alter table unset resolved
alter table test2 unset column abc resolved
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[12]
select system.table('test2').columns
[[{
  "name": "id",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": true,
    "serial": true,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "abc",
  "type": 2,
  "type_size": 4,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}, {
  "name": "obj",
  "type": 5,
  "type_size": 0,
  "constraints": {
    "not_null": false,
    "serial": false,
    "random": false,
    "random_modulo": 9223372036854775807,
    "as_stored": "",
    "as_resolved": "",
    "default": null
  }
}]]
# test: alter table column drop
alter table test2 drop column abc
select abc from test2
{"msg": "<test2.abc> column not found"}
select * from test2
[[0, null], [1, null], [2, null]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[13]
select serial("public", "test2")
[0]
select * from test2
[[0, null], [1, null], [2, null]]
# test: create index
create index i on test2 (id)
select * from test2 use index (i)
[[0, null], [1, null], [2, null]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[14]
select serial("public", "test2")
[0]
select * from test2 use index (i)
[[0, null], [1, null], [2, null]]
# test: alter index rename
alter index i on test2 rename to i2
show lsn
[15]
select * from test2 use index (i2)
[[0, null], [1, null], [2, null]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[15]
select serial("public", "test2")
[0]
select * from test2 use index (i2)
[[0, null], [1, null], [2, null]]
# test: drop index
drop index i2 on test2
select * from test2 use index (i)
{"msg": "index 'i': not exists"}
select * from test2 use index (i2)
{"msg": "index 'i2': not exists"}
select * from test2
[[0, null], [1, null], [2, null]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[16]
select serial("public", "test2")
[0]
select * from test2 use index (i)
{"msg": "index 'i': not exists"}
select * from test2 use index (i2)
{"msg": "index 'i2': not exists"}
select * from test2
[[0, null], [1, null], [2, null]]
# test: truncate
truncate test2
select * from test2
[]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[17]
select serial("public", "test2")
[0]
select * from test2
[]
# test: drop table
drop table test2
show lsn
[18]
select serial("public", "test2")
{"msg": "table 'test2': not exists"}
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[18]
select * from test2
{"msg": "<public.test2> relation not found"}
show tables
[[]]
# test: create schema
create schema test
show schemas
[[{
  "name": "system",
  "system": true
}, {
  "name": "public",
  "system": true
}, {
  "name": "test",
  "system": false
}]]
show lsn
[19]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[19]
show schemas
[[{
  "name": "system",
  "system": true
}, {
  "name": "public",
  "system": true
}, {
  "name": "test",
  "system": false
}]]
# test: alter schema rename
alter schema test rename to test2
show schemas
[[{
  "name": "system",
  "system": true
}, {
  "name": "public",
  "system": true
}, {
  "name": "test2",
  "system": false
}]]
show lsn
[20]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[20]
show schemas
[[{
  "name": "system",
  "system": true
}, {
  "name": "public",
  "system": true
}, {
  "name": "test2",
  "system": false
}]]
# test: drop schema
drop schema test2
show lsn
[21]
show schemas
[[{
  "name": "system",
  "system": true
}, {
  "name": "public",
  "system": true
}]]
# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485
# test: validate state
show lsn
[21]
show schemas
[[{
  "name": "system",
  "system": true
}, {
  "name": "public",
  "system": true
}]]
disconnect S0
close E0
