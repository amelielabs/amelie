open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3;
connect E0 S0 127.0.0.1:3485;
# test: cte parsing
with;
{"msg": "with❰;❱ ⟵ name expected"}
with 1;
{"msg": "with ❰1❱ ⟵ name expected"}
with test;
{"msg": "with test❰;❱ ⟵ AS expected"}
with test 1;
{"msg": "with test ❰1❱ ⟵ AS expected"}
with test as;
{"msg": "with test as❰;❱ ⟵ ( expected"}
with test as 1;
{"msg": "with test as ❰1❱ ⟵ ( expected"}
with test (;
{"msg": "with test (❰;❱ ⟵ name expected"}
with test (1;
{"msg": "with test (❰1❱ ⟵ name expected"}
with test (name;
{"msg": "with test (name❰;❱ ⟵ ) expected"}
with test (name,;
{"msg": "with test (name,❰;❱ ⟵ name expected"}
with test (name,,;
{"msg": "with test (name,❰,❱ ⟵ name expected"}
with test (name,);
{"msg": "with test (name,❰)❱ ⟵ name expected"}
with test (name,;
{"msg": "with test (name,❰;❱ ⟵ name expected"}
with test (name);
{"msg": "with test (name)❰;❱ ⟵ AS expected"}
with test as (;
{"msg": "with test as (❰;❱ ⟵ unexpected statement"}
# test: with () (no stmt)
with test as ();
{"msg": "with test as (❰)❱ ⟵ unexpected statement"}
# test: with(select expr) (no main stmt)
with test as (select 1);
{"msg": "with test as (select 1)❰;❱ ⟵ unexpected statement"}
# test: with(select expr), select expr (cte not used)
with test as (select 1) select 2;
[2]
# test: with(select expr), select * from cte
with a as (select 1) select * from a;
[1]
with a as (select 1, 2) select * from a;
[[1, 2]]
with a as (select 1, 2, 3) select * from a;
[[1, 2, 3]]
# test: with(select expr as), select * from cte
with a as (select 1 as a) select * from a;
[1]
with a as (select 1 as a, 2 as b) select * from a;
[[1, 2]]
# test: with(select expr as), select column from cte
with a as (select 1 as a) select a from a;
[1]
with a as (select 1 as a, 2 as b) select a, b from a;
[[1, 2]]
# test: with(select expr as), select target.column from cte
with a as (select 1 as a, 2 as b) select a.a, a.b from a;
[[1, 2]]
# test: with(select * from table) select expr (cte not used)
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select * from test) select 2;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "int                 1      -      0     # 2",
    "02": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select 2;
[2]
drop table test;
# test: with(select * from table), select * from cte
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select * from test) select * from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select * from a;
[1, 3, 2]
drop table test;
# test: with(select * from table), select column from cte
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select * from test) select id from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select id from a;
[1, 3, 2]
drop table test;
# test: with(select * from table), select target.column from cte
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select * from test) select a.id from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select a.id from a;
[1, 3, 2]
drop table test;
# test: with(select column from table), select column from cte
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select id from test) select id from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select id from test) select id from a;
[1, 3, 2]
drop table test;
# test: with(select column as from table), select column from cte
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select id as x from test) select id from a;
{"msg": "explain with a as (select id as x from test) select ❰id❱ ⟵ column a.id not found"}
explain with a as (select id as x from test) select x from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select id as x from test) select x from a;
[1, 3, 2]
drop table test;
# test: with(select column, column from table), select * from cte (conflict)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select id, id from test) select * from a;
{"msg": "with a as (select id, id from test) select ❰*❱ ⟵ column a.id is ambiguous"}
with a as (select id, id as x from test) select * from a;
[[1, 1], [3, 3], [2, 2]]
drop table test;
# test: with(select * from table), select * from cte
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test) select * from a;
[1, 3, 2]
explain with a as (select * from test) select * from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: with(select * from table), select * from table
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test) select * from test;
[1, 3, 2]
explain with a as (select * from test) select * from test;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "send_all            1      0      56    # public.test (last)",
    "02": "recv                2      1      0     ",
    "03": "union_set           2      0      -1    ",
    "04": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 1      1      0     ",
    "09": "table_open_part     2      36     14    # public.test (primary)",
    "10": "table_readi32       3      2      0     ",
    "11": "push                3      0      0     ",
    "12": "set_add             1      0      0     ",
    "13": "table_next          2      10     0     ",
    "14": "free                2      0      0     ",
    "15": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: with(select * from table), select * from table
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test) select * from test;
[1, 3, 2]
explain with a as (select * from test) select * from test;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "send_all            1      0      56    # public.test (last)",
    "02": "recv                2      1      0     ",
    "03": "union_set           2      0      -1    ",
    "04": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 1      1      0     ",
    "09": "table_open_part     2      36     14    # public.test (primary)",
    "10": "table_readi32       3      2      0     ",
    "11": "push                3      0      0     ",
    "12": "set_add             1      0      0     ",
    "13": "table_next          2      10     0     ",
    "14": "free                2      0      0     ",
    "15": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: with(select expr), select * from table join
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select [4,5,6]) select test.*, a.* from test, a;
[{
  "main": {
    "00": "json                0      0      0     ",
    "01": "push_ref            0      1      0     ",
    "02": "send_all            1      1      25    # public.test (last)",
    "03": "recv                2      1      0     ",
    "04": "union_set           2      0      -1    ",
    "05": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 1      2      0     ",
    "01": "table_open_part     2      5      13    # public.test (primary)",
    "02": "ref                 3      0      0     ",
    "03": "json_open           4      3      10    ",
    "04": "table_readi32       5      2      0     ",
    "05": "push                5      0      0     ",
    "06": "json_read           5      4      0     ",
    "07": "push                5      0      0     ",
    "08": "set_add             1      0      0     ",
    "09": "json_next           4      4      0     ",
    "10": "free                4      0      0     ",
    "11": "free                3      0      0     ",
    "12": "table_next          2      2      0     ",
    "13": "free                2      0      0     ",
    "14": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select [4,5,6]) select test.*, a.* from test, a;
[[1, 4], [1, 5], [1, 6], [3, 4], [3, 5], [3, 6], [2, 4], [2, 5], [2, 6]]
drop table test;
# test: with(select expr), select * from table join
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select [4,5,6]) select test.*, a.* from test, a;
[{
  "main": {
    "00": "json                0      0      0     ",
    "01": "push_ref            0      1      0     ",
    "02": "send_all            1      1      25    # public.test (last)",
    "03": "recv                2      1      0     ",
    "04": "union_set           2      0      -1    ",
    "05": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 1      2      0     ",
    "01": "table_open_part     2      5      13    # public.test (primary)",
    "02": "ref                 3      0      0     ",
    "03": "json_open           4      3      10    ",
    "04": "table_readi32       5      2      0     ",
    "05": "push                5      0      0     ",
    "06": "json_read           5      4      0     ",
    "07": "push                5      0      0     ",
    "08": "set_add             1      0      0     ",
    "09": "json_next           4      4      0     ",
    "10": "free                4      0      0     ",
    "11": "free                3      0      0     ",
    "12": "table_next          2      2      0     ",
    "13": "free                2      0      0     ",
    "14": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select [4,5,6]) select test.*, a.* from test, a;
[[1, 4], [1, 5], [1, 6], [3, 4], [3, 5], [3, 6], [2, 4], [2, 5], [2, 6]]
drop table test;
# test: with(select * from table), select from table join
create table test (id int primary key);
insert into test values (1),(2),(3);
explain with a as (select * from test) select test.* from test join a on test.id = a.id;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "push_ref            1      1      0     ",
    "04": "send_all            0      1      56    # public.test (last)",
    "05": "recv                2      0      0     ",
    "06": "union_set           2      0      -1    ",
    "07": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 0      1      0     ",
    "09": "table_open_part     2      36     23    # public.test (primary)",
    "10": "ref                 3      0      0     ",
    "11": "store_open          4      3      20    ",
    "12": "table_readi32       5      2      0     ",
    "13": "store_read          6      4      0     ",
    "14": "equii               7      5      6     ",
    "15": "jntr                19     7      0     ",
    "16": "table_readi32       5      2      0     ",
    "17": "push                5      0      0     ",
    "18": "set_add             0      0      0     ",
    "19": "store_next          4      12     0     ",
    "20": "free                4      0      0     ",
    "21": "free                3      0      0     ",
    "22": "table_next          2      10     0     ",
    "23": "free                2      0      0     ",
    "24": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select test.* from test join a on test.id = a.id;
[1, 3, 2]
drop table test;
# test: with(select string from table), select from table join
create table test (id int primary key, data string);
insert into test values (1, '1'),(2, '2'),(3, '3');
explain with a as (select data from test) select test.* from test join a on test.data = a.data;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "push_ref            1      1      0     ",
    "04": "send_all            0      1      56    # public.test (last)",
    "05": "recv                2      0      0     ",
    "06": "union_set           2      0      -1    ",
    "07": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_reads         2      1      1     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 0      2      0     ",
    "09": "table_open_part     2      36     25    # public.test (primary)",
    "10": "ref                 3      0      0     ",
    "11": "store_open          4      3      22    ",
    "12": "table_reads         5      2      1     ",
    "13": "store_read          6      4      0     ",
    "14": "equss               7      5      6     ",
    "15": "jntr                21     7      0     ",
    "16": "table_readi32       5      2      0     ",
    "17": "push                5      0      0     ",
    "18": "table_reads         5      2      1     ",
    "19": "push                5      0      0     ",
    "20": "set_add             0      0      0     ",
    "21": "store_next          4      12     0     ",
    "22": "free                4      0      0     ",
    "23": "free                3      0      0     ",
    "24": "table_next          2      10     0     ",
    "25": "free                2      0      0     ",
    "26": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
with a as (select data from test) select test.* from test join a on test.data = a.data;
[[1, "1"], [3, "3"], [2, "2"]]
drop table test;
# test: with (columns) as (select expr), select * from cte
explain with z (a,b,c) as (select 4,5,6) select * from z;
[{
  "main": {
    "00": "set                 0      3      0     ",
    "01": "int                 1      -      0     # 4",
    "02": "push                1      0      0     ",
    "03": "int                 1      -      0     # 5",
    "04": "push                1      0      0     ",
    "05": "int                 1      -      0     # 6",
    "06": "push                1      0      0     ",
    "07": "set_add             0      0      0     ",
    "08": "set                 1      3      0     ",
    "09": "dup                 2      0      0     ",
    "10": "store_open          3      2      19    ",
    "11": "store_read          4      3      0     ",
    "12": "push                4      0      0     ",
    "13": "store_read          4      3      1     ",
    "14": "push                4      0      0     ",
    "15": "store_read          4      3      2     ",
    "16": "push                4      0      0     ",
    "17": "set_add             1      0      0     ",
    "18": "store_next          3      11     0     ",
    "19": "free                3      0      0     ",
    "20": "free                2      0      0     ",
    "21": "ret                 1      0      -     "
  },
  "access": []
}]
with z (a,b,c) as (select 4,5,6) select * from z;
[[4, 5, 6]]
# test: with (columns) as (select expr), select column from cte
with z (a,b,c) as (select 4,5,6) select a,b,c from z;
[[4, 5, 6]]
# test: with (columns) as (select expr), select target.column from cte
with z (a,b,c) as (select 4,5,6) select z.a, z.b, z.c from z;
[[4, 5, 6]]
# test: with (columns) as (select expr), select column from cte group by
with z as (select 4 as a,5,6) select a from z group by a;
[4]
with z (a,b,c) as (select 4,5,6) select a from z group by a;
[4]
# test: with (columns) as (select expr), select * from cte (redefined)
explain with z (a,a) as (select 4,5,6) select * from z;
{"msg": "explain with z (a,❰a❱ ⟵ argument redefined"}
# test: a(table), b(a)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select * from a) select * from b;
[1, 3, 2]
explain with a as (select * from test), b as (select * from a) select * from b;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "set                 2      1      0     ",
    "13": "dup                 3      0      0     ",
    "14": "store_open          4      3      19    ",
    "15": "store_read          5      4      0     ",
    "16": "push                5      0      0     ",
    "17": "set_add             2      0      0     ",
    "18": "store_next          4      15     0     ",
    "19": "free                4      0      0     ",
    "20": "free                3      0      0     ",
    "21": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(table), b(expr), c(a)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c;
[1, 3, 2]
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "json                1      36     0     ",
    "02": "recv                2      0      0     ",
    "03": "union_set           2      0      -1    ",
    "04": "set                 0      1      0     ",
    "05": "dup                 3      2      0     ",
    "06": "store_open          4      3      11    ",
    "07": "store_read          5      4      0     ",
    "08": "push                5      0      0     ",
    "09": "set_add             0      0      0     ",
    "10": "store_next          4      7      0     ",
    "11": "free                4      0      0     ",
    "12": "free                3      0      0     ",
    "13": "set                 3      1      0     ",
    "14": "dup                 4      0      0     ",
    "15": "store_open          5      4      20    ",
    "16": "store_read          6      5      0     ",
    "17": "push                6      0      0     ",
    "18": "set_add             3      0      0     ",
    "19": "store_next          5      16     0     ",
    "20": "free                5      0      0     ",
    "21": "free                4      0      0     ",
    "22": "ret                 3      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(table), b(expr), c(table)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c;
[1, 3, 2]
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "json                1      36     0     ",
    "02": "send_all            2      0      61    # public.test (last)",
    "03": "recv                3      2      0     ",
    "04": "union_set           3      0      -1    ",
    "05": "set                 2      1      0     ",
    "06": "dup                 4      3      0     ",
    "07": "store_open          5      4      12    ",
    "08": "store_read          6      5      0     ",
    "09": "push                6      0      0     ",
    "10": "set_add             2      0      0     ",
    "11": "store_next          5      8      0     ",
    "12": "free                5      0      0     ",
    "13": "free                4      0      0     ",
    "14": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 2      1      0     ",
    "09": "table_open_part     3      41     14    # public.test (primary)",
    "10": "table_readi32       4      3      0     ",
    "11": "push                4      0      0     ",
    "12": "set_add             2      0      0     ",
    "13": "table_next          3      10     0     ",
    "14": "free                3      0      0     ",
    "15": "ret                 2      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(table), b(table), c(expr)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c;
[1, 2, 3]
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "send_all            1      0      56    # public.test (last)",
    "02": "json                2      72     0     ",
    "03": "set                 3      1      0     ",
    "04": "dup                 4      2      0     ",
    "05": "json_open           5      4      10    ",
    "06": "json_read           6      5      0     ",
    "07": "push                6      0      0     ",
    "08": "set_add             3      0      0     ",
    "09": "json_next           5      6      0     ",
    "10": "free                5      0      0     ",
    "11": "free                4      0      0     ",
    "12": "ret                 3      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 1      1      0     ",
    "09": "table_open_part     2      36     14    # public.test (primary)",
    "10": "table_readi32       3      2      0     ",
    "11": "push                3      0      0     ",
    "12": "set_add             1      0      0     ",
    "13": "table_next          2      10     0     ",
    "14": "free                2      0      0     ",
    "15": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(table), b(table), c(expr), d(table)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d;
[1, 3, 2]
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "send_all            1      0      56    # public.test",
    "02": "json                2      72     0     ",
    "03": "send_all            3      0      97    # public.test (last)",
    "04": "recv                4      3      0     ",
    "05": "union_set           4      0      -1    ",
    "06": "set                 3      1      0     ",
    "07": "dup                 5      4      0     ",
    "08": "store_open          6      5      13    ",
    "09": "store_read          7      6      0     ",
    "10": "push                7      0      0     ",
    "11": "set_add             3      0      0     ",
    "12": "store_next          6      9      0     ",
    "13": "free                6      0      0     ",
    "14": "free                5      0      0     ",
    "15": "ret                 3      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 1      1      0     ",
    "09": "table_open_part     2      36     14    # public.test (primary)",
    "10": "table_readi32       3      2      0     ",
    "11": "push                3      0      0     ",
    "12": "set_add             1      0      0     ",
    "13": "table_next          2      10     0     ",
    "14": "free                2      0      0     ",
    "15": "ret                 1      0      -     ",
    "16": "set                 3      1      0     ",
    "17": "table_open_part     4      77     22    # public.test (primary)",
    "18": "table_readi32       5      4      0     ",
    "19": "push                5      0      0     ",
    "20": "set_add             3      0      0     ",
    "21": "table_next          4      18     0     ",
    "22": "free                4      0      0     ",
    "23": "ret                 3      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(expr), b(table), c(expr)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c;
[[1, 1], [1, 2], [1, 3], [3, 1], [3, 2], [3, 3], [2, 1], [2, 2], [2, 3]]
explain with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c;
[{
  "main": {
    "00": "json                0      0      0     ",
    "01": "send_all            1      0      25    # public.test (last)",
    "02": "json                2      41     0     ",
    "03": "recv                3      1      0     ",
    "04": "union_set           3      0      -1    ",
    "05": "set                 1      2      0     ",
    "06": "dup                 4      3      0     ",
    "07": "store_open          5      4      19    ",
    "08": "dup                 6      2      0     ",
    "09": "json_open           7      6      16    ",
    "10": "store_read          8      5      0     ",
    "11": "push                8      0      0     ",
    "12": "json_read           8      7      0     ",
    "13": "push                8      0      0     ",
    "14": "set_add             1      0      0     ",
    "15": "json_next           7      10     0     ",
    "16": "free                7      0      0     ",
    "17": "free                6      0      0     ",
    "18": "store_next          5      8      0     ",
    "19": "free                5      0      0     ",
    "20": "free                4      0      0     ",
    "21": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 1      1      0     ",
    "01": "table_open_part     2      5      6     # public.test (primary)",
    "02": "table_readi32       3      2      0     ",
    "03": "push                3      0      0     ",
    "04": "set_add             1      0      0     ",
    "05": "table_next          2      2      0     ",
    "06": "free                2      0      0     ",
    "07": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(expr), b(table), c(table)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c;
[1, 3, 2]
explain with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c;
[{
  "main": {
    "00": "json                0      0      0     ",
    "01": "send_all            1      0      25    # public.test",
    "02": "send_all            2      0      61    # public.test (last)",
    "03": "recv                3      2      0     ",
    "04": "union_set           3      0      -1    ",
    "05": "set                 2      1      0     ",
    "06": "dup                 4      3      0     ",
    "07": "store_open          5      4      12    ",
    "08": "store_read          6      5      0     ",
    "09": "push                6      0      0     ",
    "10": "set_add             2      0      0     ",
    "11": "store_next          5      8      0     ",
    "12": "free                5      0      0     ",
    "13": "free                4      0      0     ",
    "14": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 1      1      0     ",
    "01": "table_open_part     2      5      6     # public.test (primary)",
    "02": "table_readi32       3      2      0     ",
    "03": "push                3      0      0     ",
    "04": "set_add             1      0      0     ",
    "05": "table_next          2      2      0     ",
    "06": "free                2      0      0     ",
    "07": "ret                 1      0      -     ",
    "08": "set                 2      1      0     ",
    "09": "table_open_part     3      41     14    # public.test (primary)",
    "10": "table_readi32       4      3      0     ",
    "11": "push                4      0      0     ",
    "12": "set_add             2      0      0     ",
    "13": "table_next          3      10     0     ",
    "14": "free                3      0      0     ",
    "15": "ret                 2      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(table), b(a), c(table)
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c;
[1, 3, 2]
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "send_all            2      0      56    # public.test (last)",
    "13": "recv                3      2      0     ",
    "14": "union_set           3      0      -1    ",
    "15": "set                 2      1      0     ",
    "16": "dup                 4      3      0     ",
    "17": "store_open          5      4      22    ",
    "18": "store_read          6      5      0     ",
    "19": "push                6      0      0     ",
    "20": "set_add             2      0      0     ",
    "21": "store_next          5      18     0     ",
    "22": "free                5      0      0     ",
    "23": "free                4      0      0     ",
    "24": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 2      1      0     ",
    "09": "table_open_part     3      36     14    # public.test (primary)",
    "10": "table_readi32       4      3      0     ",
    "11": "push                4      0      0     ",
    "12": "set_add             2      0      0     ",
    "13": "table_next          3      10     0     ",
    "14": "free                3      0      0     ",
    "15": "ret                 2      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
create table test (id int primary key);
insert into test values (1),(2),(3);
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c;
[1, 3, 2]
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test",
    "01": "recv                1      0      0     ",
    "02": "union_set           1      0      -1    ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "send_all            2      0      56    # public.test (last)",
    "13": "recv                3      2      0     ",
    "14": "union_set           3      0      -1    ",
    "15": "set                 2      1      0     ",
    "16": "dup                 4      3      0     ",
    "17": "store_open          5      4      22    ",
    "18": "store_read          6      5      0     ",
    "19": "push                6      0      0     ",
    "20": "set_add             2      0      0     ",
    "21": "store_next          5      18     0     ",
    "22": "free                5      0      0     ",
    "23": "free                4      0      0     ",
    "24": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     ",
    "08": "set                 2      1      0     ",
    "09": "table_open_part     3      36     14    # public.test (primary)",
    "10": "table_readi32       4      3      0     ",
    "11": "push                4      0      0     ",
    "12": "set_add             2      0      0     ",
    "13": "table_next          3      10     0     ",
    "14": "free                3      0      0     ",
    "15": "ret                 2      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
drop table test;
# test: a(expr), stmt, b(expr), stmt
create table test (id int primary key);
insert into test values (1),(2),(3);
begin with a as (select [1,2,3]) select * from a; with b as (select * from test) select b.*, a.* from b,a; end;
[[1, 1], [1, 2], [1, 3], [3, 1], [3, 2], [3, 3], [2, 1], [2, 2], [2, 3]]
drop table test;
# test: a(expr), a(expr) (cte redefined)
create table test (id int primary key);
insert into test values (1),(2),(3);
begin with a as (select [4,5,6]); with a as (select * from test); select * from a; end;
{"msg": "begin with a as (select [4,5,6])❰;❱ ⟵ unexpected statement"}
drop table test;
# test: with(insert returning), select * from cte
create table test (id int primary key, data int);
begin with a as (insert into test values (2, 0) returning *) select * from a; end;
[[2, 0]]
explain begin with a as (insert into test values (2, 0) returning *) select * from a; end;
[{
  "main": {
    "00": "set_ptr             1      -      0     ",
    "01": "send_shard          0      1      0     # public.test (last)",
    "02": "recv                1      0      0     ",
    "03": "set                 0      2      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      12    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "store_read          4      3      1     ",
    "09": "push                4      0      0     ",
    "10": "set_add             0      0      0     ",
    "11": "store_next          3      6      0     ",
    "12": "free                3      0      0     ",
    "13": "free                2      0      0     ",
    "14": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_prepare       1      -      0     # public.test",
    "02": "jmp                 11     0      0     ",
    "03": "string              2      0      0     # unique key constraint violation",
    "04": "push                2      0      0     ",
    "05": "call                2      -      1     # public.error()",
    "06": "table_readi32       2      1      0     ",
    "07": "push                2      0      0     ",
    "08": "table_readi32       2      1      1     ",
    "09": "push                2      0      0     ",
    "10": "set_add             0      0      0     ",
    "11": "upsert              1      3      6     ",
    "12": "free                1      0      0     ",
    "13": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
drop table test;
# test: with(update returning), select * from cte
create table test (id int primary key, data int);
insert into test values (0, 0);
insert into test values (1, 0);
insert into test values (2, 0);
with a as (update test set data = data + 1 returning *) select * from a;
[[0, 1], [1, 1], [2, 1]]
explain with a as (update test set data = data + 1 returning *) select * from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "set                 0      2      0     ",
    "03": "dup                 2      1      0     ",
    "04": "store_open          3      2      11    ",
    "05": "store_read          4      3      0     ",
    "06": "push                4      0      0     ",
    "07": "store_read          4      3      1     ",
    "08": "push                4      0      0     ",
    "09": "set_add             0      0      0     ",
    "10": "store_next          3      5      0     ",
    "11": "free                3      0      0     ",
    "12": "free                2      0      0     ",
    "13": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      15    # public.test (primary)",
    "02": "int                 2      -      0     # 1",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "int                 3      -      0     # 1",
    "06": "addii               4      2      3     ",
    "07": "push                4      0      0     ",
    "08": "update              1      1      0     ",
    "09": "table_readi32       2      1      0     ",
    "10": "push                2      0      0     ",
    "11": "table_readi32       2      1      1     ",
    "12": "push                2      0      0     ",
    "13": "set_add             0      0      0     ",
    "14": "table_next          1      2      0     ",
    "15": "free                1      0      0     ",
    "16": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
drop table test;
# test: with(delete returning), select * from cte
create table test (id int primary key, data int);
insert into test values (0, 0);
insert into test values (1, 0);
insert into test values (2, 0);
with a as (delete from test returning *) select * from a;
[[0, 0], [1, 0], [2, 0]]
explain with a as (delete from test returning *) select * from a;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (last)",
    "01": "recv                1      0      0     ",
    "02": "set                 0      2      0     ",
    "03": "dup                 2      1      0     ",
    "04": "store_open          3      2      11    ",
    "05": "store_read          4      3      0     ",
    "06": "push                4      0      0     ",
    "07": "store_read          4      3      1     ",
    "08": "push                4      0      0     ",
    "09": "set_add             0      0      0     ",
    "10": "store_next          3      5      0     ",
    "11": "free                3      0      0     ",
    "12": "free                2      0      0     ",
    "13": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      9     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "delete              1      0      0     ",
    "08": "table_next          1      2      0     ",
    "09": "free                1      0      0     ",
    "10": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
drop table test;
disconnect S0;
close E0;
