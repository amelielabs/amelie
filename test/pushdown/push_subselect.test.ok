env_open E0 "cluster_shards": 3
connect E0 S0
connect: on_connect
create table test (id int primary key, data int default 0)
insert into test (id) values (1), (2), (3)
# test: select (select from table)
explain select (select * from test)
query: on_error
{"code": 1, "msg": "undefined distributed table"}
select (select * from test)
query: on_error
{"code": 1, "msg": "undefined distributed table"}
# test: select (select from table) from expr
explain select (select * from test) from [1,2,3]
query: on_error
{"code": 1, "msg": "FROM: undefined distributed table"}
select (select * from test) from [1,2,3]
query: on_error
{"code": 1, "msg": "FROM: undefined distributed table"}
# test: select (select from table) from (select from expr)
explain select (select * from test) from (select * from [1,2,3])
query: on_error
{"code": 1, "msg": "FROM SELECT: undefined distributed table"}
select (select * from test) from (select * from [1,2,3])
query: on_error
{"code": 1, "msg": "FROM SELECT: undefined distributed table"}
# test: select (select from table) from reference
create table test2 (id int primary key) reference
insert into test2 (id) values (1), (2), (3)
explain select (select * from test) from test2
query: on_error
{"code": 1, "msg": "primary distributed table cannot be a reference table"}
select (select * from test) from test2
query: on_error
{"code": 1, "msg": "primary distributed table cannot be a reference table"}
# test: select (select from table) from (select from reference)
explain select (select * from test) from (select * from test2)
query: on_error
{"code": 1, "msg": "primary distributed table cannot be a reference table"}
select (select * from test) from (select * from test2)
query: on_error
{"code": 1, "msg": "primary distributed table cannot be a reference table"}
drop table test2
# test: select from (select from table)
explain select * from (select * from test)
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                bool        0      0      0
 2                push        0      0      0
 3          merge_recv        0      0     -1
 4    cursor_open_expr        1      0      6
 5                 jmp        9      0      0
 6         cursor_read        1      1      0
 7                send        1      0      0
 8         cursor_next        1      6      0
 9        cursor_close        1      0      0
10                 ret        0      0      0


bytecode [shard 0]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 1]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 2]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0

"
select * from (select * from test)
[3, 0]
[2, 0]
[1, 0]
# test: select from (select (select expr) from table)
explain select * from (select (select 123) from test)
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                bool        0      0      0
 2                push        0      0      0
 3          merge_recv        0      0     -1
 4    cursor_open_expr        1      0      6
 5                 jmp        9      0      0
 6         cursor_read        1      1      0
 7                send        1      0      0
 8         cursor_next        1      6      0
 9        cursor_close        1      0      0
10                 ret        0      0      0


bytecode [shard 0]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5                 int        1    123      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 1]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5                 int        1    123      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 2]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5                 int        1    123      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0

"
select * from (select (select 123) from test)
123
123
123
# test: select from (select (select from reference) from table)
create table test2 (id int primary key) reference
insert into test2 (id) values (1), (2), (3)
explain select * from (select (select * from test2) from test)
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                bool        0      0      0
 2                push        0      0      0
 3          merge_recv        0      0     -1
 4    cursor_open_expr        2      0      6
 5                 jmp        9      0      0
 6         cursor_read        1      2      0
 7                send        1      0      0
 8         cursor_next        2      6      0
 9        cursor_close        2      0      0
10                 ret        0      0      0


bytecode [shard 0]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp       16      0      0
 5                 set        1      0      0
 6             int_min        2      0      0
 7                push        2      0      0
 8         cursor_open        0     20     10      # public.test2 (primary)
 9                 jmp       13      0      0
10         cursor_read        2      0      0
11             set_add        1      2      0
12         cursor_next        0     10      0
13        cursor_close        0      0      0
14             set_add        0      1      0
15         cursor_next        1      5      0
16        cursor_close        1      0      0
17               ready        0      0      0
18                 ret        0      0      0


bytecode [shard 1]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp       16      0      0
 5                 set        1      0      0
 6             int_min        2      0      0
 7                push        2      0      0
 8         cursor_open        0     20     10      # public.test2 (primary)
 9                 jmp       13      0      0
10         cursor_read        2      0      0
11             set_add        1      2      0
12         cursor_next        0     10      0
13        cursor_close        0      0      0
14             set_add        0      1      0
15         cursor_next        1      5      0
16        cursor_close        1      0      0
17               ready        0      0      0
18                 ret        0      0      0


bytecode [shard 2]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp       16      0      0
 5                 set        1      0      0
 6             int_min        2      0      0
 7                push        2      0      0
 8         cursor_open        0     20     10      # public.test2 (primary)
 9                 jmp       13      0      0
10         cursor_read        2      0      0
11             set_add        1      2      0
12         cursor_next        0     10      0
13        cursor_close        0      0      0
14             set_add        0      1      0
15         cursor_next        1      5      0
16        cursor_close        1      0      0
17               ready        0      0      0
18                 ret        0      0      0

"
select * from (select (select * from test2) from test)
[[1], [2], [3]]
[[1], [2], [3]]
[[1], [2], [3]]
drop table test2
# test: select from (select (select from table) from table)
explain select * from (select (select * from test t) from test)
query: on_error
{"code": 1, "msg": "subqueries to distributed tables are not supported"}
select * from (select (select * from test t) from test)
query: on_error
{"code": 1, "msg": "subqueries to distributed tables are not supported"}
# test: select (select expr) from (select from table)
explain select (select t.*) from (select * from test) t
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                bool        0      0      0
 2                push        0      0      0
 3          merge_recv        0      0     -1
 4    cursor_open_expr        1      0      6
 5                 jmp        9      0      0
 6         cursor_read        1      1      0
 7                send        1      0      0
 8         cursor_next        1      6      0
 9        cursor_close        1      0      0
10                 ret        0      0      0


bytecode [shard 0]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 1]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 2]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9               ready        0      0      0
10                 ret        0      0      0

"
select (select t.*) from (select * from test) t
[3, 0]
[2, 0]
[1, 0]
# test: select (select from expr) from (select from table)
explain select (select t.*, * from [1,2,3]) from (select * from test) t
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                bool        0      0      0
 2                push        0      0      0
 3          merge_recv        0      0     -1
 4    cursor_open_expr        2      0      6
 5                 jmp       26      0      0
 6                 set        1      0      0
 7                 int        2      1      0
 8                push        2      0      0
 9                 int        2      2      0
10                push        2      0      0
11                 int        2      3      0
12                push        2      0      0
13               array        2      3      0
14    cursor_open_expr        0      2     16
15                 jmp       23      0      0
16         cursor_read        3      2      0
17                push        3      0      0
18         cursor_read        3      0      0
19                push        3      0      0
20               array        3      2      0
21             set_add        1      3      0
22         cursor_next        0     16      0
23        cursor_close        0      0      0
24                send        1      0      0
25         cursor_next        2      6      0
26        cursor_close        2      0      0
27                 ret        0      0      0


bytecode [shard 0]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      1      0
 6             set_add        0      1      0
 7         cursor_next        1      5      0
 8        cursor_close        1      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 1]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      1      0
 6             set_add        0      1      0
 7         cursor_next        1      5      0
 8        cursor_close        1      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 2]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      1      0
 6             set_add        0      1      0
 7         cursor_next        1      5      0
 8        cursor_close        1      0      0
 9               ready        0      0      0
10                 ret        0      0      0

"
select (select t.*, * from [1,2,3]) from (select * from test) t
[[[3, 0], 1], [[3, 0], 2], [[3, 0], 3]]
[[[2, 0], 1], [[2, 0], 2], [[2, 0], 3]]
[[[1, 0], 1], [[1, 0], 2], [[1, 0], 3]]
# test: select (select from reference) from (select from table)
create table test2 (id int primary key) reference
insert into test2 (id) values (1), (2), (3)
explain select (select t.*, * from test2) from (select * from test) t
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                bool        0      0      0
 2                push        0      0      0
 3          merge_recv        0      0     -1
 4    cursor_open_expr        2      0      6
 5                 jmp       21      0      0
 6                 set        1      0      0
 7             int_min        2      0      0
 8                push        2      0      0
 9         cursor_open        0     20     11      # public.test2 (primary)
10                 jmp       18      0      0
11         cursor_read        2      2      0
12                push        2      0      0
13         cursor_read        2      0      0
14                push        2      0      0
15               array        2      2      0
16             set_add        1      2      0
17         cursor_next        0     11      0
18        cursor_close        0      0      0
19                send        1      0      0
20         cursor_next        2      6      0
21        cursor_close        2      0      0
22                 ret        0      0      0


bytecode [shard 0]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      1      0
 6             set_add        0      1      0
 7         cursor_next        1      5      0
 8        cursor_close        1      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 1]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      1      0
 6             set_add        0      1      0
 7         cursor_next        1      5      0
 8        cursor_close        1      0      0
 9               ready        0      0      0
10                 ret        0      0      0


bytecode [shard 2]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        1      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      1      0
 6             set_add        0      1      0
 7         cursor_next        1      5      0
 8        cursor_close        1      0      0
 9               ready        0      0      0
10                 ret        0      0      0

"
select (select t.*, * from test2) from (select * from test) t
[[[3, 0], [1]], [[3, 0], [2]], [[3, 0], [3]]]
[[[2, 0], [1]], [[2, 0], [2]], [[2, 0], [3]]]
[[[1, 0], [1]], [[1, 0], [2]], [[1, 0], [3]]]
drop table test2
# test: select (select from table) from (select from table)
explain select (select t.*, z.* from test z) from (select * from test) t
query: on_error
{"code": 1, "msg": "subqueries to distributed tables are not supported"}
select (select t.*, z.* from test z) from (select * from test) t
query: on_error
{"code": 1, "msg": "subqueries to distributed tables are not supported"}
drop table test
disconnect S0
env_close E0
