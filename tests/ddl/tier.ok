open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;
create table test (id int primary key, a int, b int) partitions 1;
# test: create tier parsing
create tier;
{"msg": "create tier❰;❱ ⟵ name expected"}
create tier 1;
{"msg": "create tier ❰1❱ ⟵ name expected"}
create tier i;
{"msg": "create tier i❰;❱ ⟵ ON expected"}
create tier i 1;
{"msg": "create tier i ❰1❱ ⟵ ON expected"}
create tier i on;
{"msg": "create tier i on❰;❱ ⟵ name expected"}
create tier i on test 1;
{"msg": "create tier i on test ❰1❱ ⟵ ; expected"}
create tier i on test (;
{"msg": "create tier i on test (❰;❱ ⟵ name expected"}
create tier i on test (,;
{"msg": "create tier i on test (❰,❱ ⟵ name expected"}
# test: create tier
create tier t on test;
select show('tier', 'main', 'test', true).name;
["main"]
drop tier t on test;
# test: create tier if not exists
create tier t on test ();
create tier if not exists t on test;
select show('tier', 'main', 'test', true).name;
["main"]
drop tier t on test;
# test: create tier using main
create tier t on test using;
{"msg": "create tier t on test using❰;❱ ⟵ name expected"}
create tier t on test using x;
{"msg": "storage 'x': not exists"}
show tier t on test;
[null]
create tier t on test using main (id "00000000-0000-0000-0000-000000000000") ;
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
drop tier t on test;
# test: create tier using main dup
create tier t on test using main, main;
{"msg": "create tier t on test using main, ❰main❱ ⟵ storage used twice"}
# test: create tier using storage
create storage test;
create tier t on test using
  test (id "00000000-0000-0000-0000-000000000000"),
  main (id "00000000-0000-0000-0000-000000000001");
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": false,
    "partitions": 0
  }]
}]
drop tier t on test;
drop storage test;
# test: drop tier parsing
drop tier;
{"msg": "drop tier❰;❱ ⟵ name expected"}
drop tier 1;
{"msg": "drop tier ❰1❱ ⟵ name expected"}
drop tier '1';
{"msg": "drop tier ❰'1'❱ ⟵ name expected"}
drop tier i;
{"msg": "drop tier i❰;❱ ⟵ ON expected"}
drop tier i 1;
{"msg": "drop tier i ❰1❱ ⟵ ON expected"}
drop tier i on;
{"msg": "drop tier i on❰;❱ ⟵ name expected"}
drop tier i on 1;
{"msg": "drop tier i on ❰1❱ ⟵ name expected"}
# test: drop tier
create tier t on test using main (id "00000000-0000-0000-0000-000000000000") ;
drop tier t on test;
show tier t on test;
[null]
# test: drop tier if exists
show tier t on test;
[null]
show tier if exists t on test;
{"msg": "show tier ❰if❱ ⟵ ; expected"}
# test: drop tier storage
create storage test;
create tier t on test using
  test (id "00000000-0000-0000-0000-000000000000"),
  main (id "00000000-0000-0000-0000-000000000001");
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": false,
    "partitions": 0
  }]
}]
drop storage test;
{"msg": "storage 'test': is being used"}
drop tier t on test;
drop storage test;
# test: alter tier parsing
alter;
{"msg": "alter❰;❱ ⟵ USER|STORAGE|DATABASE|TABLE|INDEX|TIER|FUNCTION expected"}
alter tier;
{"msg": "alter tier❰;❱ ⟵ name expected"}
alter tier 1;
{"msg": "alter tier ❰1❱ ⟵ name expected"}
alter tier if;
{"msg": "alter tier if❰;❱ ⟵ EXISTS expected"}
alter tier if not;
{"msg": "alter tier if ❰not❱ ⟵ EXISTS expected"}
alter tier if exists;
{"msg": "alter tier if exists❰;❱ ⟵ name expected"}
alter tier i;
{"msg": "alter tier i❰;❱ ⟵ ON expected"}
alter tier i 1;
{"msg": "alter tier i ❰1❱ ⟵ ON expected"}
alter tier i on;
{"msg": "alter tier i on❰;❱ ⟵ name expected"}
alter tier i on test;
{"msg": "alter tier i on test❰;❱ ⟵ RENAME | ADD | DROP | PAUSE | RESUME | SET expected"}
alter tier i on test 1;
{"msg": "alter tier i on test ❰1❱ ⟵ RENAME | ADD | DROP | PAUSE | RESUME | SET expected"}
alter tier i on test rename;
{"msg": "alter tier i on test rename❰;❱ ⟵ TO expected"}
alter tier i on test rename 1;
{"msg": "alter tier i on test rename ❰1❱ ⟵ TO expected"}
alter tier i on test rename to;
{"msg": "alter tier i on test rename to❰;❱ ⟵ name expected"}
alter tier i on test rename to 1;
{"msg": "alter tier i on test rename to ❰1❱ ⟵ name expected"}
alter tier i on test rename to;
{"msg": "alter tier i on test rename to❰;❱ ⟵ name expected"}
# test: alter tier rename
create tier t on test using main (id "00000000-0000-0000-0000-000000000000");
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
alter tier t on test rename to z;
show tier t on test;
[null]
show tier z on test;
[{
  "name": "z",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
# test: alter tier rename if exists
alter tier if exists t on test rename to z;
show tier t on test;
[null]
show tier z on test;
[{
  "name": "z",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
# test: alter tier rename (conflict)
alter tier z on test rename to z;
{"msg": "table 'test' tier 'z': already exists"}
show tier z on test;
[{
  "name": "z",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
drop tier z on test;
# test: alter tier storage add
create storage test;
create tier t on test using main (id "00000000-0000-0000-0000-000000000000");
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
alter tier t on test add;
{"msg": "alter tier t on test add❰;❱ ⟵ STORAGE expected"}
alter tier t on test add storage;
{"msg": "alter tier t on test add storage❰;❱ ⟵ name expected"}
alter tier t on test add storage x;
{"msg": "storage 'x': not exists"}
alter tier t on test add storage test (id "00000000-0000-0000-0000-000000000000");
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
# test: alter tier storage add if not exists
alter tier t on test add storage test;
{"msg": "table 'test' tier 't' storage 'test': already exists"}
alter tier t on test add storage if not exists test;
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
# test: alter tier storage drop
drop storage test;
{"msg": "storage 'test': is being used"}
alter tier t on test drop;
{"msg": "alter tier t on test drop❰;❱ ⟵ STORAGE expected"}
alter tier t on test drop storage;
{"msg": "alter tier t on test drop storage❰;❱ ⟵ name expected"}
alter tier t on test drop storage x;
{"msg": "table 'test' tier 't' storage 'x': not found"}
alter tier t on test drop storage test;
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
# test: alter tier storage drop if exists
alter tier t on test drop storage test;
{"msg": "table 'test' tier 't' storage 'test': not found"}
alter tier t on test drop storage if exists test;
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
drop storage test;
drop tier t on test;
# test: alter tier storage pause
create storage test;
create tier t on test using
  main (id "00000000-0000-0000-0000-000000000000"),
  test (id "00000000-0000-0000-0000-000000000001");
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": false,
    "partitions": 0
  }]
}]
alter tier t on test pause;
{"msg": "alter tier t on test pause❰;❱ ⟵ STORAGE expected"}
alter tier t on test pause storage;
{"msg": "alter tier t on test pause storage❰;❱ ⟵ name expected"}
alter tier t on test pause storage test;
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": true,
    "partitions": 0
  }]
}]
# test: alter tier storage pause (one must remain)
alter tier t on test pause storage main;
{"msg": "table 'test' tier 't': at least one storage must remain active"}
# test: alter tier storage resume
alter tier t on test resume;
{"msg": "alter tier t on test resume❰;❱ ⟵ STORAGE expected"}
alter tier t on test resume storage;
{"msg": "alter tier t on test resume storage❰;❱ ⟵ name expected"}
alter tier t on test resume storage test;
show tier t on test;
[{
  "name": "t",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }, {
    "name": "test",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": false,
    "partitions": 0
  }]
}]
drop tier t on test;
# test: alter tier set
create tier t on test using main (id "00000000-0000-0000-0000-000000000000");
alter tier t on test set (region_size 123, compression '');
show tier t on test;
[{
  "name": "t",
  "compression": "",
  "compression_level": 0,
  "region_size": 123,
  "object_size": 67108864,
  "storages": [{
    "name": "main",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 0
  }]
}]
# test: alter tier set compression
insert into test values (123, 0, 0);
show partitions on test;
[{
  "id": 1,
  "tier": "main",
  "storage": "main",
  "ram": true,
  "pending": false,
  "min": 0,
  "max": 8096,
  "lsn": 0,
  "size": 524288,
  "compression": 1
}]
select show('tier', 'main', 'test', true).compression;
["zstd"]
alter tier main on test set (compression '');
select show('tier', 'main', 'test', true).compression;
[""]
alter partition 1 on test refresh;
show partitions on test;
[{
  "id": 2,
  "tier": "main",
  "storage": "main",
  "ram": true,
  "pending": false,
  "min": 0,
  "max": 8096,
  "lsn": 34,
  "size": 524288,
  "compression": 0
}]
drop table test;
# test: storages rebalance
create storage a;
create storage b;
create storage c;
create table test (id int primary key, a int, b int) partitions 5
        tier main using
		          a (id "00000000-0000-0000-0000-000000000000"),
		          b (id "00000000-0000-0000-0000-000000000001"),
		          c (id "00000000-0000-0000-0000-000000000002");
show partitions on test;
[{
  "id": 3,
  "tier": "main",
  "storage": "a",
  "ram": true,
  "pending": false,
  "min": 0,
  "max": 1619,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 4,
  "tier": "main",
  "storage": "b",
  "ram": true,
  "pending": false,
  "min": 1619,
  "max": 3238,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 5,
  "tier": "main",
  "storage": "c",
  "ram": true,
  "pending": false,
  "min": 3238,
  "max": 4857,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 6,
  "tier": "main",
  "storage": "a",
  "ram": true,
  "pending": false,
  "min": 4857,
  "max": 6476,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 7,
  "tier": "main",
  "storage": "b",
  "ram": true,
  "pending": false,
  "min": 6476,
  "max": 8096,
  "lsn": 0,
  "size": 0,
  "compression": 1
}]
show tiers on test;
[{
  "name": "main",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "a",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 2
  }, {
    "name": "b",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": false,
    "partitions": 2
  }, {
    "name": "c",
    "id": "00000000-0000-0000-0000-000000000002",
    "pause": false,
    "partitions": 1
  }]
}]
alter partition 7 on test refresh;
show partition '8' on test;
[{
  "id": 8,
  "tier": "main",
  "storage": "c",
  "ram": true,
  "pending": false,
  "min": 6476,
  "max": 8096,
  "lsn": 0,
  "size": 0,
  "compression": 1
}]
drop table test;
drop storage a;
drop storage b;
drop storage c;
# test: storages rebalance (pause/resume)
create storage a;
create storage b;
create storage c;
create table test (id int primary key, a int, b int) partitions 5
        tier main using
		          a (id "00000000-0000-0000-0000-000000000000"),
		          b (id "00000000-0000-0000-0000-000000000001"),
		          c (id "00000000-0000-0000-0000-000000000002");
show partitions on test;
[{
  "id": 9,
  "tier": "main",
  "storage": "a",
  "ram": true,
  "pending": false,
  "min": 0,
  "max": 1619,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 10,
  "tier": "main",
  "storage": "b",
  "ram": true,
  "pending": false,
  "min": 1619,
  "max": 3238,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 11,
  "tier": "main",
  "storage": "c",
  "ram": true,
  "pending": false,
  "min": 3238,
  "max": 4857,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 12,
  "tier": "main",
  "storage": "a",
  "ram": true,
  "pending": false,
  "min": 4857,
  "max": 6476,
  "lsn": 0,
  "size": 0,
  "compression": 1
}, {
  "id": 13,
  "tier": "main",
  "storage": "b",
  "ram": true,
  "pending": false,
  "min": 6476,
  "max": 8096,
  "lsn": 0,
  "size": 0,
  "compression": 1
}]
alter tier main on test pause storage b;
alter tier main on test pause storage c;
show tiers on test;
[{
  "name": "main",
  "compression": "zstd",
  "compression_level": 0,
  "region_size": 65536,
  "object_size": 67108864,
  "storages": [{
    "name": "a",
    "id": "00000000-0000-0000-0000-000000000000",
    "pause": false,
    "partitions": 2
  }, {
    "name": "b",
    "id": "00000000-0000-0000-0000-000000000001",
    "pause": true,
    "partitions": 2
  }, {
    "name": "c",
    "id": "00000000-0000-0000-0000-000000000002",
    "pause": true,
    "partitions": 1
  }]
}]
alter partition 13 on test refresh;
show partition '14' on test;
[{
  "id": 14,
  "tier": "main",
  "storage": "a",
  "ram": true,
  "pending": false,
  "min": 6476,
  "max": 8096,
  "lsn": 0,
  "size": 0,
  "compression": 1
}]
alter partition 14 on test refresh;
show partition '15' on test;
[{
  "id": 15,
  "tier": "main",
  "storage": "a",
  "ram": true,
  "pending": false,
  "min": 6476,
  "max": 8096,
  "lsn": 0,
  "size": 0,
  "compression": 1
}]
alter tier main on test resume storage c;
alter partition 15 on test refresh;
show partition '16' on test;
[{
  "id": 16,
  "tier": "main",
  "storage": "c",
  "ram": true,
  "pending": false,
  "min": 6476,
  "max": 8096,
  "lsn": 0,
  "size": 0,
  "compression": 1
}]
drop table test;
drop storage a;
drop storage b;
drop storage c;
disconnect S0;
close E0;
