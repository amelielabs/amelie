open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
# test: cte parsing
with
{"msg": "WITH <name> expected"}
with 1
{"msg": "WITH <name> expected"}
with test
{"msg": "WITH name <AS> expected"}
with test 1
{"msg": "WITH name <AS> expected"}
with test as
{"msg": "WITH name AS <(> expected"}
with test as 1
{"msg": "WITH name AS <(> expected"}
with test (
{"msg": "WITH name (<name> expected"}
with test (1
{"msg": "WITH name (<name> expected"}
with test (name
{"msg": "WITH name (<)> expected"}
with test (name,
{"msg": "WITH name (<name> expected"}
with test (name,,
{"msg": "WITH name (<name> expected"}
with test (name,)
{"msg": "WITH name (<name> expected"}
with test (name,
{"msg": "WITH name (<name> expected"}
with test (name)
{"msg": "WITH name <AS> expected"}
with test as (
{"msg": "CTE statement must be DML or SELECT"}
# test: with () (no stmt)
with test as ()
{"msg": "unexpected statement"}
# test: with(select expr) (no main stmt)
with test as (select 1)
[1]
explain with test as (select 1)
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "body                0      0      0     ",
      "06": "ret                 0      0      0     "
    }
  }
}]
with test as (select 1,2,3)
[[1, 2, 3]]
explain with test as (select 1,2,3)
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      3      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "int                 1      -      0     # 2",
      "04": "push                1      0      0     ",
      "05": "int                 1      -      0     # 3",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "cte_set             0      0      0     ",
      "09": "body                0      0      0     ",
      "10": "ret                 0      0      0     "
    }
  }
}]
# test: with(select expr), select expr (cte not used)
with test as (select 1) select 2
[2]
# test: with(select expr), select * from cte
with a as (select 1) select * from a
[1]
with a as (select 1, 2) select * from a
[[1, 2]]
with a as (select 1, 2, 3) select * from a
[[1, 2, 3]]
# test: with(select expr as), select * from cte
with a as (select 1 as a) select * from a
[1]
with a as (select 1 as a, 2 as b) select * from a
[[1, 2]]
# test: with(select expr as), select column from cte
with a as (select 1 as a) select a from a
[1]
with a as (select 1 as a, 2 as b) select a, b from a
[[1, 2]]
# test: with(select expr as), select target.column from cte
with a as (select 1 as a, 2 as b) select a.a, a.b from a
[[1, 2]]
# test: with(select * from table) (no main stmt)
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test)
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test)
[1, 2, 3]
drop table test
# test: with(select * from table) select expr (cte not used)
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select 2
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "int                 1      -      0     # 2",
      "08": "push                1      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "cte_set             1      0      0     ",
      "11": "body                1      0      0     ",
      "12": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select 2
[2]
drop table test
# test: with(select * from table), select * from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select * from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_open          0      0      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "body                1      0      0     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select * from a
[1, 2, 3]
drop table test
# test: with(select * from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select id from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_open          0      0      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "body                1      0      0     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select id from a
[1, 2, 3]
drop table test
# test: with(select * from table), select target.column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select a.id from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_open          0      0      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "body                1      0      0     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select a.id from a
[1, 2, 3]
drop table test
# test: with(select column from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select id from test) select id from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_open          0      0      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "body                1      0      0     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select id from test) select id from a
[1, 2, 3]
drop table test
# test: with(select column as from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select id as x from test) select id from a
{"msg": "<a.id> column not found"}
explain with a as (select id as x from test) select x from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_open          0      0      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "body                1      0      0     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 9      0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      5      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
with a as (select id as x from test) select x from a
[1, 2, 3]
drop table test
disconnect S0
close E0
