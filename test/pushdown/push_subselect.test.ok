open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
create table test (id int primary key, data int default 0)
insert into test (id) values (1), (2), (3)
# test: select (select from table)
explain select (select * from test)
{"msg": "distributed table 'public.test' cannot be used in subquery"}
select (select * from test)
{"msg": "distributed table 'public.test' cannot be used in subquery"}
# test: select (select from table) from shared
create shared table test2 (id int primary key)
insert into test2 (id) values (1), (2), (3)
explain select (select * from test) from test2
{"msg": "distributed table 'public.test' cannot be used in subquery"}
select (select * from test) from test2
{"msg": "distributed table 'public.test' cannot be used in subquery"}
# test: select (select from table) from (select from shared)
explain select (select * from test) from (select * from test2) t
{"msg": "distributed table 'public.test' cannot be used in subquery"}
select (select * from test) from (select * from test2) t
{"msg": "distributed table 'public.test' cannot be used in subquery"}
drop table test2
# test: select from (select from table)
explain select * from (select * from test) t
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      2      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 16     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "store_read          2      0      1     ",
      "13": "push                2      0      0     ",
      "14": "set_add             0      0      0     ",
      "15": "store_next          0      10     0     ",
      "16": "store_close         0      1      0     ",
      "17": "cte_set             1      0      0     ",
      "18": "content             1      -      -     ",
      "19": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select * from (select * from test) t
[[1, 0], [2, 0], [3, 0]]
# test: select from (select (select from shared) from table)
create shared table test2 (id int primary key)
insert into test2 (id) values (1), (2), (3)
explain select * from (select (select id from test2) from test) t
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          1      0      3     # public.test (primary)",
      "02": "jmp                 15     0      0     ",
      "03": "set                 1      1      0     ",
      "04": "table_open          0      20     6     # public.test2 (primary)",
      "05": "jmp                 10     0      0     ",
      "06": "table_readi32       2      0      0     ",
      "07": "push                2      0      0     ",
      "08": "set_add             1      0      0     ",
      "09": "table_next          0      6      0     ",
      "10": "table_close         0      0      0     ",
      "11": "set_result          2      1      0     ",
      "12": "push                2      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          1      3      0     ",
      "15": "table_close         1      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
select * from (select (select id from test2) from test) t
[1, 1, 1]
drop table test2
# test: select from (select (select from table) from table)
explain select * from (select (select id from test t) from test) g
{"msg": "distributed table 'public.test' cannot be used in subquery"}
select * from (select (select id from test t) from test) g
{"msg": "distributed table 'public.test' cannot be used in subquery"}
# test: select (select expr) from (select from table)
select (select t.*) from (select * from test) t
{"msg": "subquery must return only one column"}
select (select t.id) from (select * from test) t
[1, 2, 3]
# test: select (select from shared) from (select from table)
create shared table test2 (id int primary key)
insert into test2 (id) values (1), (2), (3)
explain select (select t.id from test2) from (select * from test) t
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_first          1      12     0     ",
      "07": "recv_to             0      1      0     ",
      "08": "cte_set             1      0      0     ",
      "09": "content             1      -      -     ",
      "10": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     ",
      "12": "set                 0      1      0     ",
      "13": "cte_get             1      0      0     ",
      "14": "store_open          1      1      16    ",
      "15": "jmp                 28     0      0     ",
      "16": "set                 2      1      0     ",
      "17": "table_open          0      20     19    # public.test2 (primary)",
      "18": "jmp                 23     0      0     ",
      "19": "store_read          3      1      0     ",
      "20": "push                3      0      0     ",
      "21": "set_add             2      0      0     ",
      "22": "table_next          0      19     0     ",
      "23": "table_close         0      0      0     ",
      "24": "set_result          3      2      0     ",
      "25": "push                3      0      0     ",
      "26": "set_add             0      0      0     ",
      "27": "store_next          1      16     0     ",
      "28": "store_close         1      1      0     ",
      "29": "result              0      0      0     ",
      "30": "ret                 0      0      0     "
    }
  }
}]
select (select t.id from test2) from (select * from test) t
[1, 2, 3]
drop table test2
# test: select (select from table) from (select from table)
explain select (select t.id from test z) from (select * from test) t
{"msg": "distributed table 'public.test' cannot be used in subquery"}
select (select t.id from test z) from (select * from test) t
{"msg": "distributed table 'public.test' cannot be used in subquery"}
# test: select from (select from table), (select from table)
select * from (select * from test) a, (select * from test) b
[[1, 0, 1, 0], [1, 0, 2, 0], [1, 0, 3, 0], [2, 0, 1, 0], [2, 0, 2, 0], [2, 0, 3, 0], [3, 0, 1, 0], [3, 0, 2, 0], [3, 0, 3, 0]]
explain select * from (select * from test) a, (select * from test) b
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "send_all            1      12     -     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "merge_recv          0      -1     -1    ",
      "06": "cte_set             0      0      0     ",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "merge_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "set                 0      4      0     ",
      "13": "cte_get             1      0      0     ",
      "14": "store_open          0      1      16    ",
      "15": "jmp                 31     0      0     ",
      "16": "cte_get             2      1      0     ",
      "17": "store_open          1      2      19    ",
      "18": "jmp                 29     0      0     ",
      "19": "store_read          3      0      0     ",
      "20": "push                3      0      0     ",
      "21": "store_read          3      0      1     ",
      "22": "push                3      0      0     ",
      "23": "store_read          3      1      0     ",
      "24": "push                3      0      0     ",
      "25": "store_read          3      1      1     ",
      "26": "push                3      0      0     ",
      "27": "set_add             0      0      0     ",
      "28": "store_next          1      19     0     ",
      "29": "store_close         1      1      0     ",
      "30": "store_next          0      16     0     ",
      "31": "store_close         0      1      0     ",
      "32": "cte_set             2      0      0     ",
      "33": "content             2      -      -     ",
      "34": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     ",
      "12": "set                 0      2      0     ",
      "13": "table_open          0      20     15    # public.test (primary)",
      "14": "jmp                 21     0      0     ",
      "15": "table_readi32       1      0      0     ",
      "16": "push                1      0      0     ",
      "17": "table_readi32       1      0      1     ",
      "18": "push                1      0      0     ",
      "19": "set_add             0      0      0     ",
      "20": "table_next          0      15     0     ",
      "21": "table_close         0      0      0     ",
      "22": "result              0      0      0     ",
      "23": "ret                 0      0      0     "
    }
  }
}]
# test: insert returning (select from table) (unsupported)
explain insert into test (id) values (4) returning (select * from test t)
{"msg": "unexpected subquery"}
insert into test (id) values (4) returning (select * from test t)
{"msg": "unexpected subquery"}
# test: insert returning (select from shared) (unsupported)
create shared table test_ (id int primary key)
insert into test_ values (1),(2),(3)
insert into test (id) values (5) returning (select * from test_)
{"msg": "unexpected subquery"}
drop table test_
# test: insert returning (select from expr) (unsupported)
insert into test (id) values (6) returning *, select [1,2,3]
{"msg": "unexpected subquery"}
insert into test (id) values (7) returning id, select [1,2,3]
{"msg": "unexpected subquery"}
drop table test
disconnect S0
close E0
