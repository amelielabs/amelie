open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }]
connect E0 S0 localhost:3485
# test: timestamp parsing
select '2'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '2a'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select 'a'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '_a'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '_'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '-'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '--'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '-- ::'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1969-0-0'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1969-0-0 0:0:0'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-0-0 00:00:00'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-00-00 00:00:00'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select timestamp '1970-00-00 00:00:00'
{"code": 1, "msg": "malformed timestamp string"}
select timestamp('1970-00-00 00:00:00')
{"code": 1, "msg": "malformed timestamp string"}
# test: epoch
select '1970-01-01 00:00:00'::timestamp
"1970-01-01 00:00:00.000000Z"
select timestamp '1970-01-01 00:00:00'
"1970-01-01 00:00:00.000000Z"
select timestamp('1970-01-01 00:00:00')
"1970-01-01 00:00:00.000000Z"
# test: day overflow
select '1970-01-33 00:00:00'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
# test: month overflow
select '1970-13-01 00:00:00'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
# test: second overflow
select '1970-01-01 00:00:70'::timestamp
"1970-01-01 00:01:10.000000Z"
# test: minute overflow
select '1970-01-01 00:70:00'::timestamp
"1970-01-01 01:10:00.000000Z"
# test: hour overflow
select '1970-01-01 28:00:00'::timestamp
"1970-01-02 04:00:00.000000Z"
# test: 24hour
select '1970-01-01 24:00:00'::timestamp
"1970-01-02 00:00:00.000000Z"
# test: ms
select '1970-01-01 00:00:00.'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.0'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.00'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.000'::timestamp
"1970-01-01 00:00:00.000000Z"
select '1970-01-01 00:00:00.001'::timestamp
"1970-01-01 00:00:00.001000Z"
select '1970-01-01 00:00:00.001'::timestamp()
"1970-01-01 00:00:00.001000Z"
select timestamp '1970-01-01 00:00:00.001'
"1970-01-01 00:00:00.001000Z"
select timestamp('1970-01-01 00:00:00.001')
"1970-01-01 00:00:00.001000Z"
# test: us
select '1970-01-01 00:00:00.0010'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.00100'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.000001'::timestamp
"1970-01-01 00:00:00.000001Z"
select '1970-01-01 00:00:00.000000'::timestamp
"1970-01-01 00:00:00.000000Z"
select '1970-01-01 00:00:00.999999'::timestamp
"1970-01-01 00:00:00.999999Z"
select timestamp '1970-01-01 00:00:00.999999'
"1970-01-01 00:00:00.999999Z"
select timestamp('1970-01-01 00:00:00.999999')
"1970-01-01 00:00:00.999999Z"
select timestamp('1970-01-01 00:00:00.999999', 123)
{"code": 1, "msg": "timestamp(): incorrect number of arguments"}
# test: zulu
select '1970-01-01 00:00:00.999999Z'::timestamp
"1970-01-01 00:00:00.999999Z"
select '1970-01-01 00:00:00.999999Zjunk'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select timestamp '1970-01-01 00:00:00.999999Zjunk'
{"code": 1, "msg": "malformed timestamp string"}
# test: timezone
select '1970-01-01 00:00:00.999999+'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.999999+0'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
select '1970-01-01 00:00:00.999999+00'::timestamp
"1970-01-01 00:00:00.999999Z"
select '1970-01-01 00:00:00.999999-00'::timestamp
"1970-01-01 00:00:00.999999Z"
select '1970-01-01 00:00:00.999999-000'::timestamp
{"code": 1, "msg": "malformed timestamp string"}
# test: timezone (ignore)
select '1970-01-01 00:00:00.999999+00'::timestamp
"1970-01-01 00:00:00.999999Z"
select '1970-01-01 00:00:00.999999+01'::timestamp
"1970-01-01 00:00:00.999999Z"
select '1970-01-01 00:00:00.999999+02'::timestamp
"1970-01-01 00:00:00.999999Z"
select '1970-01-01 00:00:00.999999+03'::timestamp
"1970-01-01 00:00:00.999999Z"
# test: convertion (string)
select '1970-01-01 01:12:59.909090'::timestamp
"1970-01-01 01:12:59.909090Z"
select '1970-01-01 01:12:59.909090'::timestamp::string
"1970-01-01 01:12:59.909090Z"
select '1970-01-01 01:12:59.909090'::timestamp::string::timestamp
"1970-01-01 01:12:59.909090Z"
select '1970-01-01 01:12:59.909090'::timestamp::string::timestamp::string
"1970-01-01 01:12:59.909090Z"
select timestamp '1970-01-01 01:12:59.909090'::string::timestamp::string
"1970-01-01 01:12:59.909090Z"
select timestamp('1970-01-01 01:12:59.909090')::string::timestamp::string
"1970-01-01 01:12:59.909090Z"
# test: convertion (document)
select ['1970-01-01 01:12:59.909090'::timestamp]
["1970-01-01 01:12:59.909090Z"]
select ['1970-01-01 01:12:59.909090'::timestamp::string]
["1970-01-01 01:12:59.909090Z"]
select ['1970-01-01 01:12:59.909090'::timestamp::string::timestamp]
["1970-01-01 01:12:59.909090Z"]
select ['1970-01-01 01:12:59.909090'::timestamp::string::timestamp::string]
["1970-01-01 01:12:59.909090Z"]
# test: add
select '1970-01-01 01:12:59.909090'::timestamp + 1
{"code": 1, "msg": "bad + expression types"}
select '1970-01-01 01:12:59.909090'::timestamp + '1 hour'
{"code": 1, "msg": "bad + expression types"}
select '1970-01-01 00:00:00.000000'::timestamp + '1 hour'::interval
"1970-01-01 01:00:00.000000Z"
select '1970-01-01 00:00:00.000000'::timestamp + '1 year'::interval
"1971-01-01 00:00:00.000000Z"
select '1971-01-01 00:00:00.000000'::timestamp + '1 year'::interval
"1972-01-01 00:00:00.000000Z"
select '1 year'::interval + '1 year'::interval
"2 years"
select '1970-01-01 00:00:00.000000'::timestamp + '1 year'::interval + '1 year'::interval
"1972-01-01 00:00:00.000000Z"
# test: sub
select '1970-01-01 01:12:59.909090'::timestamp + 1
{"code": 1, "msg": "bad + expression types"}
select '1970-01-01 01:12:59.909090'::timestamp - '1 hour'
{"code": 1, "msg": "bad - expression types"}
select '1970-01-01 00:00:00.000000'::timestamp - '1 hour'::interval
"586524-01-19 07:01:49.551616Z"
select '1973-01-01 00:00:00.000000'::timestamp - '1 year'::interval
"1972-01-01 00:00:00.000000Z"
select '1 year'::interval - '1 year'::interval
""
select '1980-01-01 00:00:00.000000'::timestamp - '1 year'::interval - '1 year'::interval
"1980-01-01 00:00:00.000000Z"
select '1980-01-01 00:00:00.000000'::timestamp - '-1 year'::interval - '-1 year'::interval
"1980-01-01 00:00:00.000000Z"
# test: eq
select '1970-01-01 01:12:59.909090'::timestamp = '1970-01-01 01:12:59.909090'::timestamp
true
select '1970-01-01 01:12:59.909090'::timestamp = '1970-01-01 01:12:59.909099'::timestamp
false
# test: lte
select '1970-01-01 01:12:59.909090'::timestamp <= '1970-01-01 01:12:59.909090'::timestamp
true
select '1970-01-01 01:12:58'::timestamp <= '1970-01-01 01:12:59.909090'::timestamp
true
select '1970-01-01 01:13:00'::timestamp <= '1970-01-01 01:12:59'::timestamp
false
select '1970-01-01 01:12:59.909090'::timestamp <= '1970-01-01 01:12:59.909099'::timestamp
true
# test: lt
select '1970-01-01 01:12:59.909090'::timestamp < '1970-01-01 01:12:59.909090'::timestamp
false
select '1970-01-01 01:12:58'::timestamp < '1970-01-01 01:12:59.909090'::timestamp
true
select '1970-01-01 01:13:00'::timestamp < '1970-01-01 01:12:59'::timestamp
false
select '1970-01-01 01:12:59.909090'::timestamp < '1970-01-01 01:12:59.909099'::timestamp
true
# test: gte
select '1970-01-01 01:12:59.909090'::timestamp >= '1970-01-01 01:12:59.909090'::timestamp
true
select '1970-01-01 01:12:58'::timestamp >= '1970-01-01 01:12:59.909090'::timestamp
false
select '1970-01-01 01:13:00'::timestamp >= '1970-01-01 01:12:59'::timestamp
true
select '1970-01-01 01:12:59.909090'::timestamp >= '1970-01-01 01:12:59.909099'::timestamp
false
# test: gt
select '1970-01-01 01:12:59.909090'::timestamp > '1970-01-01 01:12:59.909090'::timestamp
false
select '1970-01-01 01:12:58'::timestamp > '1970-01-01 01:12:59.909090'::timestamp
false
select '1970-01-01 01:13:00'::timestamp > '1970-01-01 01:12:59'::timestamp
true
select '1970-01-01 01:12:59.909090'::timestamp > '1970-01-01 01:12:59.909099'::timestamp
false
# test: timestamp column
create table test (id int primary key, ts timestamp)
insert into test values (0, "1970-01-01 01:12:59.909090")
{"code": 1, "msg": "column <ts>: does not match data type"}
insert into test values (0, "1970-01-01 01:12:59.909090"::timestamptz)
{"code": 1, "msg": "column <ts>: does not match data type"}
insert into test values (0, "1970-01-01 01:12:59.909090"::timestamp)
insert into test values (1, "1970-01-01 01:13:00"::timestamp)
insert into test values (2, "1970-01-01 01:13:01"::timestamp)
select * from test
[[0, "1970-01-01 01:12:59.909090Z"], [1, "1970-01-01 01:13:00.000000Z"], [2, "1970-01-01 01:13:01.000000Z"]]
select * from test where ts > "1970-01-01 01:12:59.909090"::timestamp;
[[1, "1970-01-01 01:13:00.000000Z"], [2, "1970-01-01 01:13:01.000000Z"]]
explain select * from test where ts > "1970-01-01 01:12:59.909090"::timestamp;
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp       14      0      0
 5          cursor_idx        1      0      1
 6              string        2     20      0      # 1970-01-01 01:12:59.909090
 7                push        2      0      0
 8                call        2      -      1      # public.timestamp()
 9                  gt        3      1      2
10                jntr       13      3      0
11         cursor_read        1      0      0
12             set_add        0      1      0
13         cursor_next        0      5      0
14        cursor_close        0      0      0
15              result        0      0      0
16                 ret        0      0      0

"
select * from test where ts > timestamp "1970-01-01 01:12:59.909090"
[[1, "1970-01-01 01:13:00.000000Z"], [2, "1970-01-01 01:13:01.000000Z"]]
explain select * from test where ts > timestamp "1970-01-01 01:12:59.909090"
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1             int_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp       12      0      0
 5          cursor_idx        1      0      1
 6           timestamp        2 4379909090      0
 7                  gt        3      1      2
 8                jntr       11      3      0
 9         cursor_read        1      0      0
10             set_add        0      1      0
11         cursor_next        0      5      0
12        cursor_close        0      0      0
13              result        0      0      0
14                 ret        0      0      0

"
select * from test where ts = "1970-01-01 01:13:01"::timestamp;
[[2, "1970-01-01 01:13:01.000000Z"]]
drop table test
# test: timestamp column (key)
create table test (id timestamp primary key)
insert into test values ("1970-01-01 00:00:01.000001"::timestamp)
insert into test values ("1970-01-01 00:00:01.000002"::timestamp)
insert into test values ("1970-01-01 00:00:01.000003"::timestamp)
insert into test values ("1970-01-01 00:00:02.000000"::timestamp)
insert into test values ("1970-01-01 00:00:03.000000"::timestamp)
insert into test values ("1970-01-01 00:00:04.000000"::timestamp)
explain select * from test
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1       timestamp_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp        8      0      0
 5         cursor_read        1      0      0
 6             set_add        0      1      0
 7         cursor_next        0      5      0
 8        cursor_close        0      0      0
 9              result        0      0      0
10                 ret        0      0      0

"
select * from test
[["1970-01-01 00:00:01.000001Z"], ["1970-01-01 00:00:01.000002Z"], ["1970-01-01 00:00:01.000003Z"], ["1970-01-01 00:00:02.000000Z"], ["1970-01-01 00:00:03.000000Z"], ["1970-01-01 00:00:04.000000Z"]]
select * from test order by id
[["1970-01-01 00:00:01.000001Z"], ["1970-01-01 00:00:01.000002Z"], ["1970-01-01 00:00:01.000003Z"], ["1970-01-01 00:00:02.000000Z"], ["1970-01-01 00:00:03.000000Z"], ["1970-01-01 00:00:04.000000Z"]]
select * from test where id > timestamp '1970-01-01 00:00:01.000002'
[["1970-01-01 00:00:01.000003Z"], ["1970-01-01 00:00:02.000000Z"], ["1970-01-01 00:00:03.000000Z"], ["1970-01-01 00:00:04.000000Z"]]
explain select * from test where id > timestamp '1970-01-01 00:00:01.000002'
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1           timestamp        1 1000002      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp       12      0      0
 5          cursor_idx        1      0      0
 6           timestamp        2 1000002      0
 7                  gt        3      1      2
 8                jntr       11      3      0
 9         cursor_read        1      0      0
10             set_add        0      1      0
11         cursor_next        0      5      0
12        cursor_close        0      0      0
13              result        0      0      0
14                 ret        0      0      0

"
select * from test where id >= timestamp '1970-01-01 00:00:01.000002'
[["1970-01-01 00:00:01.000002Z"], ["1970-01-01 00:00:01.000003Z"], ["1970-01-01 00:00:02.000000Z"], ["1970-01-01 00:00:03.000000Z"], ["1970-01-01 00:00:04.000000Z"]]
explain select * from test where id >= timestamp '1970-01-01 00:00:01.000002'
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1           timestamp        1 1000002      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp       12      0      0
 5          cursor_idx        1      0      0
 6           timestamp        2 1000002      0
 7                 gte        3      1      2
 8                jntr       11      3      0
 9         cursor_read        1      0      0
10             set_add        0      1      0
11         cursor_next        0      5      0
12        cursor_close        0      0      0
13              result        0      0      0
14                 ret        0      0      0

"
select * from test where id < timestamp '1970-01-01 00:00:01.000003'
[["1970-01-01 00:00:01.000001Z"], ["1970-01-01 00:00:01.000002Z"]]
explain select * from test where id < timestamp '1970-01-01 00:00:01.000003'
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1       timestamp_min        1      0      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp       16      0      0
 5          cursor_idx        1      0      0
 6           timestamp        2 1000003      0
 7                  lt        3      1      2
 8                jntr        4      3      0
 9          cursor_idx        1      0      0
10           timestamp        2 1000003      0
11                  lt        3      1      2
12                jntr       15      3      0
13         cursor_read        1      0      0
14             set_add        0      1      0
15         cursor_next        0      5      0
16        cursor_close        0      0      0
17              result        0      0      0
18                 ret        0      0      0

"
select * from test where id = timestamp '1970-01-01 00:00:01.000003'
[["1970-01-01 00:00:01.000003Z"]]
explain select * from test where id = timestamp '1970-01-01 00:00:01.000003'
"
bytecode [coordinator]
--------
 0           send_hash        0      0      -      # public.test
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1           timestamp        1 1000003      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary), lookup
 4                 jmp       12      0      0
 5          cursor_idx        1      0      0
 6           timestamp        2 1000003      0
 7                 equ        3      1      2
 8                jntr        4      3      0
 9         cursor_read        1      0      0
10             set_add        0      1      0
11                 jmp        4      0      0
12        cursor_close        0      0      0
13              result        0      0      0
14                 ret        0      0      0

"
drop table test
# test: timestamp column (secondary index)
create table test (id timestamp primary key)
insert into test values ("1970-01-01 00:00:01.000001"::timestamp)
insert into test values ("1970-01-01 00:00:01.000002"::timestamp)
insert into test values ("1970-01-01 00:00:01.000003"::timestamp)
insert into test values ("1970-01-01 00:00:02.000000"::timestamp)
insert into test values ("1970-01-01 00:00:03.000000"::timestamp)
insert into test values ("1970-01-01 00:00:04.000000"::timestamp)
create index i on test (id) with (type = 'hash')
select * from test use index (i)
[["1970-01-01 00:00:01.000001Z"], ["1970-01-01 00:00:03.000000Z"], ["1970-01-01 00:00:02.000000Z"], ["1970-01-01 00:00:01.000002Z"], ["1970-01-01 00:00:04.000000Z"], ["1970-01-01 00:00:01.000003Z"]]
select * from test where id > timestamp '1970-01-01 00:00:01.000003'
[["1970-01-01 00:00:02.000000Z"], ["1970-01-01 00:00:03.000000Z"], ["1970-01-01 00:00:04.000000Z"]]
explain select * from test where id > timestamp '1970-01-01 00:00:01.000003'
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1           timestamp        1 1000003      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (primary)
 4                 jmp       12      0      0
 5          cursor_idx        1      0      0
 6           timestamp        2 1000003      0
 7                  gt        3      1      2
 8                jntr       11      3      0
 9         cursor_read        1      0      0
10             set_add        0      1      0
11         cursor_next        0      5      0
12        cursor_close        0      0      0
13              result        0      0      0
14                 ret        0      0      0

"
select count(*) from test where id > timestamp '1970-01-01 00:00:01.000003'
[3]
select * from test where id = timestamp '1970-01-01 00:00:01.000003'
[["1970-01-01 00:00:01.000003Z"]]
explain select * from test where id = timestamp '1970-01-01 00:00:01.000003'
"
bytecode [coordinator]
--------
 0           send_hash        0      0      -      # public.test
 1                recv        0      0      0
 2                bool        0      0      0
 3                push        0      0      0
 4          merge_recv        0     -1     -1
 5             cte_set        0      0      0
 6                body        0      0      0
 7                 ret        0      0      0


bytecode [node]
--------
 0                 set        0      0      0
 1           timestamp        1 1000003      0
 2                push        1      0      0
 3         cursor_open        0      0      5      # public.test (i), lookup
 4                 jmp       12      0      0
 5          cursor_idx        1      0      0
 6           timestamp        2 1000003      0
 7                 equ        3      1      2
 8                jntr        4      3      0
 9         cursor_read        1      0      0
10             set_add        0      1      0
11         cursor_next        0      5      0
12        cursor_close        0      0      0
13              result        0      0      0
14                 ret        0      0      0

"
select count(*) from test where id = timestamp '1970-01-01 00:00:01.000003'
[1]
drop table test
disconnect S0
close E0
