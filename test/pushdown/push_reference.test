#

env_open E0 "cluster_shards": 3
connect E0 S0

# test: reference table create
create table test (id int primary key, data int default 0) reference
select *.name, *.reference from system.tables()

# test: reference has single storage
select sizeof(system.storages()) = 1

# test: reference has no shard id
select system.storages()[0].id.id_shard

# test: reference insert
explain insert into test (id) values (1), (2), (3)
insert into test (id) values (1), (2), (3)

# test: reference delete
explain delete from test
delete from test
select * from test

# test: reference update
insert into test (id) values (1), (2), (3)
explain update test set data = id
update test set data = id
select * from test

# test: reference upsert
explain insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
select * from test

# test: select from reference
delete from test
insert into test (id) values (1), (2), (3)

explain select * from test
select * from test

# test: select from (select from reference)
explain select * from (select * from test)
select * from (select * from test)

# test: select (select expr) from reference
explain select (select test.*) from test
select (select test.*) from test

# test: select (select from reference)
explain select (select * from test)
select (select * from test)

# test: select (select from reference) from expr
explain select (select a.*, * from test) from [1,2,3] a
select (select a.*, * from test) from [1,2,3] a

explain select (select a.*, id from test) from [1,2,3] a
select (select a.*, id from test) from [1,2,3] a

# test: select (select from reference) from reference
explain select (select a.*, id from test) from test a
select (select a.*, id from test) from test a

explain select (select a.id, id from test) from test a
select (select a.id, id from test) from test a

# test: select (select from reference) from (select from expr)
explain select (select a.*, id from test) from (select * from [1,2,3]) a
select (select a.*, id from test) from (select * from [1,2,3]) a

# test: select (select from reference) from (select from reference)
explain select (select a.*, id from test) from (select * from test t) a
select (select a.*, id from test) from (select * from test t) a

explain select (select a.*[0], id from test) from (select * from test t) a
select (select a.*[0], id from test) from (select * from test t) a

drop table test

disconnect S0
env_close E0
