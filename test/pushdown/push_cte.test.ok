open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
# test: cte parsing
with
{"msg": "WITH <name> expected"}
with 1
{"msg": "WITH <name> expected"}
with test
{"msg": "WITH name <AS> expected"}
with test 1
{"msg": "WITH name <AS> expected"}
with test as
{"msg": "WITH name AS <(> expected"}
with test as 1
{"msg": "WITH name AS <(> expected"}
with test (
{"msg": "WITH name (<name> expected"}
with test (1
{"msg": "WITH name (<name> expected"}
with test (name
{"msg": "WITH name (<)> expected"}
with test (name,
{"msg": "WITH name (<name> expected"}
with test (name,,
{"msg": "WITH name (<name> expected"}
with test (name,)
{"msg": "WITH name (<name> expected"}
with test (name,
{"msg": "WITH name (<name> expected"}
with test (name)
{"msg": "WITH name <AS> expected"}
with test as (
{"msg": "CTE statement must be DML or SELECT"}
# test: with () (no stmt)
with test as ()
{"msg": "unexpected statement"}
# test: with(select expr) (no main stmt)
with test as (select 1)
[1]
explain with test as (select 1)
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "content             0      -      -     ",
      "06": "ret                 0      0      0     "
    }
  }
}]
with test as (select 1,2,3)
[[1, 2, 3]]
explain with test as (select 1,2,3)
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      3      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "int                 1      -      0     # 2",
      "04": "push                1      0      0     ",
      "05": "int                 1      -      0     # 3",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "cte_set             0      0      0     ",
      "09": "content             0      -      -     ",
      "10": "ret                 0      0      0     "
    }
  }
}]
# test: with(select expr), select expr (cte not used)
with test as (select 1) select 2
[2]
# test: with(select expr), select * from cte
with a as (select 1) select * from a
[1]
with a as (select 1, 2) select * from a
[[1, 2]]
with a as (select 1, 2, 3) select * from a
[[1, 2, 3]]
# test: with(select expr as), select * from cte
with a as (select 1 as a) select * from a
[1]
with a as (select 1 as a, 2 as b) select * from a
[[1, 2]]
# test: with(select expr as), select column from cte
with a as (select 1 as a) select a from a
[1]
with a as (select 1 as a, 2 as b) select a, b from a
[[1, 2]]
# test: with(select expr as), select target.column from cte
with a as (select 1 as a, 2 as b) select a.a, a.b from a
[[1, 2]]
# test: with(select * from table) (no main stmt)
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test)
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test)
[1, 2, 3]
drop table test
# test: with(select * from table) select expr (cte not used)
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select 2
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "int                 1      -      0     # 2",
      "08": "push                1      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "cte_set             1      0      0     ",
      "11": "content             1      -      -     ",
      "12": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select 2
[2]
drop table test
# test: with(select * from table), select * from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select * from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select * from a
[1, 2, 3]
drop table test
# test: with(select * from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select id from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select id from a
[1, 2, 3]
drop table test
# test: with(select * from table), select target.column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select a.id from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select a.id from a
[1, 2, 3]
drop table test
# test: with(select column from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select id from test) select id from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select id from test) select id from a
[1, 2, 3]
drop table test
# test: with(select column as from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select id as x from test) select id from a
{"msg": "<a.id> column not found"}
explain with a as (select id as x from test) select x from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
with a as (select id as x from test) select x from a
[1, 2, 3]
drop table test
# test: with(select column, column from table), select * from cte (conflict)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select id, id from test) select * from a
{"msg": "<a.id> column name is ambiguous"}
with a as (select id, id as x from test) select * from a
[[1, 1], [2, 2], [3, 3]]
drop table test
# test: with(select * from shared table), select * from cte
create shared table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test) select * from a
[1, 2, 3]
explain with a as (select * from test) select * from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: with(select * from shared table), select * from shared table
create shared table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test) select * from test
[1, 2, 3]
explain with a as (select * from test) select * from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "send_first          1      9      0     ",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "cte_set             0      0      0     ",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: with(select * from table), select * from table
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test) select * from test
[1, 2, 3]
explain with a as (select * from test) select * from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "send_all            1      9      -     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "cte_set             0      0      0     ",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: with(select expr), select * from table join
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select [4,5,6]) select test.*, a.* from test, a
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "send_all            1      0      -     # public.test",
      "06": "recv                1      0      0     ",
      "07": "bool                0      0      0     ",
      "08": "push                0      0      0     ",
      "09": "union_recv          0      -1     -1    ",
      "10": "cte_set             1      0      0     ",
      "11": "content             1      -      -     ",
      "12": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      5      13    # public.test (primary)",
      "02": "cte_get             1      0      0     ",
      "03": "store_open          1      1      5     ",
      "04": "jmp                 11     0      0     ",
      "05": "table_readi32       2      0      0     ",
      "06": "push                2      0      0     ",
      "07": "store_read          2      1      0     ",
      "08": "push                2      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "store_next          1      5      0     ",
      "11": "store_close         1      1      0     ",
      "12": "table_next          0      2      0     ",
      "13": "table_close         0      0      0     ",
      "14": "result              0      0      0     ",
      "15": "ret                 0      0      0     "
    }
  }
}]
with a as (select [4,5,6]) select test.*, a.* from test, a
[[1, [4, 5, 6]], [2, [4, 5, 6]], [3, [4, 5, 6]]]
drop table test
# test: with(select expr), select * from shared table join
create shared table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select [4,5,6]) select test.*, a.* from test, a
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "send_first          1      0      0     ",
      "06": "recv                1      0      0     ",
      "07": "bool                0      0      0     ",
      "08": "push                0      0      0     ",
      "09": "union_recv          0      -1     -1    ",
      "10": "cte_set             1      0      0     ",
      "11": "content             1      -      -     ",
      "12": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      5      13    # public.test (primary)",
      "02": "cte_get             1      0      0     ",
      "03": "store_open          1      1      5     ",
      "04": "jmp                 11     0      0     ",
      "05": "table_readi32       2      0      0     ",
      "06": "push                2      0      0     ",
      "07": "store_read          2      1      0     ",
      "08": "push                2      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "store_next          1      5      0     ",
      "11": "store_close         1      1      0     ",
      "12": "table_next          0      2      0     ",
      "13": "table_close         0      0      0     ",
      "14": "result              0      0      0     ",
      "15": "ret                 0      0      0     "
    }
  }
}]
with a as (select [4,5,6]) select test.*, a.* from test, a
[[1, [4, 5, 6]], [2, [4, 5, 6]], [3, [4, 5, 6]]]
drop table test
# test: with(select * from table), select from table join
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select test.* from test join a on test.id = a.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_all            1      9      -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     24    # public.test (primary)",
      "11": "cte_get             1      0      0     ",
      "12": "store_open          1      1      14    ",
      "13": "jmp                 22     0      0     ",
      "14": "table_readi32       2      0      0     ",
      "15": "store_read          3      1      0     ",
      "16": "equii               4      2      3     ",
      "17": "jntr                21     4      0     ",
      "18": "table_readi32       2      0      0     ",
      "19": "push                2      0      0     ",
      "20": "set_add             0      0      0     ",
      "21": "store_next          1      14     0     ",
      "22": "store_close         1      1      0     ",
      "23": "table_next          0      11     0     ",
      "24": "table_close         0      0      0     ",
      "25": "result              0      0      0     ",
      "26": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select test.* from test join a on test.id = a.id
[1, 2, 3]
drop table test
# test: with(select string from table), select from table join
create table test (id int primary key, data string)
insert into test values (1, '1'),(2, '2'),(3, '3')
explain with a as (select data from test) select test.* from test join a on test.data = a.data
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_all            1      9      -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_reads         1      0      1     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      2      0     ",
      "10": "table_open          0      20     26    # public.test (primary)",
      "11": "cte_get             1      0      0     ",
      "12": "store_open          1      1      14    ",
      "13": "jmp                 24     0      0     ",
      "14": "table_reads         2      0      1     ",
      "15": "store_read          3      1      0     ",
      "16": "equss               4      2      3     ",
      "17": "jntr                23     4      0     ",
      "18": "table_readi32       2      0      0     ",
      "19": "push                2      0      0     ",
      "20": "table_reads         2      0      1     ",
      "21": "push                2      0      0     ",
      "22": "set_add             0      0      0     ",
      "23": "store_next          1      14     0     ",
      "24": "store_close         1      1      0     ",
      "25": "table_next          0      11     0     ",
      "26": "table_close         0      0      0     ",
      "27": "result              0      0      0     ",
      "28": "ret                 0      0      0     "
    }
  }
}]
with a as (select data from test) select test.* from test join a on test.data = a.data
[[1, "1"], [2, "2"], [3, "3"]]
drop table test
# test: with (columns) as (select expr), select * from cte
explain with z (a,b,c) as (select 4,5,6) select * from z
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      3      0     ",
      "01": "int                 1      -      0     # 4",
      "02": "push                1      0      0     ",
      "03": "int                 1      -      0     # 5",
      "04": "push                1      0      0     ",
      "05": "int                 1      -      0     # 6",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "cte_set             0      0      0     ",
      "09": "set                 0      3      0     ",
      "10": "cte_get             1      0      0     ",
      "11": "store_open          0      1      13    ",
      "12": "jmp                 21     0      0     ",
      "13": "store_read          2      0      0     ",
      "14": "push                2      0      0     ",
      "15": "store_read          2      0      1     ",
      "16": "push                2      0      0     ",
      "17": "store_read          2      0      2     ",
      "18": "push                2      0      0     ",
      "19": "set_add             0      0      0     ",
      "20": "store_next          0      13     0     ",
      "21": "store_close         0      1      0     ",
      "22": "cte_set             1      0      0     ",
      "23": "content             1      -      -     ",
      "24": "ret                 0      0      0     "
    }
  }
}]
with z (a,b,c) as (select 4,5,6) select * from z
[[4, 5, 6]]
# test: with (columns) as (select expr), select column from cte
with z (a,b,c) as (select 4,5,6) select a,b,c from z
[[4, 5, 6]]
# test: with (columns) as (select expr), select target.column from cte
with z (a,b,c) as (select 4,5,6) select z.a, z.b, z.c from z
[[4, 5, 6]]
# test: with (columns) as (select expr), select column from cte group by
with z as (select 4 as a,5,6) select a from z group by a
[4]
with z (a,b,c) as (select 4,5,6) select a from z group by a
[4]
# test: with (columns) as (select expr), select * from cte (redefined)
explain with z (a,a) as (select 4,5,6) select * from z
{"msg": "WITH name (<a> argument redefined"}
# test: a(table), b(a)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from a) select * from b
[1, 2, 3]
explain with a as (select * from test), b as (select * from a) select * from b
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "set                 0      1      0     ",
      "17": "cte_get             2      1      0     ",
      "18": "store_open          0      2      20    ",
      "19": "jmp                 24     0      0     ",
      "20": "store_read          3      0      0     ",
      "21": "push                3      0      0     ",
      "22": "set_add             0      0      0     ",
      "23": "store_next          0      20     0     ",
      "24": "store_close         0      1      0     ",
      "25": "cte_set             2      0      0     ",
      "26": "content             2      -      -     ",
      "27": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(table), b(expr), c(a)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c
[1, 2, 3]
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "json                1      20     0     ",
      "08": "push                1      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "cte_set             1      0      0     ",
      "11": "set                 0      1      0     ",
      "12": "cte_get             1      0      0     ",
      "13": "store_open          0      1      15    ",
      "14": "jmp                 19     0      0     ",
      "15": "store_read          2      0      0     ",
      "16": "push                2      0      0     ",
      "17": "set_add             0      0      0     ",
      "18": "store_next          0      15     0     ",
      "19": "store_close         0      1      0     ",
      "20": "cte_set             2      0      0     ",
      "21": "set                 0      1      0     ",
      "22": "cte_get             2      2      0     ",
      "23": "store_open          0      2      25    ",
      "24": "jmp                 29     0      0     ",
      "25": "store_read          3      0      0     ",
      "26": "push                3      0      0     ",
      "27": "set_add             0      0      0     ",
      "28": "store_next          0      25     0     ",
      "29": "store_close         0      1      0     ",
      "30": "cte_set             3      0      0     ",
      "31": "content             3      -      -     ",
      "32": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(table), b(expr), c(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c
[1, 2, 3]
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "json                1      20     0     ",
      "08": "push                1      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "cte_set             1      0      0     ",
      "11": "send_all            2      9      -     # public.test",
      "12": "recv                2      0      0     ",
      "13": "bool                0      0      0     ",
      "14": "push                0      0      0     ",
      "15": "union_recv          0      -1     -1    ",
      "16": "cte_set             2      0      0     ",
      "17": "set                 0      1      0     ",
      "18": "cte_get             1      2      0     ",
      "19": "store_open          0      1      21    ",
      "20": "jmp                 25     0      0     ",
      "21": "store_read          2      0      0     ",
      "22": "push                2      0      0     ",
      "23": "set_add             0      0      0     ",
      "24": "store_next          0      21     0     ",
      "25": "store_close         0      1      0     ",
      "26": "cte_set             3      0      0     ",
      "27": "content             3      -      -     ",
      "28": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      25     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(table), b(table), c(expr)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c
[[1, 2, 3]]
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "send_all            1      9      -     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "cte_set             0      0      0     ",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "set                 0      1      0     ",
      "13": "json                1      40     0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "cte_set             2      0      0     ",
      "17": "set                 0      1      0     ",
      "18": "cte_get             1      2      0     ",
      "19": "store_open          0      1      21    ",
      "20": "jmp                 25     0      0     ",
      "21": "store_read          2      0      0     ",
      "22": "push                2      0      0     ",
      "23": "set_add             0      0      0     ",
      "24": "store_next          0      21     0     ",
      "25": "store_close         0      1      0     ",
      "26": "cte_set             3      0      0     ",
      "27": "content             3      -      -     ",
      "28": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(table), b(table), c(expr), d(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d
[1, 2, 3]
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "send_all            1      9      -     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "cte_set             0      0      0     ",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "set                 0      1      0     ",
      "13": "json                1      40     0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "cte_set             2      0      0     ",
      "17": "send_all            3      18     -     # public.test",
      "18": "recv                3      0      0     ",
      "19": "bool                0      0      0     ",
      "20": "push                0      0      0     ",
      "21": "union_recv          0      -1     -1    ",
      "22": "cte_set             3      0      0     ",
      "23": "set                 0      1      0     ",
      "24": "cte_get             1      3      0     ",
      "25": "store_open          0      1      27    ",
      "26": "jmp                 31     0      0     ",
      "27": "store_read          2      0      0     ",
      "28": "push                2      0      0     ",
      "29": "set_add             0      0      0     ",
      "30": "store_next          0      27     0     ",
      "31": "store_close         0      1      0     ",
      "32": "cte_set             4      0      0     ",
      "33": "content             4      -      -     ",
      "34": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     ",
      "18": "set                 0      1      0     ",
      "19": "table_open          0      45     24    # public.test (primary)",
      "20": "table_readi32       1      0      0     ",
      "21": "push                1      0      0     ",
      "22": "set_add             0      0      0     ",
      "23": "table_next          0      20     0     ",
      "24": "table_close         0      0      0     ",
      "25": "result              0      0      0     ",
      "26": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(expr), b(table), c(expr)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c
[[1, [1, 2, 3]], [2, [1, 2, 3]], [3, [1, 2, 3]]]
explain with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "send_all            1      0      -     # public.test",
      "06": "recv                1      0      0     ",
      "07": "bool                0      0      0     ",
      "08": "push                0      0      0     ",
      "09": "union_recv          0      -1     -1    ",
      "10": "cte_set             1      0      0     ",
      "11": "set                 0      1      0     ",
      "12": "json                1      25     0     ",
      "13": "push                1      0      0     ",
      "14": "set_add             0      0      0     ",
      "15": "cte_set             2      0      0     ",
      "16": "set                 0      2      0     ",
      "17": "cte_get             1      1      0     ",
      "18": "store_open          0      1      20    ",
      "19": "jmp                 31     0      0     ",
      "20": "cte_get             2      2      0     ",
      "21": "store_open          1      2      23    ",
      "22": "jmp                 29     0      0     ",
      "23": "store_read          3      0      0     ",
      "24": "push                3      0      0     ",
      "25": "store_read          3      1      0     ",
      "26": "push                3      0      0     ",
      "27": "set_add             0      0      0     ",
      "28": "store_next          1      23     0     ",
      "29": "store_close         1      1      0     ",
      "30": "store_next          0      20     0     ",
      "31": "store_close         0      1      0     ",
      "32": "cte_set             3      0      0     ",
      "33": "content             3      -      -     ",
      "34": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      5      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(expr), b(table), c(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c
[1, 2, 3]
explain with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "send_all            1      0      -     # public.test",
      "06": "send_all            2      9      -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "union_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "recv                2      0      0     ",
      "13": "bool                0      0      0     ",
      "14": "push                0      0      0     ",
      "15": "union_recv          0      -1     -1    ",
      "16": "cte_set             2      0      0     ",
      "17": "set                 0      1      0     ",
      "18": "cte_get             1      2      0     ",
      "19": "store_open          0      1      21    ",
      "20": "jmp                 25     0      0     ",
      "21": "store_read          2      0      0     ",
      "22": "push                2      0      0     ",
      "23": "set_add             0      0      0     ",
      "24": "store_next          0      21     0     ",
      "25": "store_close         0      1      0     ",
      "26": "cte_set             3      0      0     ",
      "27": "content             3      -      -     ",
      "28": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      5      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      25     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(table), b(a), c(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[1, 2, 3]
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "send_all            2      9      -     # public.test",
      "17": "recv                2      0      0     ",
      "18": "bool                0      0      0     ",
      "19": "push                0      0      0     ",
      "20": "union_recv          0      -1     -1    ",
      "21": "cte_set             2      0      0     ",
      "22": "set                 0      1      0     ",
      "23": "cte_get             2      2      0     ",
      "24": "store_open          0      2      26    ",
      "25": "jmp                 30     0      0     ",
      "26": "store_read          3      0      0     ",
      "27": "push                3      0      0     ",
      "28": "set_add             0      0      0     ",
      "29": "store_next          0      26     0     ",
      "30": "store_close         0      1      0     ",
      "31": "cte_set             3      0      0     ",
      "32": "content             3      -      -     ",
      "33": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     15    # public.test (primary)",
      "11": "table_readi32       2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
create shared table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[1, 2, 3]
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      1      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 14     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "store_next          0      10     0     ",
      "14": "store_close         0      1      0     ",
      "15": "cte_set             1      0      0     ",
      "16": "send_first          2      9      0     ",
      "17": "recv                2      0      0     ",
      "18": "bool                0      0      0     ",
      "19": "push                0      0      0     ",
      "20": "union_recv          0      -1     -1    ",
      "21": "cte_set             2      0      0     ",
      "22": "set                 0      1      0     ",
      "23": "cte_get             2      2      0     ",
      "24": "store_open          0      2      26    ",
      "25": "jmp                 30     0      0     ",
      "26": "store_read          3      0      0     ",
      "27": "push                3      0      0     ",
      "28": "set_add             0      0      0     ",
      "29": "store_next          0      26     0     ",
      "30": "store_close         0      1      0     ",
      "31": "cte_set             3      0      0     ",
      "32": "content             3      -      -     ",
      "33": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open          0      20     15    # public.test (primary)",
      "11": "table_readi32       2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: a(expr), stmt, b(expr), stmt
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [1,2,3]); select * from a; with b as (select * from test); select b.*, a.* from b,a
[[1, [1, 2, 3]], [2, [1, 2, 3]], [3, [1, 2, 3]]]
drop table test
# test: a(expr), a(expr) (cte redefined)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [4,5,6]); with a as (select * from test); select * from a
{"msg": "CTE <a> redefined"}
drop table test
# test: with(insert returning), select * from cte
create shared table test (id int primary key, data int)
with a as (insert into test values (2, 0) returning *); select * from a
[[2, 0]]
explain with a as (insert into test values (2, 0) returning *); select * from a
[{
  "bytecode": {
    "coordinator": {
      "00": "set_ptr             0      -      0     ",
      "01": "send                0      0      -     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "cte_set             0      0      0     ",
      "07": "set                 0      2      0     ",
      "08": "cte_get             1      0      0     ",
      "09": "store_open          0      1      11    ",
      "10": "jmp                 17     0      0     ",
      "11": "store_read          2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "store_read          2      0      1     ",
      "14": "push                2      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "store_next          0      11     0     ",
      "17": "store_close         0      1      0     ",
      "18": "cte_set             1      0      0     ",
      "19": "content             1      -      -     ",
      "20": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_prepare       0      -      0     # public.test",
      "02": "jmp                 11     0      0     ",
      "03": "string              1      0      0     # unique key constraint violation",
      "04": "push                1      0      0     ",
      "05": "call                1      -      1     # public.error()",
      "06": "table_readi32       1      0      0     ",
      "07": "push                1      0      0     ",
      "08": "table_readi32       1      0      1     ",
      "09": "push                1      0      0     ",
      "10": "set_add             0      0      0     ",
      "11": "upsert              0      3      6     ",
      "12": "table_close         0      0      0     ",
      "13": "result              0      0      0     ",
      "14": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: with(update returning), select * from cte
create shared table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
with a as (update test set data = data + 1 returning *) select * from a
[[0, 1], [1, 1], [2, 1]]
explain with a as (update test set data = data + 1 returning *) select * from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      2      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 16     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "store_read          2      0      1     ",
      "13": "push                2      0      0     ",
      "14": "set_add             0      0      0     ",
      "15": "store_next          0      10     0     ",
      "16": "store_close         0      1      0     ",
      "17": "cte_set             1      0      0     ",
      "18": "content             1      -      -     ",
      "19": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      15    # public.test (primary)",
      "02": "int                 1      -      0     # 1",
      "03": "push                1      0      0     ",
      "04": "table_readi32       1      0      1     ",
      "05": "int                 2      -      0     # 1",
      "06": "addii               3      1      2     ",
      "07": "push                3      0      0     ",
      "08": "update              0      1      0     ",
      "09": "table_readi32       1      0      0     ",
      "10": "push                1      0      0     ",
      "11": "table_readi32       1      0      1     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      2      0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
drop table test
# test: with(delete returning), select * from cte
create shared table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
with a as (delete from test returning *) select * from a
[[0, 0], [1, 0], [2, 0]]
explain with a as (delete from test returning *) select * from a
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "set                 0      2      0     ",
      "07": "cte_get             1      0      0     ",
      "08": "store_open          0      1      10    ",
      "09": "jmp                 16     0      0     ",
      "10": "store_read          2      0      0     ",
      "11": "push                2      0      0     ",
      "12": "store_read          2      0      1     ",
      "13": "push                2      0      0     ",
      "14": "set_add             0      0      0     ",
      "15": "store_next          0      10     0     ",
      "16": "store_close         0      1      0     ",
      "17": "cte_set             1      0      0     ",
      "18": "content             1      -      -     ",
      "19": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      9     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "table_readi32       1      0      1     ",
      "05": "push                1      0      0     ",
      "06": "set_add             0      0      0     ",
      "07": "delete              0      0      0     ",
      "08": "table_next          0      2      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
drop table test
disconnect S0
close E0
