open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
# test: select from table
create table test (id int primary key, data int default 0)
insert into test (id) values (1), (2), (3)
explain select * from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 11     0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "table_readi32       1      0      1     ",
      "08": "push                1      0      0     ",
      "09": "set_add             0      0      0     ",
      "10": "table_next          0      5      0     ",
      "11": "table_close         0      0      0     ",
      "12": "result              0      0      0     ",
      "13": "ret                 0      0      0     "
    }
  }
}]
select * from test
[[1, 0], [2, 0], [3, 0]]
# test: select from table where
explain select * from test where id > 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 15     0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "int                 2      -      0     # 1",
      "07": "gtii                3      1      2     ",
      "08": "jntr                14     3      0     ",
      "09": "table_readi32       1      0      0     ",
      "10": "push                1      0      0     ",
      "11": "table_readi32       1      0      1     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      5      0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
select * from test where id > 1
[[2, 0], [3, 0]]
select * from test where id > 2
[[3, 0]]
select * from test where id > 3
[]
# test: select from table where point lookup
explain select * from test where id = 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_hash           0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary, lookup)",
      "04": "jmp                 15     0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "int                 2      -      0     # 1",
      "07": "equii               3      1      2     ",
      "08": "jntr                4      3      0     ",
      "09": "table_readi32       1      0      0     ",
      "10": "push                1      0      0     ",
      "11": "table_readi32       1      0      1     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "jmp                 4      0      0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
select * from test where id = 1
[[1, 0]]
select * from test where id = 2
[[2, 0]]
select * from test where id = 3
[[3, 0]]
select * from test where id = 4
[]
select * from test where id = 0
[]
# test: select (select expr) from table
explain select (select test.*) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 14     0      0     ",
      "05": "set                 1      2      0     ",
      "06": "table_readi32       2      0      0     ",
      "07": "push                2      0      0     ",
      "08": "table_readi32       2      0      1     ",
      "09": "push                2      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "push                1      0      0     ",
      "12": "set_add             0      0      0     ",
      "13": "table_next          0      5      0     ",
      "14": "table_close         0      0      0     ",
      "15": "result              0      0      0     ",
      "16": "ret                 0      0      0     "
    }
  }
}]
select (select test.*) from test
[[[1, 0]], [[2, 0]], [[3, 0]]]
# test: select (select (select expr)) from table
explain select (select (select (test.*))) from test
{"msg": "bad expression"}
select (select (select (test.*))) from test
{"msg": "bad expression"}
explain select (select (select test.*)) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 17     0      0     ",
      "05": "set                 1      1      0     ",
      "06": "set                 2      2      0     ",
      "07": "table_readi32       3      0      0     ",
      "08": "push                3      0      0     ",
      "09": "table_readi32       3      0      1     ",
      "10": "push                3      0      0     ",
      "11": "set_add             2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "set_add             1      0      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "table_next          0      5      0     ",
      "17": "table_close         0      0      0     ",
      "18": "result              0      0      0     ",
      "19": "ret                 0      0      0     "
    }
  }
}]
select (select (select test.*)) from test
[[[[1, 0]]], [[[2, 0]]], [[[3, 0]]]]
# test: select (select (select from table)) from table
explain select (select (select * from test t)) from test
{"msg": "subqueries to distributed tables are not supported"}
# test: select (select (select from shared)) from table
create shared table ref (id int primary key, data int default 0)
insert into ref (id) values (1), (2), (3)
explain select (select (select * from ref)) from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          1      0      5     # public.test (primary)",
      "04": "jmp                 23     0      0     ",
      "05": "set                 1      1      0     ",
      "06": "set                 2      2      0     ",
      "07": "int                 3      -      0     # -2147483648",
      "08": "push                3      0      0     ",
      "09": "table_open          0      20     11    # public.ref (primary)",
      "10": "jmp                 17     0      0     ",
      "11": "table_readi32       3      0      0     ",
      "12": "push                3      0      0     ",
      "13": "table_readi32       3      0      1     ",
      "14": "push                3      0      0     ",
      "15": "set_add             2      0      0     ",
      "16": "table_next          0      11     0     ",
      "17": "table_close         0      0      0     ",
      "18": "push                2      0      0     ",
      "19": "set_add             1      0      0     ",
      "20": "push                1      0      0     ",
      "21": "set_add             0      0      0     ",
      "22": "table_next          1      5      0     ",
      "23": "table_close         1      0      0     ",
      "24": "result              0      0      0     ",
      "25": "ret                 0      0      0     "
    }
  }
}]
select (select (select * from ref)) from test
[[[[1, 0], [2, 0], [3, 0]]], [[[1, 0], [2, 0], [3, 0]]], [[[1, 0], [2, 0], [3, 0]]]]
# test: select from table where (select from table)
explain select * from test where (select * from test t)
{"msg": "subqueries to distributed tables are not supported"}
# test: select from table where (select from shared)
explain select * from test where (select * from ref)
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 24     0      0     ",
      "05": "set                 1      2      0     ",
      "06": "int                 2      -      0     # -2147483648",
      "07": "push                2      0      0     ",
      "08": "table_open          1      20     10    # public.ref (primary)",
      "09": "jmp                 16     0      0     ",
      "10": "table_readi32       2      1      0     ",
      "11": "push                2      0      0     ",
      "12": "table_readi32       2      1      1     ",
      "13": "push                2      0      0     ",
      "14": "set_add             1      0      0     ",
      "15": "table_next          1      10     0     ",
      "16": "table_close         1      0      0     ",
      "17": "jntr                23     1      0     ",
      "18": "table_readi32       1      0      0     ",
      "19": "push                1      0      0     ",
      "20": "table_readi32       1      0      1     ",
      "21": "push                1      0      0     ",
      "22": "set_add             0      0      0     ",
      "23": "table_next          0      5      0     ",
      "24": "table_close         0      0      0     ",
      "25": "result              0      0      0     ",
      "26": "ret                 0      0      0     "
    }
  }
}]
select * from test where (select * from ref)
[[1, 0], [2, 0], [3, 0]]
# test: select from table where exists (select from shared)
select * from test where exists (select 1 from ref where test.id = ref.id)
[[1, 0], [2, 0], [3, 0]]
drop table ref
drop table test
disconnect S0
close E0
