env_open E0 "cluster_shards": 3
connect E0 S0
connect: on_connect
# test: abort
explain abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                 ret        0      0      0


bytecode [shard 0]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 1]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 2]
--------
 0               abort        0      0      0
 1                 ret        0      0      0

"
abort
query: on_error
{"code": 1, "msg": "aborted"}
# test: insert abort by error
create table test (id int primary key, data int default 0)
insert into test (id) values (0), (1), (2), (3), (1)
query: on_error
{"code": 1, "msg": "unique key constraint violation"}
select * from test
# test: insert abort by error #2
insert into test (id) values (0), (1), (2), (3)
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: insert abort by error #3
insert into test (id) values (4), (5), (1), (6)
query: on_error
{"code": 1, "msg": "unique key constraint violation"}
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: insert abort by error #4
insert into test (id) values (4), (5), (1), (6); abort
query: on_error
{"code": 1, "msg": "unique key constraint violation"}
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: replace abort
explain replace into test values (0, 1), (1, 1), (2, 1), (3, 1); abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0              insert        -      0      3      # test
 1              insert        -      9      3      # test
 2               ready        0     -1      0
 3               abort        0      0      0
 4                 ret        0      0      0


bytecode [shard 1]
--------
 0              insert        -      6      3      # test
 1               ready        0     -1      0
 2               abort        0      0      0
 3                 ret        0      0      0


bytecode [shard 2]
--------
 0              insert        -      3      3      # test
 1               ready        0     -1      0
 2               abort        0      0      0
 3                 ret        0      0      0

"
replace into test values (0, 1), (1, 1), (2, 1), (3, 1); abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: delete abort
explain delete from test; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp        6      0      0
 4              delete        0      0      0
 5         cursor_next        0      4      0
 6        cursor_close        0      0      0
 7               ready        0     -1      0
 8               abort        0      0      0
 9                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp        6      0      0
 4              delete        0      0      0
 5         cursor_next        0      4      0
 6        cursor_close        0      0      0
 7               ready        0     -1      0
 8               abort        0      0      0
 9                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp        6      0      0
 4              delete        0      0      0
 5         cursor_next        0      4      0
 6        cursor_close        0      0      0
 7               ready        0     -1      0
 8               abort        0      0      0
 9                 ret        0      0      0

"
delete from test; abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: update abort
explain update test set data = id; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16               abort        0      0      0
17                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16               abort        0      0      0
17                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16               abort        0      0      0
17                 ret        0      0      0

"
update test set data = id; abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: upsert abort
explain insert into test values(1, 0) on conflict do update set data = id; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 1]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 2]
--------
 0      cursor_prepare        0      -      0      # public.test
 1                 jmp       12      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      0
 7                push        0      0      0
 8              assign        0      3      1
 9                push        0      0      0
10              update        0      0      0
11             jmp_pop        0      0      0
12              upsert        0      0      3
13        cursor_close        0      0      0
14               ready        0     -1      0
15               abort        0      0      0
16                 ret        0      0      0

"
insert into test values(1, 0) on conflict do update set data = id; abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[2, 0]
[1, 0]
[3, 0]
drop table test
# test: reference insert abort by error
create table test (id int primary key, data int default 0) reference
insert into test (id) values (0), (1), (2), (3), (1)
query: on_error
{"code": 1, "msg": "unique key constraint violation"}
select * from test
# test: reference insert abort by error #2
insert into test (id) values (0), (1), (2), (3)
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
# test: reference insert abort by error #3
insert into test (id) values (4), (5), (1), (6)
query: on_error
{"code": 1, "msg": "unique key constraint violation"}
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
# test: reference insert abort by error #4
insert into test (id) values (4), (5), (1), (6); abort
query: on_error
{"code": 1, "msg": "unique key constraint violation"}
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
# test: reference replace abort
explain replace into test values (0, 1), (1, 1), (2, 1), (3, 1); abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0              insert        -      0      3      # test
 1              insert        -      3      3      # test
 2              insert        -      6      3      # test
 3              insert        -      9      3      # test
 4               ready        0     -1      0
 5               abort        0      0      0
 6                 ret        0      0      0


bytecode [shard 1]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 2]
--------
 0               abort        0      0      0
 1                 ret        0      0      0

"
replace into test values (0, 1), (1, 1), (2, 1), (3, 1); abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
# test: reference delete abort
explain delete from test; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp        6      0      0
 4              delete        0      0      0
 5         cursor_next        0      4      0
 6        cursor_close        0      0      0
 7               ready        0     -1      0
 8               abort        0      0      0
 9                 ret        0      0      0


bytecode [shard 1]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 2]
--------
 0               abort        0      0      0
 1                 ret        0      0      0

"
delete from test; abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
# test: reference update abort
explain update test set data = id; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16               abort        0      0      0
17                 ret        0      0      0


bytecode [shard 1]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 2]
--------
 0               abort        0      0      0
 1                 ret        0      0      0

"
update test set data = id; abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
# test: reference upsert abort
explain insert into test values(1, 0) on conflict do update set data = id; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0      cursor_prepare        0      -      0      # public.test
 1                 jmp       12      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      0
 7                push        0      0      0
 8              assign        0      3      1
 9                push        0      0      0
10              update        0      0      0
11             jmp_pop        0      0      0
12              upsert        0      0      3
13        cursor_close        0      0      0
14               ready        0     -1      0
15               abort        0      0      0
16                 ret        0      0      0


bytecode [shard 1]
--------
 0               abort        0      0      0
 1                 ret        0      0      0


bytecode [shard 2]
--------
 0               abort        0      0      0
 1                 ret        0      0      0

"
insert into test values(1, 0) on conflict do update set data = id; abort
query: on_error
{"code": 1, "msg": "aborted"}
select * from test
[0, 0]
[1, 0]
[2, 0]
[3, 0]
drop table test
disconnect S0
env_close E0
