open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 127.0.0.1:3485
# test: cte parsing
with
{"msg": "with ⟵ name expected"}
with 1
{"msg": "with ❰1❱ ⟵ name expected"}
with test
{"msg": "with test ⟵ AS expected"}
with test 1
{"msg": "with test ❰1❱ ⟵ AS expected"}
with test as
{"msg": "with test as ⟵ ( expected"}
with test as 1
{"msg": "with test as ❰1❱ ⟵ ( expected"}
with test (
{"msg": "with test ( ⟵ name expected"}
with test (1
{"msg": "with test (❰1❱ ⟵ name expected"}
with test (name
{"msg": "with test (name ⟵ ) expected"}
with test (name,
{"msg": "with test (name, ⟵ name expected"}
with test (name,,
{"msg": "with test (name,❰,❱ ⟵ name expected"}
with test (name,)
{"msg": "with test (name,❰)❱ ⟵ name expected"}
with test (name,
{"msg": "with test (name, ⟵ name expected"}
with test (name)
{"msg": "with test (name) ⟵ AS expected"}
with test as (
{"msg": "with test as ( ⟵ unexpected end of statement"}
# test: with () (no stmt)
with test as ()
{"msg": "with test as () ⟵ unexpected statement"}
# test: with(select expr) (no main stmt)
with test as (select 1)
{"msg": "with test as (select 1) ⟵ statement expected"}
# test: with(select expr), select expr (cte not used)
with test as (select 1) select 2
[2]
# test: with(select expr), select * from cte
with a as (select 1) select * from a
[1]
with a as (select 1, 2) select * from a
[[1, 2]]
with a as (select 1, 2, 3) select * from a
[[1, 2, 3]]
# test: with(select expr as), select * from cte
with a as (select 1 as a) select * from a
[1]
with a as (select 1 as a, 2 as b) select * from a
[[1, 2]]
# test: with(select expr as), select column from cte
with a as (select 1 as a) select a from a
[1]
with a as (select 1 as a, 2 as b) select a, b from a
[[1, 2]]
# test: with(select expr as), select target.column from cte
with a as (select 1 as a, 2 as b) select a.a, a.b from a
[[1, 2]]
# test: with(select * from table) select expr (cte not used)
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select 2
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "int                 2      -      0     # 2",
      "07": "push                2      0      0     ",
      "08": "set_add             1      0      0     ",
      "09": "content             1      -      -     ",
      "10": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select 2
[2]
drop table test
# test: with(select * from table), select * from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select * from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "content             1      -      -     ",
      "14": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select * from a
[1, 3, 2]
drop table test
# test: with(select * from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select id from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "content             1      -      -     ",
      "14": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select id from a
[1, 3, 2]
drop table test
# test: with(select * from table), select target.column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select a.id from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "content             1      -      -     ",
      "14": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select a.id from a
[1, 3, 2]
drop table test
# test: with(select column from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select id from test) select id from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "content             1      -      -     ",
      "14": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select id from test) select id from a
[1, 3, 2]
drop table test
# test: with(select column as from table), select column from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select id as x from test) select id from a
{"msg": "explain with a as (select id as x from test) select ❰id❱ ⟵ column a.id not found"}
explain with a as (select id as x from test) select x from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "content             1      -      -     ",
      "14": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select id as x from test) select x from a
[1, 3, 2]
drop table test
# test: with(select column, column from table), select * from cte (conflict)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select id, id from test) select * from a
{"msg": "with a as (select id, id from test) select ❰*❱ ⟵ column a.id is ambiguous"}
with a as (select id, id as x from test) select * from a
[[1, 1], [3, 3], [2, 2]]
drop table test
# test: with(select * from table), select * from cte
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test) select * from a
[1, 3, 2]
explain with a as (select * from test) select * from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "content             1      -      -     ",
      "14": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: with(select * from table), select * from table
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test) select * from test
[1, 3, 2]
explain with a as (select * from test) select * from test
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "send_all            9      -      0     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "content             1      -      -     ",
      "11": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open_part     0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: with(select * from table), select * from table
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test) select * from test
[1, 3, 2]
explain with a as (select * from test) select * from test
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "send_all            9      -      0     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "content             1      -      -     ",
      "11": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open_part     0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: with(select expr), select * from table join
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select [4,5,6]) select test.*, a.* from test, a
[{
  "bytecode": {
    "frontend": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "send_all            0      -      0     # public.test",
      "05": "recv                0      0      0     ",
      "06": "bool                1      0      0     ",
      "07": "push                1      0      0     ",
      "08": "union_recv          1      -1     -1    ",
      "09": "content             1      -      -     ",
      "10": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      2      0     ",
      "01": "table_open_part     0      5      12    # public.test (primary)",
      "02": "ref                 2      0      0     ",
      "03": "store_open          1      2      10    ",
      "04": "table_readi32       3      0      0     ",
      "05": "push                3      0      0     ",
      "06": "store_read          3      1      0     ",
      "07": "push                3      0      0     ",
      "08": "set_add             1      0      0     ",
      "09": "store_next          1      4      0     ",
      "10": "store_close         1      1      0     ",
      "11": "table_next          0      2      0     ",
      "12": "table_close         0      0      0     ",
      "13": "result              1      0      0     ",
      "14": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select [4,5,6]) select test.*, a.* from test, a
[[1, [4, 5, 6]], [3, [4, 5, 6]], [2, [4, 5, 6]]]
drop table test
# test: with(select expr), select * from table join
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select [4,5,6]) select test.*, a.* from test, a
[{
  "bytecode": {
    "frontend": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "send_all            0      -      0     # public.test",
      "05": "recv                0      0      0     ",
      "06": "bool                1      0      0     ",
      "07": "push                1      0      0     ",
      "08": "union_recv          1      -1     -1    ",
      "09": "content             1      -      -     ",
      "10": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      2      0     ",
      "01": "table_open_part     0      5      12    # public.test (primary)",
      "02": "ref                 2      0      0     ",
      "03": "store_open          1      2      10    ",
      "04": "table_readi32       3      0      0     ",
      "05": "push                3      0      0     ",
      "06": "store_read          3      1      0     ",
      "07": "push                3      0      0     ",
      "08": "set_add             1      0      0     ",
      "09": "store_next          1      4      0     ",
      "10": "store_close         1      1      0     ",
      "11": "table_next          0      2      0     ",
      "12": "table_close         0      0      0     ",
      "13": "result              1      0      0     ",
      "14": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select [4,5,6]) select test.*, a.* from test, a
[[1, [4, 5, 6]], [3, [4, 5, 6]], [2, [4, 5, 6]]]
drop table test
# test: with(select * from table), select from table join
create table test (id int primary key)
insert into test values (1),(2),(3)
explain with a as (select * from test) select test.* from test join a on test.id = a.id
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "send_all            9      -      0     # public.test",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "content             1      -      -     ",
      "11": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 1      1      0     ",
      "10": "table_open_part     0      20     23    # public.test (primary)",
      "11": "ref                 2      0      0     ",
      "12": "store_open          1      2      21    ",
      "13": "table_readi32       3      0      0     ",
      "14": "store_read          4      1      0     ",
      "15": "equii               5      3      4     ",
      "16": "jntr                20     5      0     ",
      "17": "table_readi32       3      0      0     ",
      "18": "push                3      0      0     ",
      "19": "set_add             1      0      0     ",
      "20": "store_next          1      13     0     ",
      "21": "store_close         1      1      0     ",
      "22": "table_next          0      11     0     ",
      "23": "table_close         0      0      0     ",
      "24": "result              1      0      0     ",
      "25": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select * from test) select test.* from test join a on test.id = a.id
[1, 3, 2]
drop table test
# test: with(select string from table), select from table join
create table test (id int primary key, data string)
insert into test values (1, '1'),(2, '2'),(3, '3')
explain with a as (select data from test) select test.* from test join a on test.data = a.data
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "send_all            9      -      0     # public.test",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "content             1      -      -     ",
      "11": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_reads         1      0      1     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 1      2      0     ",
      "10": "table_open_part     0      20     25    # public.test (primary)",
      "11": "ref                 2      0      0     ",
      "12": "store_open          1      2      23    ",
      "13": "table_reads         3      0      1     ",
      "14": "store_read          4      1      0     ",
      "15": "equss               5      3      4     ",
      "16": "jntr                22     5      0     ",
      "17": "table_readi32       3      0      0     ",
      "18": "push                3      0      0     ",
      "19": "table_reads         3      0      1     ",
      "20": "push                3      0      0     ",
      "21": "set_add             1      0      0     ",
      "22": "store_next          1      13     0     ",
      "23": "store_close         1      1      0     ",
      "24": "table_next          0      11     0     ",
      "25": "table_close         0      0      0     ",
      "26": "result              1      0      0     ",
      "27": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
with a as (select data from test) select test.* from test join a on test.data = a.data
[[1, "1"], [3, "3"], [2, "2"]]
drop table test
# test: with (columns) as (select expr), select * from cte
explain with z (a,b,c) as (select 4,5,6) select * from z
[{
  "bytecode": {
    "frontend": {
      "00": "set                 0      3      0     ",
      "01": "int                 1      -      0     # 4",
      "02": "push                1      0      0     ",
      "03": "int                 1      -      0     # 5",
      "04": "push                1      0      0     ",
      "05": "int                 1      -      0     # 6",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "set                 1      3      0     ",
      "09": "ref                 2      0      0     ",
      "10": "store_open          0      2      19    ",
      "11": "store_read          3      0      0     ",
      "12": "push                3      0      0     ",
      "13": "store_read          3      0      1     ",
      "14": "push                3      0      0     ",
      "15": "store_read          3      0      2     ",
      "16": "push                3      0      0     ",
      "17": "set_add             1      0      0     ",
      "18": "store_next          0      11     0     ",
      "19": "store_close         0      1      0     ",
      "20": "content             1      -      -     ",
      "21": "ret                 0      0      0     "
    }
  },
  "access": []
}]
with z (a,b,c) as (select 4,5,6) select * from z
[[4, 5, 6]]
# test: with (columns) as (select expr), select column from cte
with z (a,b,c) as (select 4,5,6) select a,b,c from z
[[4, 5, 6]]
# test: with (columns) as (select expr), select target.column from cte
with z (a,b,c) as (select 4,5,6) select z.a, z.b, z.c from z
[[4, 5, 6]]
# test: with (columns) as (select expr), select column from cte group by
with z as (select 4 as a,5,6) select a from z group by a
[4]
with z (a,b,c) as (select 4,5,6) select a from z group by a
[4]
# test: with (columns) as (select expr), select * from cte (redefined)
explain with z (a,a) as (select 4,5,6) select * from z
{"msg": "explain with z (a,❰a❱ ⟵ argument redefined"}
# test: a(table), b(a)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from a) select * from b
[1, 3, 2]
explain with a as (select * from test), b as (select * from a) select * from b
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "set                 3      1      0     ",
      "14": "ref                 4      1      0     ",
      "15": "store_open          0      4      20    ",
      "16": "store_read          5      0      0     ",
      "17": "push                5      0      0     ",
      "18": "set_add             3      0      0     ",
      "19": "store_next          0      16     0     ",
      "20": "store_close         0      1      0     ",
      "21": "content             3      -      -     ",
      "22": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(table), b(expr), c(a)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c
[1, 3, 2]
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from a) select * from c
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "json                2      20     0     ",
      "07": "push                2      0      0     ",
      "08": "set_add             1      0      0     ",
      "09": "set                 2      1      0     ",
      "10": "ref                 3      0      0     ",
      "11": "store_open          0      3      16    ",
      "12": "store_read          4      0      0     ",
      "13": "push                4      0      0     ",
      "14": "set_add             2      0      0     ",
      "15": "store_next          0      12     0     ",
      "16": "store_close         0      1      0     ",
      "17": "set                 4      1      0     ",
      "18": "ref                 5      2      0     ",
      "19": "store_open          0      5      24    ",
      "20": "store_read          6      0      0     ",
      "21": "push                6      0      0     ",
      "22": "set_add             4      0      0     ",
      "23": "store_next          0      20     0     ",
      "24": "store_close         0      1      0     ",
      "25": "content             4      -      -     ",
      "26": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(table), b(expr), c(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c
[1, 3, 2]
explain with a as (select * from test), b as (select [1,2,3]), c as (select * from test) select * from c
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "json                2      20     0     ",
      "07": "push                2      0      0     ",
      "08": "set_add             1      0      0     ",
      "09": "send_all            9      -      0     # public.test",
      "10": "recv                0      0      0     ",
      "11": "bool                2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "union_recv          2      -1     -1    ",
      "14": "set                 3      1      0     ",
      "15": "ref                 4      2      0     ",
      "16": "store_open          0      4      21    ",
      "17": "store_read          5      0      0     ",
      "18": "push                5      0      0     ",
      "19": "set_add             3      0      0     ",
      "20": "store_next          0      17     0     ",
      "21": "store_close         0      1      0     ",
      "22": "content             3      -      -     ",
      "23": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 2      1      0     ",
      "10": "table_open_part     0      25     15    # public.test (primary)",
      "11": "table_readi32       3      0      0     ",
      "12": "push                3      0      0     ",
      "13": "set_add             2      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              2      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(table), b(table), c(expr)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c
[[1, 2, 3]]
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]) select * from c
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "send_all            9      -      0     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "set                 2      1      0     ",
      "11": "json                3      40     0     ",
      "12": "push                3      0      0     ",
      "13": "set_add             2      0      0     ",
      "14": "set                 3      1      0     ",
      "15": "ref                 4      2      0     ",
      "16": "store_open          0      4      21    ",
      "17": "store_read          5      0      0     ",
      "18": "push                5      0      0     ",
      "19": "set_add             3      0      0     ",
      "20": "store_next          0      17     0     ",
      "21": "store_close         0      1      0     ",
      "22": "content             3      -      -     ",
      "23": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open_part     0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(table), b(table), c(expr), d(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d
[1, 3, 2]
explain with a as (select * from test), b as (select * from test), c as (select [1,2,3]), d as (select * from test) select * from d
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "send_all            9      -      0     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "set                 2      1      0     ",
      "11": "json                3      40     0     ",
      "12": "push                3      0      0     ",
      "13": "set_add             2      0      0     ",
      "14": "send_all            18     -      0     # public.test",
      "15": "recv                0      0      0     ",
      "16": "bool                3      0      0     ",
      "17": "push                3      0      0     ",
      "18": "union_recv          3      -1     -1    ",
      "19": "set                 4      1      0     ",
      "20": "ref                 5      3      0     ",
      "21": "store_open          0      5      26    ",
      "22": "store_read          6      0      0     ",
      "23": "push                6      0      0     ",
      "24": "set_add             4      0      0     ",
      "25": "store_next          0      22     0     ",
      "26": "store_close         0      1      0     ",
      "27": "content             4      -      -     ",
      "28": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 0      1      0     ",
      "10": "table_open_part     0      20     15    # public.test (primary)",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     ",
      "18": "set                 3      1      0     ",
      "19": "table_open_part     0      45     24    # public.test (primary)",
      "20": "table_readi32       4      0      0     ",
      "21": "push                4      0      0     ",
      "22": "set_add             3      0      0     ",
      "23": "table_next          0      20     0     ",
      "24": "table_close         0      0      0     ",
      "25": "result              3      0      0     ",
      "26": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(expr), b(table), c(expr)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c
[[1, [1, 2, 3]], [3, [1, 2, 3]], [2, [1, 2, 3]]]
explain with a as (select [1,2,3]), b as (select * from test), c as (select [1,2,3]) select b.*, c.* from b,c
[{
  "bytecode": {
    "frontend": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "send_all            0      -      0     # public.test",
      "05": "recv                0      0      0     ",
      "06": "bool                1      0      0     ",
      "07": "push                1      0      0     ",
      "08": "union_recv          1      -1     -1    ",
      "09": "set                 2      1      0     ",
      "10": "json                3      25     0     ",
      "11": "push                3      0      0     ",
      "12": "set_add             2      0      0     ",
      "13": "set                 3      2      0     ",
      "14": "ref                 4      1      0     ",
      "15": "store_open          0      4      26    ",
      "16": "ref                 5      2      0     ",
      "17": "store_open          1      5      24    ",
      "18": "store_read          6      0      0     ",
      "19": "push                6      0      0     ",
      "20": "store_read          6      1      0     ",
      "21": "push                6      0      0     ",
      "22": "set_add             3      0      0     ",
      "23": "store_next          1      18     0     ",
      "24": "store_close         1      1      0     ",
      "25": "store_next          0      16     0     ",
      "26": "store_close         0      1      0     ",
      "27": "content             3      -      -     ",
      "28": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      1      0     ",
      "01": "table_open_part     0      5      6     # public.test (primary)",
      "02": "table_readi32       2      0      0     ",
      "03": "push                2      0      0     ",
      "04": "set_add             1      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              1      0      0     ",
      "08": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(expr), b(table), c(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c
[1, 3, 2]
explain with a as (select [1,2,3]), b as (select * from test), c as (select * from test) select * from c
[{
  "bytecode": {
    "frontend": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "send_all            0      -      0     # public.test",
      "05": "send_all            9      -      0     # public.test",
      "06": "recv                0      0      0     ",
      "07": "bool                1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "union_recv          1      -1     -1    ",
      "10": "recv                0      0      0     ",
      "11": "bool                2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "union_recv          2      -1     -1    ",
      "14": "set                 3      1      0     ",
      "15": "ref                 4      2      0     ",
      "16": "store_open          0      4      21    ",
      "17": "store_read          5      0      0     ",
      "18": "push                5      0      0     ",
      "19": "set_add             3      0      0     ",
      "20": "store_next          0      17     0     ",
      "21": "store_close         0      1      0     ",
      "22": "content             3      -      -     ",
      "23": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 1      1      0     ",
      "01": "table_open_part     0      5      6     # public.test (primary)",
      "02": "table_readi32       2      0      0     ",
      "03": "push                2      0      0     ",
      "04": "set_add             1      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              1      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 1      1      0     ",
      "10": "table_open_part     0      25     15    # public.test (primary)",
      "11": "table_readi32       2      0      0     ",
      "12": "push                2      0      0     ",
      "13": "set_add             1      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              1      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(table), b(a), c(table)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[1, 3, 2]
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "send_all            9      -      0     # public.test",
      "14": "recv                0      0      0     ",
      "15": "bool                3      0      0     ",
      "16": "push                3      0      0     ",
      "17": "union_recv          3      -1     -1    ",
      "18": "set                 4      1      0     ",
      "19": "ref                 5      3      0     ",
      "20": "store_open          0      5      25    ",
      "21": "store_read          6      0      0     ",
      "22": "push                6      0      0     ",
      "23": "set_add             4      0      0     ",
      "24": "store_next          0      21     0     ",
      "25": "store_close         0      1      0     ",
      "26": "content             4      -      -     ",
      "27": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 3      1      0     ",
      "10": "table_open_part     0      20     15    # public.test (primary)",
      "11": "table_readi32       4      0      0     ",
      "12": "push                4      0      0     ",
      "13": "set_add             3      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              3      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[1, 3, 2]
explain with a as (select * from test), b as (select * from a), c as (select * from test) select * from c
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      1      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      12    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "set_add             1      0      0     ",
      "11": "store_next          0      8      0     ",
      "12": "store_close         0      1      0     ",
      "13": "send_all            9      -      0     # public.test",
      "14": "recv                0      0      0     ",
      "15": "bool                3      0      0     ",
      "16": "push                3      0      0     ",
      "17": "union_recv          3      -1     -1    ",
      "18": "set                 4      1      0     ",
      "19": "ref                 5      3      0     ",
      "20": "store_open          0      5      25    ",
      "21": "store_read          6      0      0     ",
      "22": "push                6      0      0     ",
      "23": "set_add             4      0      0     ",
      "24": "store_next          0      21     0     ",
      "25": "store_close         0      1      0     ",
      "26": "content             4      -      -     ",
      "27": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      1      0     ",
      "01": "table_open_part     0      0      6     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "set_add             0      0      0     ",
      "05": "table_next          0      2      0     ",
      "06": "table_close         0      0      0     ",
      "07": "result              0      0      0     ",
      "08": "ret                 0      0      0     ",
      "09": "set                 3      1      0     ",
      "10": "table_open_part     0      20     15    # public.test (primary)",
      "11": "table_readi32       4      0      0     ",
      "12": "push                4      0      0     ",
      "13": "set_add             3      0      0     ",
      "14": "table_next          0      11     0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              3      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "ro"]]
}]
drop table test
# test: a(expr), stmt, b(expr), stmt
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [1,2,3]) select * from a; with b as (select * from test) select b.*, a.* from b,a
[[1, [1, 2, 3]], [3, [1, 2, 3]], [2, [1, 2, 3]]]
drop table test
# test: a(expr), a(expr) (cte redefined)
create table test (id int primary key)
insert into test values (1),(2),(3)
with a as (select [4,5,6]); with a as (select * from test); select * from a
{"msg": "with a as (select [4,5,6]); ❰with❱ ⟵ unexpected statement"}
drop table test
# test: with(insert returning), select * from cte
create table test (id int primary key, data int)
with a as (insert into test values (2, 0) returning *) select * from a
[[2, 0]]
explain with a as (insert into test values (2, 0) returning *) select * from a
[{
  "bytecode": {
    "frontend": {
      "00": "set_ptr             0      -      0     ",
      "01": "send_shard          0      -      0     # public.test",
      "02": "recv                0      0      0     ",
      "03": "bool                0      0      0     ",
      "04": "push                0      0      0     ",
      "05": "union_recv          0      -1     -1    ",
      "06": "set                 1      2      0     ",
      "07": "ref                 2      0      0     ",
      "08": "store_open          0      2      15    ",
      "09": "store_read          3      0      0     ",
      "10": "push                3      0      0     ",
      "11": "store_read          3      0      1     ",
      "12": "push                3      0      0     ",
      "13": "set_add             1      0      0     ",
      "14": "store_next          0      9      0     ",
      "15": "store_close         0      1      0     ",
      "16": "content             1      -      -     ",
      "17": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      2      0     ",
      "01": "table_prepare       0      -      0     # public.test",
      "02": "jmp                 11     0      0     ",
      "03": "string              1      0      0     # unique key constraint violation",
      "04": "push                1      0      0     ",
      "05": "call                1      -      1     # public.error()",
      "06": "table_readi32       1      0      0     ",
      "07": "push                1      0      0     ",
      "08": "table_readi32       1      0      1     ",
      "09": "push                1      0      0     ",
      "10": "set_add             0      0      0     ",
      "11": "upsert              0      3      6     ",
      "12": "table_close         0      0      0     ",
      "13": "result              0      0      0     ",
      "14": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "rw"]]
}]
drop table test
# test: with(update returning), select * from cte
create table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
with a as (update test set data = data + 1 returning *) select * from a
[[0, 1], [1, 1], [2, 1]]
explain with a as (update test set data = data + 1 returning *) select * from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      2      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      14    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "store_read          3      0      1     ",
      "11": "push                3      0      0     ",
      "12": "set_add             1      0      0     ",
      "13": "store_next          0      8      0     ",
      "14": "store_close         0      1      0     ",
      "15": "content             1      -      -     ",
      "16": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      2      0     ",
      "01": "table_open_part     0      0      15    # public.test (primary)",
      "02": "int                 1      -      0     # 1",
      "03": "push                1      0      0     ",
      "04": "table_readi32       1      0      1     ",
      "05": "int                 2      -      0     # 1",
      "06": "addii               3      1      2     ",
      "07": "push                3      0      0     ",
      "08": "update              0      1      0     ",
      "09": "table_readi32       1      0      0     ",
      "10": "push                1      0      0     ",
      "11": "table_readi32       1      0      1     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          0      2      0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "rw"]]
}]
drop table test
# test: with(delete returning), select * from cte
create table test (id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
with a as (delete from test returning *) select * from a
[[0, 0], [1, 0], [2, 0]]
explain with a as (delete from test returning *) select * from a
[{
  "bytecode": {
    "frontend": {
      "00": "send_all            0      -      0     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "set                 1      2      0     ",
      "06": "ref                 2      0      0     ",
      "07": "store_open          0      2      14    ",
      "08": "store_read          3      0      0     ",
      "09": "push                3      0      0     ",
      "10": "store_read          3      0      1     ",
      "11": "push                3      0      0     ",
      "12": "set_add             1      0      0     ",
      "13": "store_next          0      8      0     ",
      "14": "store_close         0      1      0     ",
      "15": "content             1      -      -     ",
      "16": "ret                 0      0      0     "
    },
    "backend": {
      "00": "set                 0      2      0     ",
      "01": "table_open_part     0      0      9     # public.test (primary)",
      "02": "table_readi32       1      0      0     ",
      "03": "push                1      0      0     ",
      "04": "table_readi32       1      0      1     ",
      "05": "push                1      0      0     ",
      "06": "set_add             0      0      0     ",
      "07": "delete              0      0      0     ",
      "08": "table_next          0      2      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  },
  "access": [["public.test", "rw"]]
}]
drop table test
disconnect S0
close E0
