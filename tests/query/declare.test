#

open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }]
connect E0 S0 127.0.0.1:3485

# test: declare parsing
declare
declare 1
declare name

# test: declare
declare a int
declare a int;
explain declare a int;

# test: declare begin/end
declare a int; begin; select a; end;

explain begin; declare a int; select a; end;
begin; declare a int; select a; end;

# test: declare default
explain declare a int; select a
declare a int; select a

explain declare a int; declare b int; select a, b
declare a int; declare b int; select a, b
declare a int; declare b json; select a::type, b::type

# test: declare redefine
declare a int; declare a int;

# test: declare null
declare a null;

# test: := operator parsing
:=
0 :=
0 := 0
'x' := 1
x :=

# test: := expr
x := 1
explain x := 1

declare x int; x := 1
explain declare x int; x := 1

# test: := select expr
declare x int; x := select 1
explain declare x int; x := select 1

# test: := select var
declare x int; x := 1; select x
explain declare x int; x := 1; select x
declare x int; declare y int; x := 1; y := 2; select x + y

# test: := select var (json)
declare x json; x := {"id": 48}; select x.id
explain declare x json; x := {"id": 48}; select x.id

# test: := select var (null)
declare x int; x := null; select x
explain declare x int; x := null; select x
declare x int; x := null; select x + 10

# test: := select var (1 column)
declare x int; x := select 1; select x

# test: := select var (n columns)
declare x int; x := select 1, 2; select x

# test: := select var (column shadow)
create table test (id int primary key)
insert into test values (1)
# this compares two vars
declare id int; id := 1; select * from test where id = id
declare id int; id := 1; select * from test where test.id = id
drop table test

# test: := insert returning (1 column)
create table test (id int primary key)
declare x int; x := insert into test values (1) returning id; select x

# test: := insert returning (n columns)
declare x int; x := insert into test values (2) returning id, id; select x

# test: := pushdown
declare x int; x := 1; select * from test where id = x
explain declare x int; x := 1; select * from test where id = x

# test: := with cte
declare x int; x := with a as (select 1) select * from a; select x

# test: := with cte (assign inside)
declare x int; with a as (x := select 1) select * from a; select x
drop table test

# test: := ddl
declare x json; x := show all;

# test: declare := select expr
declare x int := select 1
explain declare x int := select 1

# test: select into (not defined)
select 1 into x; select x

# test: select into
declare x int; select 1 into x; select x

# test: select into (redefine)
declare x int; select 1 into x; select 2 into x; select x
declare x int; x := 1; select 2 into x; select x

# test: select into (cte)
with a as (select 1 into x) select * from a
declare x int; with a as (select 1 into x) select * from a

# test: select into (subquery)
declare x int; select (select 1 into x); select x

# test: select into (var)
declare x int; x := select 1 into x; select x

# test: returning into
create table test (id int primary key)
declare x int; insert into test values (1) returning id into x; select x

# test: returning into (var)
declare x int; x := insert into test values (1) returning id into x; select x
declare x string; x := insert into test values (1) returning id into x; select x

# test: returning into (cte)
declare x int; with a as (insert into test values (1) returning id into x) select * from a
drop table test

# test: select from var
explain declare x json := [1,2,3]; select * from x as it;
declare x json := [1,2,3]; select * from x as it;
declare x json := [1,2,3]; select it from x as it;
declare x json := [1,2,3]; select it.it from x as it;

explain declare x json := [1,2,3]; select * from (x) as it;
declare x json := [1,2,3]; select * from (x) as it;
declare x json := [1,2,3]; select it from (x) as it;
declare x json := [1,2,3]; select it.it from (x) as it;

# test: declare table parsing
declare x table
declare x table 1
declare x table (
declare x table ()
declare x table (id
declare x table (id int

# test: declare table
create table test (id int primary key)
insert into test values (1), (2), (3)

declare x table (id int); select x::type
declare x table (id int); x := select * from test; select x::type
declare x table (id int); x := select * from test; select x
drop table test

# test: := table (mismatch)
create table test (id int primary key, data int)
insert into test values (1, 1), (2, 2), (3, 3)

declare x table (a int, b int); x := select id from test;

# test: := table
declare x table (a int, b int); x := select * from test;
declare x table (a int, b int); x := select data, id from test;

# test: := table (null)
declare x table (a int, b int); x := select * from test; x := null; select x::type

# test: select from var (table)
declare x table (a int, b int); x := select * from test; select * from x as it
declare x table (a int, b int); x := select * from test; select it.a, it.b from x as it
drop table test

# test: := if
declare x int := if true then end

# test: := for
declare x int := for i in ([1,2,3]) do end

disconnect S0
close E0
