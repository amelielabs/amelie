open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }]
connect E0 S0 localhost:3485
# test: delete statement parsing
delete
{"code": 1, "msg": "DELETE <FROM> expected"}
delete junk
{"code": 1, "msg": "DELETE <FROM> expected"}
delete 1
{"code": 1, "msg": "DELETE <FROM> expected"}
delete from 1
{"code": 1, "msg": "DELETE FROM <table name> expected"}
delete from "name"
{"code": 1, "msg": "DELETE FROM <table name> expected"}
delete from test junk
{"code": 1, "msg": "<test> table or view is not found"}
delete from test where true limit
{"code": 1, "msg": "<test> table or view is not found"}
# test: delete
create table test(id int primary key)
insert into test values (0)
insert into test values (1)
insert into test values (2)
select * from test
[[0], [1], [2]]
delete from test
select * from test
[]
drop table test
# test: delete schema
create schema test
create table test.test(id int primary key, data int)
insert into test.test values (0, 3)
insert into test.test values (1, 2)
insert into test.test values (2, 1)
delete from test.test
select * from test.test
[]
drop table test.test
drop schema test
# test: delete point-lookup
create table test(id int primary key)
insert into test values (0)
insert into test values (1)
insert into test values (2)
explain delete from test where id = 3
[{
  "bytecode": {
    "coordinator": {
      "00": "send_hash           0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # 3",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary, lookup)",
      "03": "jmp                 10     0      0     ",
      "04": "cursor_idx          0      0      0     ",
      "05": "int                 1      -      0     # 3",
      "06": "equ                 2      0      1     ",
      "07": "jntr                3      2      0     ",
      "08": "delete              0      0      0     ",
      "09": "jmp                 3      0      0     ",
      "10": "cursor_close        0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
delete from test where id = 3
select * from test
[[0], [1], [2]]
delete from test where id = 2
select * from test
[[0], [1]]
delete from test where id = 0
select * from test
[[1]]
delete from test where id = -1
select * from test
[[1]]
delete from test where id = 1
select * from test
[]
drop table test
# test: delete range scan
create table test(id int primary key)
insert into test values (0)
insert into test values (1)
insert into test values (2)
select * from test
[[0], [1], [2]]
delete from test where id > 3
select * from test
[[0], [1], [2]]
delete from test where id > 2
select * from test
[[0], [1], [2]]
delete from test where id >= 2
select * from test
[[0], [1]]
explain delete from test where id > 0 and id < 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # 0",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 23     0      0     ",
      "04": "cursor_idx          0      0      0     ",
      "05": "int                 1      -      0     # 1",
      "06": "lt                  2      0      1     ",
      "07": "jntr                3      2      0     ",
      "08": "cursor_idx          1      0      0     ",
      "09": "int                 2      -      0     # 0",
      "10": "gt                  3      1      2     ",
      "11": "jntr                16     3      0     ",
      "12": "cursor_idx          1      0      0     ",
      "13": "int                 2      -      0     # 1",
      "14": "lt                  4      1      2     ",
      "15": "jtr                 18     4      0     ",
      "16": "bool                0      0      0     ",
      "17": "jmp                 19     0      0     ",
      "18": "bool                0      1      0     ",
      "19": "nop                 0      0      0     ",
      "20": "jntr                22     0      0     ",
      "21": "delete              0      0      0     ",
      "22": "cursor_next         0      4      0     ",
      "23": "cursor_close        0      0      0     ",
      "24": "ret                 0      0      0     "
    }
  }
}]
delete from test where id > 0 and id < 1
select * from test
[[0], [1]]
delete from test where id > 0 and id <= 1
select * from test
[[0]]
delete from test where id >= 0 and id <= 1
select * from test
[]
drop table test
# test: delete delete error
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, null)
delete from test where data > 0
{"code": 1, "msg": "bad > expression type"}
select * from test
[[0, 3], [1, 2], [2, null]]
drop table test
# test: delete insert delete
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 0)
delete from test
select * from test
[]
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 0)
select * from test
[[0, 3], [1, 2], [2, 0]]
delete from test
select * from test
[]
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 0)
select * from test
[[0, 3], [1, 2], [2, 0]]
drop table test
# test: delete secondary index
create table test (id int primary key, data int)
create index i on test (data)
insert into test values (0, 2)
insert into test values (1, 1)
insert into test values (2, 0)
delete from test where id = 1
select * from test
[[0, 2], [2, 0]]
select * from test use index (i)
[[2, 0], [0, 2]]
delete from test
select * from test
[]
select * from test use index (i)
[]
drop table test
# test: delete from secondary index
create table test (obj object, primary key (obj.id int))
create index i on test (obj.data int)
insert into test {"id": 0, "data": 2}
insert into test {"id": 1, "data": 1}
insert into test {"id": 2, "data": 0}
delete from test use index (i)
{"code": 1, "msg": "DELETE only primary index supported"}
drop table test
# test: delete returning
create table test(id int primary key)
insert into test values (0)
insert into test values (1)
insert into test values (2)
delete from test returning *
[[0], [1], [2]]
select * from test
[]
insert into test values (0)
insert into test values (1)
insert into test values (2)
delete from test where id >= 1 returning *
[[1], [2]]
select * from test
[[0]]
delete from test
delete from test returning *
[]
drop table test
disconnect S0
close E0
