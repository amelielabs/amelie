open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3;
connect E0 S0 127.0.0.1:3485;
# test: default checkpoint
select show('state').lsn;
[0]
select show('state').catalog;
[0]
select show('state').catalog_pending;
[0]
# test: checkpoint (no data)
checkpoint;
select show('state').lsn;
[0]
select show('state').catalog;
[0]
select show('state').catalog_pending;
[0]
# test: create table
create table test (id serial primary key);
select show('state').lsn;
[1]
# test: checkpoint
checkpoint;
select show('state').lsn;
[1]
select show('state').catalog;
[1]
select show('state').catalog_pending;
[1]
# test: restart/recover
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[1]
select show('state').catalog;
[1]
select show('state').catalog_pending;
[1]
select * from test;
[]
# test: insert
insert into test () values (), (), ();
select identity_of("test");
[3]
# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[2]
select show('state').catalog;
[1]
select show('state').catalog_pending;
[1]
select identity_of("test");
[3]
select * from test;
[0, 1, 2]
# test: checkpoint
checkpoint;
select show('state').lsn;
[2]
select show('state').catalog;
[1]
select show('state').catalog_pending;
[1]
# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[2]
select show('state').catalog;
[1]
select show('state').catalog_pending;
[1]
select identity_of("test");
[3]
select * from test;
[1, 2, 0]
# test: create function
create function reverse(array json) return json
begin
	declare rev json := [];
	for it in (array) do
		rev := rev::push(it);
	end;
	return rev;
end;
show functions extended;
[{
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(it);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "dropped": false,
    "constraints": []
  }],
  "returning": []
}]
select [1,2,3]::reverse;
[[3, 2, 1]]
# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[3]
select show('state').catalog;
[1]
select show('state').catalog_pending;
[3]
show functions extended;
[{
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(it);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "dropped": false,
    "constraints": []
  }],
  "returning": []
}]
select [1,2,3]::reverse;
[[3, 2, 1]]
# test: checkpoint
checkpoint;
select show('state').lsn;
[3]
select show('state').catalog;
[3]
select show('state').catalog_pending;
[3]
# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[3]
select show('state').catalog;
[3]
select show('state').catalog_pending;
[3]
show functions extended;
[{
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(it);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "dropped": false,
    "constraints": []
  }],
  "returning": []
}]
select [1,2,3]::reverse;
[[3, 2, 1]]
# test: create or replace function
create or replace function reverse(array json) return json
begin
	declare rev json := [];
	for it in (array) do
		rev := rev::push(-it::int);
	end;
	return rev;
end;
show functions extended;
[{
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(-it::int);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "dropped": false,
    "constraints": []
  }],
  "returning": []
}]
select [1,2,3]::reverse;
[[-3, -2, -1]]
# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[4]
select show('state').catalog;
[3]
select show('state').catalog_pending;
[4]
show functions extended;
[{
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(-it::int);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "dropped": false,
    "constraints": []
  }],
  "returning": []
}]
select [1,2,3]::reverse;
[[-3, -2, -1]]
# test: checkpoint
checkpoint;
select show('state').lsn;
[4]
select show('state').catalog;
[4]
select show('state').catalog_pending;
[4]
# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[4]
select show('state').catalog;
[4]
select show('state').catalog_pending;
[4]
show functions extended;
[{
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(-it::int);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "dropped": false,
    "constraints": []
  }],
  "returning": []
}]
select [1,2,3]::reverse;
[[-3, -2, -1]]
# test: create database
create database test;
select show('state').lsn;
[5]
# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[5]
select show('state').catalog;
[4]
select show('state').catalog_pending;
[5]
show databases;
[{
  "name": "main"
}, {
  "name": "test"
}]
select identity_of("test");
[3]
# test: checkpoint
checkpoint;
select show('state').lsn;
[5]
select show('state').catalog;
[5]
select show('state').catalog_pending;
[5]
# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
[5]
select show('state').catalog;
[5]
select show('state').catalog_pending;
[5]
show databases;
[{
  "name": "main"
}, {
  "name": "test"
}]
select identity_of("test");
[3]
disconnect S0;
close E0;
