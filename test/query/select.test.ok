open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }]
connect E0 S0 localhost:3485
# test: select statement parsing
select
{"msg": "bad expression"}
select,
{"msg": "bad expression"}
select null null
{"msg": "unexpected token at the end of statement"}
select null 1
{"msg": "unexpected token at the end of statement"}
select from
{"msg": "bad expression"}
select 1 from
{"msg": "FROM target name expected"}
select 1 from "test"
{"msg": "FROM target name expected"}
select 1 from name
{"msg": "<public.name> relation not found"}
select 1 from 1 where
{"msg": "FROM target name expected"}
select 1 from 1 where null
{"msg": "FROM target name expected"}
# test: select expr
select 1
[1]
select 1, 2
[[1, 2]]
select [1, 2]
[[1, 2]]
select {}
[{}]
select null
[null]
select null, null
[[null, null]]
explain select 1
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "content             0      -      -     ",
      "06": "ret                 0      0      0     "
    }
  }
}]
explain select [1, 2, 3]
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "json                1      0      0     ",
      "02": "push                1      0      0     ",
      "03": "set_add             0      0      0     ",
      "04": "cte_set             0      0      0     ",
      "05": "content             0      -      -     ",
      "06": "ret                 0      0      0     "
    }
  }
}]
# test: select name
select name
{"msg": "<name> column not found"}
select name.name
{"msg": "<name> target not found"}
select name.name.name
{"msg": "<name> target not found"}
# test: select *
select *
{"msg": "'*': no targets defined"}
select *, *
{"msg": "'*': no targets defined"}
# test: select * from table
create table test (id int primary key serial)
insert into test () values ()
insert into test () values ()
insert into test () values ()
explain select * from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 7      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "set_add             0      0      0     ",
      "06": "table_next          0      3      0     ",
      "07": "table_close         0      0      0     ",
      "08": "result              0      0      0     ",
      "09": "ret                 0      0      0     "
    }
  }
}]
select * from test
[0, 1, 2]
# test: select *, * from table
select *, * from test
[[0, 0], [1, 1], [2, 2]]
# test: select target.* from table
select test.* from test
[0, 1, 2]
select test.*, *, test.* from test
[[0, 0, 0], [1, 1, 1], [2, 2, 2]]
drop table test
# test: select column from table
create table test (id int primary key serial, data int default 0)
insert into test () values ()
insert into test () values ()
insert into test () values ()
select * from test
[[0, 0], [1, 0], [2, 0]]
explain select id, data from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select id, data from test
[[0, 0], [1, 0], [2, 0]]
drop table test
# test: select column.path from table
create table test (id int primary key serial, data json)
insert into test (data) values ({"data": 123})
insert into test (data) values ({"data": 123})
insert into test (data) values ({"data": 123})
select * from test
[[0, {
  "data": 123
}], [1, {
  "data": 123
}], [2, {
  "data": 123
}]]
explain select data.data from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readj         1      0      1     ",
      "04": "string              2      20     0     # data",
      "05": "dotjs               3      1      2     ",
      "06": "push                3      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select data.data from test
[123, 123, 123]
drop table test
# test: select column.path from table #2
create table test (id int primary key serial, data json)
insert into test (data) values ({"data": {"data": 123}})
insert into test (data) values ({"data": {"data": 123}})
insert into test (data) values ({"data": {"data": 123}})
select * from test
[[0, {
  "data": {
    "data": 123
  }
}], [1, {
  "data": {
    "data": 123
  }
}], [2, {
  "data": {
    "data": 123
  }
}]]
explain select data.data.data from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readj         1      0      1     ",
      "04": "string              2      20     0     # data.data",
      "05": "dotjs               3      1      2     ",
      "06": "push                3      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select data.data.data from test
[123, 123, 123]
drop table test
# test: select target.column from table
create table test (id int primary key serial, data int default 0)
insert into test () values ()
insert into test () values ()
insert into test () values ()
explain select test.id, test.data from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select test.id, test.data from test
[[0, 0], [1, 0], [2, 0]]
drop table test
# test: select target.column.path from table
create table test (id int primary key serial, data json)
insert into test (data) values ({"data": 123})
insert into test (data) values ({"data": 123})
insert into test (data) values ({"data": 123})
explain select test.data.data from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readj         1      0      1     ",
      "04": "string              2      20     0     # data",
      "05": "dotjs               3      1      2     ",
      "06": "push                3      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select test.data.data from test
[123, 123, 123]
select test.data.data, * from test
[[123, 0, {
  "data": 123
}], [123, 1, {
  "data": 123
}], [123, 2, {
  "data": 123
}]]
select test.data.data, *, test.* from test
[[123, 0, {
  "data": 123
}, 0, {
  "data": 123
}], [123, 1, {
  "data": 123
}, 1, {
  "data": 123
}], [123, 2, {
  "data": 123
}, 2, {
  "data": 123
}]]
drop table test
# test: select alias.column from table
create table test (id int primary key serial, data int default 0)
insert into test () values ()
insert into test () values ()
insert into test () values ()
select * from test
[[0, 0], [1, 0], [2, 0]]
explain select alias.id, alias.data from test alias
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select alias.id, alias.data from test alias
[[0, 0], [1, 0], [2, 0]]
drop table test
# test: select alias.column.path from table
create table test (id int primary key serial, data json)
insert into test (data) values ({"data": 123})
insert into test (data) values ({"data": 123})
insert into test (data) values ({"data": 123})
explain select alias.data.data from test alias
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      1      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readj         1      0      1     ",
      "04": "string              2      20     0     # data",
      "05": "dotjs               3      1      2     ",
      "06": "push                3      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select alias.data.data from test alias
[123, 123, 123]
select alias.data['data'] from test alias
[123, 123, 123]
drop table test
# test: select alias.* from table
create table test (id int primary key serial, data int default 0)
insert into test () values ()
insert into test () values ()
insert into test () values ()
select * from test
[[0, 0], [1, 0], [2, 0]]
explain select alias.id, alias.data from test alias
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "union_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
select alias.id, alias.* from test alias
[[0, 0, 0], [1, 1, 0], [2, 2, 0]]
drop table test
# test: select * from function() (missing)
select * from unknown()
{"msg": "FROM public.unknown(): function not found"}
# test: select * from function() (unsupported type)
select * from now()
{"msg": "FROM public.now(): function must return result set or JSON"}
# test: select * from function() (unsupported json type)
select * from system.wal()
{"msg": "FROM: json array expected"}
create user test
select * from system.users()
[{
  "name": "test"
}]
explain select * from system.users()
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "call                1      -      0     # system.users()",
      "02": "json_open           0      1      4     ",
      "03": "jmp                 8      0      0     ",
      "04": "json_read           2      0      0     ",
      "05": "push                2      0      0     ",
      "06": "set_add             0      0      0     ",
      "07": "json_next           0      4      0     ",
      "08": "json_close          0      1      0     ",
      "09": "cte_set             0      0      0     ",
      "10": "content             0      -      -     ",
      "11": "ret                 0      0      0     "
    }
  }
}]
# test: select column from function()
select name from system.users()
["test"]
explain select name from system.users()
[{
  "bytecode": {
    "coordinator": {
      "00": "set                 0      1      0     ",
      "01": "call                1      -      0     # system.users()",
      "02": "json_open           0      1      4     ",
      "03": "jmp                 10     0      0     ",
      "04": "json_read           2      0      0     ",
      "05": "string              3      0      0     # name",
      "06": "dotjs               4      2      3     ",
      "07": "push                4      0      0     ",
      "08": "set_add             0      0      0     ",
      "09": "json_next           0      4      0     ",
      "10": "json_close          0      1      0     ",
      "11": "cte_set             0      0      0     ",
      "12": "content             0      -      -     ",
      "13": "ret                 0      0      0     "
    }
  }
}]
select non_exists_column from system.users()
[null]
# test: select target.column from function()
select users.name from system.users()
["test"]
# test: select alias.column from function()
select t.name from system.users() t
["test"]
drop user test
# test: select target.column.path from function()
create table test (id int primary key serial)
select indexes[0].type from system.tables()
[2]
select tables.indexes[0].type from system.tables()
[2]
select t.indexes[0].type from system.tables() t
[2]
drop table test
disconnect S0
close E0
