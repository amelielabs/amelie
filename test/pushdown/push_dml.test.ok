open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "shards": 3
connect E0 S0 localhost:3485
# test: reference insert
create table test (id int primary key, data int default 0) reference
explain insert into test (id) values (1), (2), (3)
"
bytecode [coordinator]
--------
 0                send        0      0      -      # public.test
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0              insert        -      0      0      # public.test
 1                 ret        0      0      0

"
insert into test (id) values (1), (2), (3)
# test: reference delete
explain delete from test
"
bytecode [coordinator]
--------
 0          send_first        0      0      0
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp        6      0      0
 4              delete        0      0      0
 5         cursor_next        0      4      0
 6        cursor_close        0      0      0
 7                 ret        0      0      0

"
delete from test
select * from test
[]
# test: reference update
insert into test (id) values (1), (2), (3)
explain update test set data = id
"
bytecode [coordinator]
--------
 0          send_first        0      0      0
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15                 ret        0      0      0

"
update test set data = id
select * from test
[[1, 1], [2, 2], [3, 3]]
# test: reference upsert
explain insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
"
bytecode [coordinator]
--------
 0                send        0      0      -      # public.test
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0      cursor_prepare        0      -      0      # public.test
 1                 jmp       13      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      1
 7                 int        1      1      0
 8                 add        2      0      1
 9                push        2      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13              upsert        0      2     -1
14        cursor_close        0      0      0
15                 ret        0      0      0

"
insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
select * from test
[[1, 2], [2, 3], [3, 4]]
drop table test
# test: table insert
create table test (id int primary key, data int default 0)
explain insert into test (id) values (1), (2), (3)
"
bytecode [coordinator]
--------
 0                send        0      0      -      # public.test
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0              insert        -      0      0      # public.test
 1                 ret        0      0      0

"
insert into test (id) values (1), (2), (3)
select * from test
[[1, 0], [2, 0], [3, 0]]
# test: table delete
explain delete from test
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp        6      0      0
 4              delete        0      0      0
 5         cursor_next        0      4      0
 6        cursor_close        0      0      0
 7                 ret        0      0      0

"
delete from test
select * from test
[]
# test: table update
insert into test (id) values (1), (2), (3)
explain update test set data = id
"
bytecode [coordinator]
--------
 0            send_all        0      0      0
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.test (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15                 ret        0      0      0

"
update test set data = id
select * from test
[[1, 1], [2, 2], [3, 3]]
# test: table upsert
explain insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
"
bytecode [coordinator]
--------
 0                send        0      0      -      # public.test
 1                recv        0      0      0
 2                null        0      0      0
 3             cte_set        0      0      0
 4                 ret        0      0      0


bytecode [node]
--------
 0      cursor_prepare        0      -      0      # public.test
 1                 jmp       13      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      1
 7                 int        1      1      0
 8                 add        2      0      1
 9                push        2      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13              upsert        0      2     -1
14        cursor_close        0      0      0
15                 ret        0      0      0

"
insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
select * from test
[[1, 2], [2, 3], [3, 4]]
drop table test
disconnect S0
close E0
