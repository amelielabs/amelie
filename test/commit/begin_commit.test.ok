env_open E0 "cluster_shards": 3
connect E0 S0
connect: on_connect
create table a (id int primary key, data int default 0)
create table b (id int primary key, data int default 0)
create table ref (id int primary key, data int default 0) reference
insert into ref values (0, 8), (1, 8), (2, 8);
# test: begin
begin
query: on_error
{"code": 1, "msg": "COMMIT is missing at the end of the multi-statement transaction"}
# test: begin begin
begin; begin
query: on_error
{"code": 1, "msg": "BEGIN: already in transaction"}
# test: commit
commit; begin
query: on_error
{"code": 1, "msg": "COMMIT without BEGIN"}
# test: begin commit
begin; commit
explain begin; commit
query: on_error
{"code": 1, "msg": "EXPLAIN without command"}
explain
query: on_error
{"code": 1, "msg": "EXPLAIN without command"}
# test: begin commit commit
begin; commit; commit
query: on_error
{"code": 1, "msg": "unexpected command after COMMIT"}
# test: begin commit insert
begin; commit; insert into a (id) values (0), (1), (2), (3)
query: on_error
{"code": 1, "msg": "unexpected command after COMMIT"}
select * from a
# test: begin insert
begin; insert into a (id) values (0), (1), (2), (3)
query: on_error
{"code": 1, "msg": "COMMIT is missing at the end of the multi-statement transaction"}
select * from a
# test: begin insert commit
explain begin; insert into a (id) values (0), (1), (2), (3); commit
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                 ret        0      0      0


bytecode [shard 0]
--------
 0              insert        -      0      3      # a
 1              insert        -      9      3      # a
 2               ready        0     -1      0
 3                 ret        0      0      0


bytecode [shard 1]
--------
 0              insert        -      6      3      # a
 1               ready        0     -1      0
 2                 ret        0      0      0


bytecode [shard 2]
--------
 0              insert        -      3      3      # a
 1               ready        0     -1      0
 2                 ret        0      0      0

"
begin; insert into a (id) values (0), (1), (2), (3); commit
select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
drop table a
drop table b
drop table ref
disconnect S0
env_close E0
