open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3;
connect E0 S0 127.0.0.1:3485;
create table test (id int primary key, data int default 0);
insert into test (id) values (1), (2), (3);
# test: select (select from table)
explain select (select id from test);
[{
  "main": {
    "00": "set                 0      1      0     ",
    "01": "table_open          1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "first               1      0      0     ",
    "08": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro_exclusive"]]
}]
select (select id from test);
[1]
# test: select (select from table) from table
create table test2 (id int primary key);
insert into test2 (id) values (1), (2), (3);
explain select (select id from test) from test2;
[{
  "main": {
    "00": "send_all            0      0      41    # public.test2 (select, closing)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      13    # public.test2 (primary)",
    "02": "set                 2      1      0     ",
    "03": "table_open          3      21     8     # public.test (primary)",
    "04": "table_readi32       4      3      0     ",
    "05": "push                4      0      0     ",
    "06": "set_add             2      0      0     ",
    "07": "table_next          3      4      0     ",
    "08": "free                3      0      0     ",
    "09": "first               3      2      0     ",
    "10": "push                3      0      0     ",
    "11": "set_add             0      0      0     ",
    "12": "table_next          1      2      0     ",
    "13": "free                1      0      0     ",
    "14": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro_exclusive"], ["public.test2", "ro"]]
}]
select (select id from test) from test2;
[1, 1, 1]
# test: select (select from table) from (select from table)
explain select (select id from test) from (select * from test2) t;
[{
  "main": {
    "00": "send_all            0      0      21    # public.test2 (select)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      17    ",
    "06": "set                 4      1      0     ",
    "07": "table_open          5      45     12    # public.test (primary)",
    "08": "table_readi32       6      5      0     ",
    "09": "push                6      0      0     ",
    "10": "set_add             4      0      0     ",
    "11": "table_next          5      8      0     ",
    "12": "free                5      0      0     ",
    "13": "first               5      4      0     ",
    "14": "push                5      0      0     ",
    "15": "set_add             0      0      0     ",
    "16": "store_next          3      6      0     ",
    "17": "free                3      0      0     ",
    "18": "free                2      0      0     ",
    "19": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test2 (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro_exclusive"], ["public.test2", "ro"]]
}]
select (select id from test) from (select * from test2) t;
[1, 1, 1]
drop table test2;
# test: select from (select from table)
explain select * from (select * from test) t;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (select)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "set                 0      2      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      12    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "store_read          4      3      1     ",
    "09": "push                4      0      0     ",
    "10": "set_add             0      0      0     ",
    "11": "store_next          3      6      0     ",
    "12": "free                3      0      0     ",
    "13": "free                2      0      0     ",
    "14": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
select * from (select * from test) t;
[[1, 0], [3, 0], [2, 0]]
# test: select from (select (select from table) from table)
create table test2 (id int primary key);
insert into test2 (id) values (1), (2), (3);
explain select * from (select (select id from test2) from test) t;
[{
  "main": {
    "00": "send_all            0      0      41    # public.test (select)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      13    # public.test (primary)",
    "02": "set                 2      1      0     ",
    "03": "table_open          3      20     8     # public.test2 (primary)",
    "04": "table_readi32       4      3      0     ",
    "05": "push                4      0      0     ",
    "06": "set_add             2      0      0     ",
    "07": "table_next          3      4      0     ",
    "08": "free                3      0      0     ",
    "09": "first               3      2      0     ",
    "10": "push                3      0      0     ",
    "11": "set_add             0      0      0     ",
    "12": "table_next          1      2      0     ",
    "13": "free                1      0      0     ",
    "14": "ret                 0      0      -     "
  },
  "access": [["public.test2", "ro_exclusive"], ["public.test", "ro"]]
}]
select * from (select (select id from test2) from test) t;
[1, 1, 1]
drop table test2;
# test: select from (select (select from table) from table)
explain select * from (select (select id from test t) from test) g;
[{
  "main": {
    "00": "send_all            0      0      40    # public.test (select)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      10    ",
    "06": "store_read          4      3      0     ",
    "07": "push                4      0      0     ",
    "08": "set_add             0      0      0     ",
    "09": "store_next          3      6      0     ",
    "10": "free                3      0      0     ",
    "11": "free                2      0      0     ",
    "12": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      13    # public.test (primary)",
    "02": "set                 2      1      0     ",
    "03": "table_open          3      20     8     # public.test (primary)",
    "04": "table_readi32       4      3      0     ",
    "05": "push                4      0      0     ",
    "06": "set_add             2      0      0     ",
    "07": "table_next          3      4      0     ",
    "08": "free                3      0      0     ",
    "09": "first               3      2      0     ",
    "10": "push                3      0      0     ",
    "11": "set_add             0      0      0     ",
    "12": "table_next          1      2      0     ",
    "13": "free                1      0      0     ",
    "14": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro_exclusive"]]
}]
select * from (select (select id from test t) from test) g;
[1, 1, 1]
# test: select (select expr) from (select from table)
select (select t.*) from (select * from test) t;
{"msg": "select (❰select❱ ⟵ subquery must return only one column"}
select (select t.id) from (select * from test) t;
[1, 3, 2]
# test: select (select from table) from (select from table)
create table test2 (id int primary key);
insert into test2 (id) values (1), (2), (3);
explain select (select t.id from test2) from (select * from test) t;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (select)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      17    ",
    "06": "set                 4      1      0     ",
    "07": "table_open          5      44     12    # public.test2 (primary)",
    "08": "store_read          6      3      0     ",
    "09": "push                6      0      0     ",
    "10": "set_add             4      0      0     ",
    "11": "table_next          5      8      0     ",
    "12": "free                5      0      0     ",
    "13": "first               5      4      0     ",
    "14": "push                5      0      0     ",
    "15": "set_add             0      0      0     ",
    "16": "store_next          3      6      0     ",
    "17": "free                3      0      0     ",
    "18": "free                2      0      0     ",
    "19": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["public.test2", "ro_exclusive"], ["public.test", "ro"]]
}]
select (select t.id from test2) from (select * from test) t;
[1, 3, 2]
drop table test2;
# test: select (select from table) from (select from table)
explain select (select t.id from test z) from (select * from test) t;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (select)",
    "01": "union               1      0      0     ",
    "02": "recv                1      0      0     ",
    "03": "set                 0      1      0     ",
    "04": "dup                 2      1      0     ",
    "05": "store_open          3      2      17    ",
    "06": "set                 4      1      0     ",
    "07": "table_open          5      44     12    # public.test (primary)",
    "08": "store_read          6      3      0     ",
    "09": "push                6      0      0     ",
    "10": "set_add             4      0      0     ",
    "11": "table_next          5      8      0     ",
    "12": "free                5      0      0     ",
    "13": "first               5      4      0     ",
    "14": "push                5      0      0     ",
    "15": "set_add             0      0      0     ",
    "16": "store_next          3      6      0     ",
    "17": "free                3      0      0     ",
    "18": "free                2      0      0     ",
    "19": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro_exclusive"]]
}]
select (select t.id from test z) from (select * from test) t;
[1, 3, 2]
# test: select from (select from table), (select from table)
select * from (select id from test) a, (select * from test) b;
[[1, 1, 0], [1, 3, 0], [1, 2, 0], [3, 1, 0], [3, 3, 0], [3, 2, 0], [2, 1, 0], [2, 3, 0], [2, 2, 0]]
explain select * from (select * from test) a, (select * from test) b;
[{
  "main": {
    "00": "send_all            0      0      20    # public.test (select)",
    "01": "send_all            1      0      64    # public.test (select)",
    "02": "union               2      0      0     ",
    "03": "recv                2      0      0     ",
    "04": "union               0      0      0     ",
    "05": "recv                0      1      0     ",
    "06": "set                 1      4      0     ",
    "07": "dup                 3      2      0     ",
    "08": "store_open          4      3      24    ",
    "09": "dup                 5      0      0     ",
    "10": "store_open          6      5      21    ",
    "11": "store_read          7      4      0     ",
    "12": "push                7      0      0     ",
    "13": "store_read          7      4      1     ",
    "14": "push                7      0      0     ",
    "15": "store_read          7      6      0     ",
    "16": "push                7      0      0     ",
    "17": "store_read          7      6      1     ",
    "18": "push                7      0      0     ",
    "19": "set_add             1      0      0     ",
    "20": "store_next          6      11     0     ",
    "21": "free                6      0      0     ",
    "22": "free                5      0      0     ",
    "23": "store_next          4      9      0     ",
    "24": "free                4      0      0     ",
    "25": "free                3      0      0     ",
    "26": "ret                 1      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      0     ",
    "01": "table_open_part     1      0      8     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "table_readi32       2      1      1     ",
    "05": "push                2      0      0     ",
    "06": "set_add             0      0      0     ",
    "07": "table_next          1      2      0     ",
    "08": "free                1      0      0     ",
    "09": "ret                 0      0      -     ",
    "10": "set                 1      2      0     ",
    "11": "table_open_part     2      44     18    # public.test (primary)",
    "12": "table_readi32       3      2      0     ",
    "13": "push                3      0      0     ",
    "14": "table_readi32       3      2      1     ",
    "15": "push                3      0      0     ",
    "16": "set_add             1      0      0     ",
    "17": "table_next          2      12     0     ",
    "18": "free                2      0      0     ",
    "19": "ret                 1      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
# test: insert returning (select from table) (unsupported)
explain insert into test (id) values (4) returning (select * from test t);
{"msg": "explain insert into test (id) values (4) returning (❰select❱ ⟵ unexpected subquery"}
insert into test (id) values (4) returning (select * from test t);
{"msg": "insert into test (id) values (4) returning (❰select❱ ⟵ unexpected subquery"}
# test: insert returning (select from table) (unsupported)
create table test_ (id int primary key);
insert into test_ values (1),(2),(3);
insert into test (id) values (5) returning (select * from test_);
{"msg": "insert into test (id) values (5) returning (❰select❱ ⟵ unexpected subquery"}
drop table test_;
# test: insert returning (select from expr) (unsupported)
insert into test (id) values (6) returning *, select [1,2,3];
{"msg": "insert into test (id) values (6) returning *, ❰select❱ ⟵ unexpected subquery"}
insert into test (id) values (7) returning id, select [1,2,3];
{"msg": "insert into test (id) values (7) returning id, ❰select❱ ⟵ unexpected subquery"}
drop table test;
disconnect S0;
close E0;
