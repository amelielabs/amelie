#

open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3;
connect E0 S0 127.0.0.1:3485;

# test: default checkpoint
select show('state').checkpoint;

# test: default checkpoint_compression
select show().checkpoint_compression;

# test: checkpoint (no data)
checkpoint;
select show('state').checkpoint;

# test: create table
create table test (id serial primary key);
select show('state').lsn;

# test: checkpoint
checkpoint;
select show('state').lsn;
select show('state').checkpoint;

# test: restart/recover
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;
select show('state').lsn;
select show('state').checkpoint;
select * from test;

# test: insert
insert into test () values (), (), ();
select identity_of("test");

# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
select identity_of("test");
select * from test;

# test: checkpoint
checkpoint;
select show('state').lsn;
select show('state').checkpoint;

# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
select identity_of("test");
select * from test;

# test: create function
create function reverse(array json) return json
begin
	declare rev json := [];
	for it in (array) do
		rev := rev::push(it);
	end;
	return rev;
end;
show functions extended;
select [1,2,3]::reverse;

# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
show functions extended;
select [1,2,3]::reverse;

# test: checkpoint
checkpoint;
select show('state').lsn;
select show('state').checkpoint;

# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
show functions extended;
select [1,2,3]::reverse;

# test: create or replace function
create or replace function reverse(array json) return json
begin
	declare rev json := [];
	for it in (array) do
		rev := rev::push(-it::int);
	end;
	return rev;
end;
show functions extended;
select [1,2,3]::reverse;

# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
show functions extended;
select [1,2,3]::reverse;

# test: checkpoint
checkpoint;
select show('state').lsn;
select show('state').checkpoint;

# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
show functions extended;
select [1,2,3]::reverse;

# test: create database
create database test;
select show('state').lsn;

# test: restart/recover (checkpoint + wal)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
show databases;
select identity_of("test");

# test: checkpoint
checkpoint;
select show('state').lsn;
select show('state').checkpoint;

# test: restart/recover (checkpoint)
disconnect S0;
close E0;
open E0;
connect E0 S0 127.0.0.1:3485;

select show('state').lsn;
select show('state').checkpoint;
show databases;
select identity_of("test");

disconnect S0;
close E0;

# test: checkpoint (compression none)
open E1 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3, "checkpoint_compression": "none";
connect E1 S1 127.0.0.1:3485;

show checkpoint_compression;

create table test (id serial primary key);
insert into test values (1), (2), (3);
checkpoint;

# test: restart/recover (checkpoint)
disconnect S1;
close E1;

open E1;
connect E1 S1 127.0.0.1:3485;

show checkpoint_compression;
select * from test;

disconnect S1;
close E1;
