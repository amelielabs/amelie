open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }]
connect E0 S0 localhost:3485
# test: update statement parsing
create table test(id int primary key)
update
{"msg": "FROM target name expected"}
update;
{"msg": "FROM target name expected"}
update 1;
{"msg": "FROM target name expected"}
update "name"
{"msg": "FROM target name expected"}
update test
{"msg": "UPDATE <SET> expected"}
update test "path"
{"msg": "UPDATE <SET> expected"}
update test 1
{"msg": "UPDATE <SET> expected"}
update test path
{"msg": "UPDATE <SET> expected"}
update test set path
{"msg": "UPDATE name SET column <=> expected"}
update test set path /
{"msg": "UPDATE name SET column <=> expected"}
update test set path =
{"msg": "bad expression"}
update test set path = expr
{"msg": "<test.path> column not found"}
update test set id = id expr
{"msg": "unexpected token at the end of statement"}
drop table test
# test: update
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 1)
explain update test set data = data + 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # -2147483648",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 12     0      0     ",
      "04": "int                 0      -      0     # 1",
      "05": "push                0      0      0     ",
      "06": "cursor_readi32      0      0      1     ",
      "07": "int                 1      -      0     # 1",
      "08": "addii               2      0      1     ",
      "09": "push                2      0      0     ",
      "10": "update              0      1      0     ",
      "11": "cursor_next         0      4      0     ",
      "12": "cursor_close        0      0      0     ",
      "13": "ret                 0      0      0     "
    }
  }
}]
update test set data = data + 1
select * from test
[[0, 4], [1, 3], [2, 2]]
drop table test
# test: update schema
create schema test
create table test.test(id int primary key, data int)
insert into test.test values (0, 3)
insert into test.test values (1, 2)
insert into test.test values (2, 1)
explain update test.test set data = data + 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # test.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # -2147483648",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # test.test (primary)",
      "03": "jmp                 12     0      0     ",
      "04": "int                 0      -      0     # 1",
      "05": "push                0      0      0     ",
      "06": "cursor_readi32      0      0      1     ",
      "07": "int                 1      -      0     # 1",
      "08": "addii               2      0      1     ",
      "09": "push                2      0      0     ",
      "10": "update              0      1      0     ",
      "11": "cursor_next         0      4      0     ",
      "12": "cursor_close        0      0      0     ",
      "13": "ret                 0      0      0     "
    }
  }
}]
update test.test set data = data + 1
select * from test.test
[[0, 4], [1, 3], [2, 2]]
drop table test.test
drop schema test
# test: update multiple ops
create table test(id int primary key, a int, b int)
insert into test values (0, 3, 3)
insert into test values (1, 2, 2)
insert into test values (2, 1, 1)
explain update test set a = a + 1, b = b - 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # -2147483648",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 18     0      0     ",
      "04": "int                 0      -      0     # 1",
      "05": "push                0      0      0     ",
      "06": "cursor_readi32      0      0      1     ",
      "07": "int                 1      -      0     # 1",
      "08": "addii               2      0      1     ",
      "09": "push                2      0      0     ",
      "10": "int                 0      -      0     # 2",
      "11": "push                0      0      0     ",
      "12": "cursor_readi32      0      0      2     ",
      "13": "int                 1      -      0     # 1",
      "14": "subii               2      0      1     ",
      "15": "push                2      0      0     ",
      "16": "update              0      2      0     ",
      "17": "cursor_next         0      4      0     ",
      "18": "cursor_close        0      0      0     ",
      "19": "ret                 0      0      0     "
    }
  }
}]
update test set a = a + 1, b = b - 1
select * from test
[[0, 4, 2], [1, 3, 1], [2, 2, 0]]
drop table test
# test: update same column twice
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 1)
update test set data = data + 1, data = data + 1
{"msg": "<test.data> column is redefined in UPDATE"}
select * from test
[[0, 3], [1, 2], [2, 1]]
drop table test
# test: update json
create table test(id int primary key, data json)
insert into test values (0, {"id": 48})
insert into test values (1, {"id": 49})
insert into test values (2, {"id": 50})
update test set data = {"id": data.id::int + 1}
explain update test set data = {"id": data.id::int + 1}
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # -2147483648",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 20     0      0     ",
      "04": "int                 0      -      0     # 1",
      "05": "push                0      0      0     ",
      "06": "string              0      20     0     # id",
      "07": "push                0      0      0     ",
      "08": "cursor_readj        0      0      1     ",
      "09": "string              1      23     0     # id",
      "10": "dotjs               2      0      1     ",
      "11": "push                2      0      0     ",
      "12": "call                0      -      1     # public.int()",
      "13": "int                 1      -      0     # 1",
      "14": "addii               2      0      1     ",
      "15": "push                2      0      0     ",
      "16": "json_obj            0      2      0     ",
      "17": "push                0      0      0     ",
      "18": "update              0      1      0     ",
      "19": "cursor_next         0      4      0     ",
      "20": "cursor_close        0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select * from test
[[0, {
  "id": 49
}], [1, {
  "id": 50
}], [2, {
  "id": 51
}]]
drop table test
# test: update json rewrite
create table test(id int primary key serial, data json)
insert into test (data) values ({"id": 48})
insert into test (data) values ({"id": 49})
insert into test (data) values ({"id": 50})
update test set data = {"id": id}
select * from test
[[0, {
  "id": 0
}], [1, {
  "id": 1
}], [2, {
  "id": 2
}]]
drop table test
# test: update object rewrite #2
create table test(id int primary key serial, data json)
insert into test (data) values ({"id": 48})
insert into test (data) values ({"id": 49})
insert into test (data) values ({"id": 50})
update test set data = [id, data.id]
select * from test
[[0, [0, 48]], [1, [1, 49]], [2, [2, 50]]]
drop table test
# test: update key
create table test(id int primary key)
insert into test values (0)
insert into test values (1)
insert into test values (2)
update test set id = id + 1
{"msg": "<test.id> column used as a part of a key"}
select * from test
[0, 1, 2]
drop table test
# test: update point-lookup
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 1)
explain update test set data = data + 1 where id = 0
[{
  "bytecode": {
    "coordinator": {
      "00": "send_hash           0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # 0",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary, lookup)",
      "03": "jmp                 16     0      0     ",
      "04": "cursor_readi32      0      0      0     ",
      "05": "int                 1      -      0     # 0",
      "06": "equii               2      0      1     ",
      "07": "jntr                3      2      0     ",
      "08": "int                 0      -      0     # 1",
      "09": "push                0      0      0     ",
      "10": "cursor_readi32      0      0      1     ",
      "11": "int                 1      -      0     # 1",
      "12": "addii               2      0      1     ",
      "13": "push                2      0      0     ",
      "14": "update              0      1      0     ",
      "15": "jmp                 3      0      0     ",
      "16": "cursor_close        0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
update test set data = data + 1 where id = 0
update test set data = data + 1 where id = 1
update test set data = data + 1 where id = 2
select * from test
[[0, 4], [1, 3], [2, 2]]
drop table test
# test: update range scan
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, 1)
explain update test set data = data + 1 where id >= 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int                 0      -      0     # 1",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 16     0      0     ",
      "04": "cursor_readi32      0      0      0     ",
      "05": "int                 1      -      0     # 1",
      "06": "gteii               2      0      1     ",
      "07": "jntr                15     2      0     ",
      "08": "int                 0      -      0     # 1",
      "09": "push                0      0      0     ",
      "10": "cursor_readi32      0      0      1     ",
      "11": "int                 1      -      0     # 1",
      "12": "addii               2      0      1     ",
      "13": "push                2      0      0     ",
      "14": "update              0      1      0     ",
      "15": "cursor_next         0      4      0     ",
      "16": "cursor_close        0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
update test set data = data + 1 where id > 2
select * from test
[[0, 3], [1, 2], [2, 1]]
update test set data = data + 1 where id >= 2
select * from test
[[0, 3], [1, 2], [2, 2]]
update test set data = data + 1 where id >= 1
select * from test
[[0, 3], [1, 3], [2, 3]]
drop table test
# test: update null
create table test(id int primary key, data int)
insert into test values (0, 3)
insert into test values (1, 2)
insert into test values (2, null)
update test set data = data + 1
select * from test
[[0, 4], [1, 3], [2, null]]
update test set data = id where data is null
select * from test
[[0, 4], [1, 3], [2, 2]]
drop table test
# test: update set null
create table test(id int primary key, data int)
insert into test values (0, 1)
update test set data = data + 1
select * from test
[[0, 2]]
update test set data = null
select * from test
[[0, null]]
drop table test
# test: update set null (not null)
create table test(id int primary key, data int not null)
insert into test values (0, 1)
update test set data = data + 1
select * from test
[[0, 2]]
update test set data = null
{"msg": "column data: cannot be null"}
select * from test
[[0, 2]]
drop table test
# test: update returning
create table test(id int primary key, data int)
insert into test values (0, 0)
insert into test values (1, 0)
insert into test values (2, 0)
explain update test set data = data + 1 returning *
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "body                0      0      0     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # -2147483648",
      "02": "push                1      0      0     ",
      "03": "cursor_open         0      0      5     # public.test (primary)",
      "04": "jmp                 18     0      0     ",
      "05": "int                 1      -      0     # 1",
      "06": "push                1      0      0     ",
      "07": "cursor_readi32      1      0      1     ",
      "08": "int                 2      -      0     # 1",
      "09": "addii               3      1      2     ",
      "10": "push                3      0      0     ",
      "11": "update              0      1      0     ",
      "12": "cursor_readi32      1      0      0     ",
      "13": "push                1      0      0     ",
      "14": "cursor_readi32      1      0      1     ",
      "15": "push                1      0      0     ",
      "16": "set_add             0      0      0     ",
      "17": "cursor_next         0      5      0     ",
      "18": "cursor_close        0      0      0     ",
      "19": "result              0      0      0     ",
      "20": "ret                 0      0      0     "
    }
  }
}]
update test set data = data + 1 returning *
[[0, 1], [1, 1], [2, 1]]
update test set data = data + 1 returning *
[[0, 2], [1, 2], [2, 2]]
update test set data = data + 1 returning *
[[0, 3], [1, 3], [2, 3]]
select * from test
[[0, 3], [1, 3], [2, 3]]
drop table test
# test: update column (int8)
create table test (id int primary key, data i8)
insert into test values (1, 123), (2, 255), (3, 256)
update test set data = data + 1
select * from test
[[1, 124], [2, 0], [3, 1]]
drop table test
# test: update column (int16)
create table test (id int primary key, data i16)
insert into test values (1, 123), (2, 256), (3, -32768)
update test set data = data + 1
select * from test
[[1, 124], [2, 257], [3, -32767]]
drop table test
# test: update column (int32)
create table test (id int primary key, data i32)
insert into test values (1, 123), (2, 256), (3, -32768)
update test set data = data + 1
select * from test
[[1, 124], [2, 257], [3, -32767]]
drop table test
# test: update column (int64)
create table test (id int primary key, data i64)
insert into test values (1, 123), (2, 256), (3, -32768)
update test set data = data + 1
select * from test
[[1, 124], [2, 257], [3, -32767]]
drop table test
# test: update column (float)
create table test (id int primary key, data float)
insert into test values (1, 123.32), (2, 3.14)
update test set data = data + 0.01
select * from test
[[1, 123.33], [2, 3.15]]
drop table test
# test: update column (double)
create table test (id int primary key, data double)
insert into test values (1, 123.32), (2, 3.14)
update test set data = data + 0.01
select * from test
[[1, 123.33], [2, 3.15]]
drop table test
# test: update column (text)
create table test (id int primary key, data text)
insert into test values (1, 'hello')
update test set data = data || " world"
update test set data = data || " world"
update test set data = data || " world"
select data from test
["hello world world world"]
drop table test
# test: update column (json)
create table test (id int primary key, data json)
insert into test values (1, null)
update test set data = data::append(1,2,3)
select * from test
[[1, null]]
drop table test
# test: update column (timestamp)
create table test (id int primary key, ts timestamp)
insert into test values (0, "1970-01-01 01:12:59.909090")
update test set ts = ts + interval '5 days'
select * from test
[[0, "1970-01-06 01:12:59.909090+00"]]
drop table test
# test: update column (interval)
create table test (id int primary key, i interval)
insert into test values (0, "1 year 1 day 10 hour")
update test set i = i + interval '5 days'
select * from test
[[0, "1 year 6 days 10 hours"]]
drop table test
# test: update column (vector)
create table test (id int primary key, vec vector)
insert into test values (3, [1.0, 1.1])
update test set vec = vec + [1.0, 1.1]::vector
select * from test
[[3, [2, 2.2]]]
drop table test
# test: update secondary index
create table test (id int primary key, data int, value int)
create index i on test (data)
insert into test values (0, 2, 0)
insert into test values (1, 1, 0)
insert into test values (2, 0, 0)
select * from test
[[0, 2, 0], [1, 1, 0], [2, 0, 0]]
select * from test use index (i)
[[2, 0, 0], [1, 1, 0], [0, 2, 0]]
update test set value = data
select * from test
[[0, 2, 2], [1, 1, 1], [2, 0, 0]]
select * from test use index (i)
[[2, 0, 0], [1, 1, 1], [0, 2, 2]]
# test: update secondary index (key)
update test set data = id
{"msg": "<test.data> column used as a part of a key"}
drop table test
disconnect S0
close E0
