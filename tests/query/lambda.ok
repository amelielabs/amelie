open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 2;
connect E0 S0 127.0.0.1:3485;
# test: select ->
select ->;
{"msg": "select ❰->❱ ⟵ bad expression"}
select -> 1;
{"msg": "select ❰->❱ ⟵ bad expression"}
select 1 ->;
{"msg": "select 1 ->❰;❱ ⟵ bad expression"}
select 1 -> 1;
{"msg": "select 1 -> 1❰;❱ ⟵ no targets to use with GROUP BY or aggregation"}
# test: select int -> from table (partitions 1)
create table test (id int primary key, data int) partitions 1;
insert into test values (0, 0);
insert into test values (1, 1);
insert into test values (2, 2);
insert into test values (3, 1);
insert into test values (4, 3);
select 0 -> id;
{"msg": "select 0 -> id❰;❱ ⟵ no targets to use with GROUP BY or aggregation"}
select 0 -> id from test;
[4]
# test: select int ->, int -> from table
select 0 -> id, 0 -> data from test;
[[4, 3]]
explain select 0 -> id, 0 -> data from test;
[{
  "main": {
    "00": "send_all            0      0      34    # test (select, closing)",
    "01": "recv_aggs           1      0      18    ",
    "02": "set                 2      2      0     ",
    "03": "store_open          3      1      10    ",
    "04": "store_read          4      3      0     ",
    "05": "push                4      0      0     ",
    "06": "store_read          4      3      1     ",
    "07": "push                4      0      0     ",
    "08": "set_add             2      0      0     ",
    "09": "store_next          3      4      0     ",
    "10": "free                3      0      0     ",
    "11": "free                1      0      0     ",
    "12": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      2      1     ",
    "01": "int                 1      -      0     # 0",
    "02": "int                 2      -      0     # 0",
    "03": "table_open_part     3      0      12    # test (primary)",
    "04": "push_bool           1      0      0     ",
    "05": "set_get             4      0      0     ",
    "06": "table_readi32       5      3      0     ",
    "07": "push                5      0      0     ",
    "08": "table_readi32       5      3      1     ",
    "09": "push                5      0      0     ",
    "10": "set_agg             0      4      18    ",
    "11": "table_next          3      4      0     ",
    "12": "free                3      0      0     ",
    "13": "push_bool           1      0      0     ",
    "14": "set_get             3      0      0     ",
    "15": "push_nulls          1      0      0     ",
    "16": "push_nulls          1      0      0     ",
    "17": "set_agg             0      3      18    ",
    "18": "ret                 0      0      -     "
  },
  "access": [["test", "shared"]]
}]
# test: select self
select self;
{"msg": "select ❰self❱ ⟵ unexpected SELF usage without lambda context"}
# test: select int -> self from table
select 0 -> self from test;
[0]
select 0 -> self + 1 from test;
[5]
explain select 0 -> self + 1 from test;
[{
  "main": {
    "00": "send_all            0      0      26    # test (select, closing)",
    "01": "recv_aggs           1      0      18    ",
    "02": "set                 2      1      0     ",
    "03": "store_open          3      1      8     ",
    "04": "store_read          4      3      0     ",
    "05": "push                4      0      0     ",
    "06": "set_add             2      0      0     ",
    "07": "store_next          3      4      0     ",
    "08": "free                3      0      0     ",
    "09": "free                1      0      0     ",
    "10": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      1     ",
    "01": "int                 1      -      0     # 0",
    "02": "table_open_part     2      0      11    # test (primary)",
    "03": "push_bool           1      0      0     ",
    "04": "set_get             3      0      0     ",
    "05": "self                4      0      3     ",
    "06": "int                 5      -      0     # 1",
    "07": "addii               6      4      5     ",
    "08": "push                6      0      0     ",
    "09": "set_agg             0      3      18    ",
    "10": "table_next          2      3      0     ",
    "11": "free                2      0      0     ",
    "12": "push_bool           1      0      0     ",
    "13": "set_get             2      0      0     ",
    "14": "push_nulls          1      0      0     ",
    "15": "set_agg             0      2      18    ",
    "16": "ret                 0      0      -     "
  },
  "access": [["test", "shared"]]
}]
select 0 -> (self + 1) + self from test;
[31]
# test: select string -> self from table
select '' -> self || id::string from test;
["01234"]
select '' -> self::concat(id::string) from test;
["01234"]
# test: select [] -> self from table
select [] -> self::append(id) from test;
[[0, 1, 2, 3, 4]]
select [] -> append(self, id) from test;
[[0, 1, 2, 3, 4]]
select [] -> self::append(id::string) from test;
[["0", "1", "2", "3", "4"]]
# test: select {} -> self from table
select {} -> self::set('key_' || id::string, data) from test;
[{
  "key_0": 0,
  "key_1": 1,
  "key_2": 2,
  "key_3": 1,
  "key_4": 3
}]
# test: select int -> from table group by
select * from test;
[[0, 0], [1, 1], [2, 2], [3, 1], [4, 3]]
select data, 0 -> self + 1 from test group by data;
[[0, 1], [1, 2], [2, 1], [3, 1]]
# test: select column -> from table (unsupported)
select id -> self + 1 from test;
{"msg": "select ❰id❱ ⟵ column not found"}
# test: select expr -> from table
select (select 1 + 2) -> self + 1 from test;
[8]
select 1 + 2 -> self + 1 from test;
[8]
select null -> 1 from test;
{"msg": "select null -> ❰1❱ ⟵ lambda expression type mismatch"}
select null::int -> 1 from test;
{"msg": "select null::int -> ❰1❱ ⟵ lambda expression type mismatch"}
# test: select subquery -> from table
select (select data from test t where id = 3) -> self + 1 from test;
[6]
# test: select (select column -> from table) from table
select id, (select o.id -> self + 1 from test) from test as o;
[[0, 5], [1, 6], [2, 7], [3, 8], [4, 9]]
select (select o.id -> self + 1 from test) from test as o;
[5, 6, 7, 8, 9]
# test: select -> / ->
select (0.0 -> self + id) / (0 -> self + 1) from test;
[2]
drop table test;
# test: select int -> self from table (partitions N, unsupported)
create table test (id int primary key, data int) partitions 2;
insert into test values (0, 0);
insert into test values (1, 1);
insert into test values (2, 2);
insert into test values (3, 1);
insert into test values (4, 3);
insert into test values (5, 3);
explain select 0 -> self + 1 from test;
[{
  "main": {
    "00": "send_all            0      0      26    # test (select, closing)",
    "01": "recv_aggs           1      0      18    ",
    "02": "set                 2      1      0     ",
    "03": "store_open          3      1      8     ",
    "04": "store_read          4      3      0     ",
    "05": "push                4      0      0     ",
    "06": "set_add             2      0      0     ",
    "07": "store_next          3      4      0     ",
    "08": "free                3      0      0     ",
    "09": "free                1      0      0     ",
    "10": "ret                 2      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      1     ",
    "01": "int                 1      -      0     # 0",
    "02": "table_open_part     2      0      11    # test (primary)",
    "03": "push_bool           1      0      0     ",
    "04": "set_get             3      0      0     ",
    "05": "self                4      0      3     ",
    "06": "int                 5      -      0     # 1",
    "07": "addii               6      4      5     ",
    "08": "push                6      0      0     ",
    "09": "set_agg             0      3      18    ",
    "10": "table_next          2      3      0     ",
    "11": "free                2      0      0     ",
    "12": "push_bool           1      0      0     ",
    "13": "set_get             2      0      0     ",
    "14": "push_nulls          1      0      0     ",
    "15": "set_agg             0      2      18    ",
    "16": "ret                 0      0      -     "
  },
  "access": [["test", "shared"]]
}]
select 0 -> self + 1 from test;
{"msg": "distributed operation on lambda is not supported"}
drop table test;
# test: select expr -> from []
select 0 -> self + value::int from ([1,2,3]) value;
[6]
# test: select (expr -> from column) from table
create table test (id int primary key, data json);
insert into test values (0, [1,2,3]);
insert into test values (1, [4,5,6]);
insert into test values (2, [7,8,9]);
select id, (select 0 -> self + value::int from (test.data) value) from test;
[[2, 24], [0, 6], [1, 15]]
drop table test;
disconnect S0;
close E0;
