#

open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;

# test: case 1: concurrent partition refresh
create table test (id int primary key) partitions 1;
insert into test values (1), (2), (3), (4);
show partitions on test;

create lock bp_refresh_1 on bp_refresh_1 (exclusive);
show locks;

# begin refresh and lock on breakpoint after
# partition lock
connect_async E0 S1 127.0.0.1:3485;
switch S1;
alter partition 1 on test refresh;

switch S0;
watch 'part_1'::locks_count = 1;
show locks;

connect_async E0 S2 127.0.0.1:3485;
switch S2;
alter partition 1 on test refresh;

# ensure second session locked on the partition lock
switch S0;
watch 'part_1'::locks_count = 2;
show locks;

# drop breakpoint and resume S1
switch S0;
drop lock bp_refresh_1;

switch S1;
recv;

switch S2;
recv;

switch S0;
show locks;
show partitions on test;

disconnect S2;
disconnect S1;
drop table test;

disconnect S0;
close E0;
