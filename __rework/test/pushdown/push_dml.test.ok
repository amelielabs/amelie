open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
# test: shared insert
create shared table test (id int primary key, data int default 0)
explain insert into test (id) values (1), (2), (3)
[{
  "bytecode": {
    "coordinator": {
      "00": "send                0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "insert              -      0      0     # public.test",
      "01": "ret                 0      0      0     "
    }
  }
}]
insert into test (id) values (1), (2), (3)
# test: shared delete
explain delete from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int_min             0      0      0     ",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 6      0      0     ",
      "04": "delete              0      0      0     ",
      "05": "cursor_next         0      4      0     ",
      "06": "cursor_close        0      0      0     ",
      "07": "ret                 0      0      0     "
    }
  }
}]
delete from test
select * from test
[]
# test: shared update
insert into test (id) values (1), (2), (3)
explain update test set data = id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_first          0      0      0     ",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int_min             0      0      0     ",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 14     0      0     ",
      "04": "cursor_read         0      0      0     ",
      "05": "push                0      0      0     ",
      "06": "null                0      0      0     ",
      "07": "push                0      0      0     ",
      "08": "cursor_idx          0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "assign              0      3      1     ",
      "11": "push                0      0      0     ",
      "12": "update              0      0      0     ",
      "13": "cursor_next         0      4      0     ",
      "14": "cursor_close        0      0      0     ",
      "15": "ret                 0      0      0     "
    }
  }
}]
update test set data = id
select * from test
[[1, 1], [2, 2], [3, 3]]
# test: shared upsert
explain insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send                0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "cursor_prepare      0      -      0     # public.test",
      "01": "jmp                 13     0      0     ",
      "02": "cursor_read         0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "null                0      0      0     ",
      "05": "push                0      0      0     ",
      "06": "cursor_idx          0      0      1     ",
      "07": "int                 1      -      0     # 1",
      "08": "add                 2      0      1     ",
      "09": "push                2      0      0     ",
      "10": "assign              0      3      1     ",
      "11": "push                0      0      0     ",
      "12": "update              0      0      0     ",
      "13": "upsert              0      2      -1    ",
      "14": "cursor_close        0      0      0     ",
      "15": "ret                 0      0      0     "
    }
  }
}]
insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
select * from test
[[1, 2], [2, 3], [3, 4]]
drop table test
# test: table insert
create table test (id int primary key, data int default 0)
explain insert into test (id) values (1), (2), (3)
[{
  "bytecode": {
    "coordinator": {
      "00": "send                0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "insert              -      0      0     # public.test",
      "01": "ret                 0      0      0     "
    }
  }
}]
insert into test (id) values (1), (2), (3)
select * from test
[[1, 0], [2, 0], [3, 0]]
# test: table delete
explain delete from test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int_min             0      0      0     ",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 6      0      0     ",
      "04": "delete              0      0      0     ",
      "05": "cursor_next         0      4      0     ",
      "06": "cursor_close        0      0      0     ",
      "07": "ret                 0      0      0     "
    }
  }
}]
delete from test
select * from test
[]
# test: table update
insert into test (id) values (1), (2), (3)
explain update test set data = id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "int_min             0      0      0     ",
      "01": "push                0      0      0     ",
      "02": "cursor_open         0      0      4     # public.test (primary)",
      "03": "jmp                 14     0      0     ",
      "04": "cursor_read         0      0      0     ",
      "05": "push                0      0      0     ",
      "06": "null                0      0      0     ",
      "07": "push                0      0      0     ",
      "08": "cursor_idx          0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "assign              0      3      1     ",
      "11": "push                0      0      0     ",
      "12": "update              0      0      0     ",
      "13": "cursor_next         0      4      0     ",
      "14": "cursor_close        0      0      0     ",
      "15": "ret                 0      0      0     "
    }
  }
}]
update test set data = id
select * from test
[[1, 1], [2, 2], [3, 3]]
# test: table upsert
explain insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send                0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "null                0      0      0     ",
      "03": "cte_set             0      0      0     ",
      "04": "ret                 0      0      0     "
    },
    "node": {
      "00": "cursor_prepare      0      -      0     # public.test",
      "01": "jmp                 13     0      0     ",
      "02": "cursor_read         0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "null                0      0      0     ",
      "05": "push                0      0      0     ",
      "06": "cursor_idx          0      0      1     ",
      "07": "int                 1      -      0     # 1",
      "08": "add                 2      0      1     ",
      "09": "push                2      0      0     ",
      "10": "assign              0      3      1     ",
      "11": "push                0      0      0     ",
      "12": "update              0      0      0     ",
      "13": "upsert              0      2      -1    ",
      "14": "cursor_close        0      0      0     ",
      "15": "ret                 0      0      0     "
    }
  }
}]
insert into test (id) values (1), (2), (3) on conflict do update set data = data + 1
select * from test
[[1, 2], [2, 3], [3, 4]]
drop table test
disconnect S0
close E0
