open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;
# test: create function parsing
create function;
{"msg": "create function❰;❱ ⟵ name expected"}
create function test;
{"msg": "create function test❰;❱ ⟵ ( expected"}
create function test (;
{"msg": "create function test (❰;❱ ⟵ name expected"}
create function test (1;
{"msg": "create function test (❰1❱ ⟵ name expected"}
create function test (x;
{"msg": "create function test (x❰;❱ ⟵ unrecognized data type"}
create function test (x 1;
{"msg": "create function test (x ❰1❱ ⟵ unrecognized data type"}
create function test (x int;
{"msg": "create function test (x int❰;❱ ⟵ ) expected"}
create function test (x int,;
{"msg": "create function test (x int,❰;❱ ⟵ name expected"}
create function test (x int, int;
{"msg": "create function test (x int, int❰;❱ ⟵ unrecognized data type"}
create function test (x int, y;
{"msg": "create function test (x int, y❰;❱ ⟵ unrecognized data type"}
create function test (x int, y);
{"msg": "create function test (x int, y❰)❱ ⟵ unrecognized data type"}
create function test (x int);
{"msg": "create function test (x int)❰;❱ ⟵ BEGIN expected"}
create function test (x int) 1;
{"msg": "create function test (x int) ❰1❱ ⟵ BEGIN expected"}
# test: create function (empty, no return)
create function test () begin end;
show functions extended;
[{
  "db": "main",
  "name": "test",
  "text": "begin end",
  "type": 0,
  "args": [],
  "returning": []
}]
explain select test();
[{
  "main": {
    "00": "call_udf            0      -      -     # test()",
    "01": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "ret                 -1     0      -     "
    },
    "access": []
  }]
}]
select test();
[null]
explain execute test();
[{
  "function": "test",
  "main": {
    "00": "ret                 -1     0      -     "
  },
  "access": []
}]
execute test();
drop function test;
# test: create function return (empty)
create function test () return int
begin
end;
explain select test();
[{
  "main": {
    "00": "call_udf            0      -      -     # test()",
    "01": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "ret                 -1     0      -     "
    },
    "access": []
  }]
}]
select test();
[null]
select test()::type;
["null"]
explain execute test();
[{
  "function": "test",
  "main": {
    "00": "ret                 -1     0      -     "
  },
  "access": []
}]
execute test();
select test() + 123;
[null]
drop function test;
# test: create function return (return explicit)
create function test () return int
begin
	return 123;
end;
explain select test();
[{
  "main": {
    "00": "call_udf            0      -      -     # test()",
    "01": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "int                 0      -      0     # 123",
      "01": "ret                 0      0      -     "
    },
    "access": []
  }]
}]
select test();
[123]
explain execute test();
[{
  "function": "test",
  "main": {
    "00": "int                 0      -      0     # 123",
    "01": "ret                 0      0      -     "
  },
  "access": []
}]
execute test();
[123]
select test() + 123;
[246]
drop function test;
# test: create function return (no return)
create function test () return int
begin
	select 123;
end;
explain select test();
[{
  "main": {
    "00": "call_udf            0      -      -     # test()",
    "01": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "int                 0      -      0     # 123",
      "01": "ret                 -1     0      -     "
    },
    "access": []
  }]
}]
select test();
[null]
explain execute test();
[{
  "function": "test",
  "main": {
    "00": "int                 0      -      0     # 123",
    "01": "ret                 -1     0      -     "
  },
  "access": []
}]
execute test();
select test() + 123;
[null]
drop function test;
# test: create function return (return stmt)
create function test () return int
begin
	return select 123;
end;
explain select test();
[{
  "main": {
    "00": "call_udf            0      -      -     # test()",
    "01": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "int                 0      -      0     # 123",
      "01": "ret                 0      0      -     "
    },
    "access": []
  }]
}]
select test();
[123]
explain execute test();
[{
  "function": "test",
  "main": {
    "00": "int                 0      -      0     # 123",
    "01": "ret                 0      0      -     "
  },
  "access": []
}]
execute test();
[123]
select test() + 123;
[246]
drop function test;
# test: create function return (return type mismatch)
create function test () return int
begin
	return '123';
end;
{"msg": "begin\n\treturn ❰'123'❱ ⟵ RETURN type 'string' mismatch function type 'int'"}
create function test () return int
begin
	return select '123';
end;
{"msg": "begin\n\treturn ❰select❱ ⟵ RETURN type 'string' mismatch function type 'int'"}
create function test ()
begin
	return '123';
end;
{"msg": "begin\n\treturn ❰'123'❱ ⟵ RETURN type 'string' mismatch function type 'null'"}
create function test ()
begin
	return select '123';
end;
{"msg": "begin\n\treturn ❰select❱ ⟵ RETURN type 'string' mismatch function type 'null'"}
create function test ()
begin
	return null;
end;
select test();
[null]
execute test();
drop function test;
create function test ()
begin
	return;
end;
select test();
[null]
select test();
[null]
execute test();
drop function test;
create function test ()
begin
	select null;
end;
select test();
[null]
execute test();
drop function test;
# test: create function return (return table parse)
create function test () return table;
{"msg": "create function test () return table❰;❱ ⟵ ( expected"}
create function test () return table(;
{"msg": "create function test () return table(❰;❱ ⟵ name expected"}
create function test () return table(1;
{"msg": "create function test () return table(❰1❱ ⟵ name expected"}
create function test () return table(a;
{"msg": "create function test () return table(a❰;❱ ⟵ unrecognized data type"}
create function test () return table(a a;
{"msg": "create function test () return table(a ❰a❱ ⟵ unrecognized data type"}
create function test () return table(a int;
{"msg": "create function test () return table(a int❰;❱ ⟵ ) expected"}
create function test () return table(a int,;
{"msg": "create function test () return table(a int,❰;❱ ⟵ name expected"}
create function test () return table(a int,,;
{"msg": "create function test () return table(a int,❰,❱ ⟵ name expected"}
create function test () return table(a int,);
{"msg": "create function test () return table(a int,❰)❱ ⟵ name expected"}
# test: create function return (return table)
create function test () return table(a int)
begin
end;
drop function test;
create function test () return table(a int, b int)
begin
end;
drop function test;
create function test () return table(a int, b int, c int)
begin
end;
show functions extended;
[{
  "db": "main",
  "name": "test",
  "text": "begin\nend",
  "type": 13,
  "args": [],
  "returning": [{
    "name": "a",
    "type": 2,
    "type_size": 4,
    "deleted": false,
    "constraints": [["default", null]]
  }, {
    "name": "b",
    "type": 2,
    "type_size": 4,
    "deleted": false,
    "constraints": [["default", null]]
  }, {
    "name": "c",
    "type": 2,
    "type_size": 4,
    "deleted": false,
    "constraints": [["default", null]]
  }]
}]
drop function test;
create function test () return table(a int, a int)
begin
end;
{"msg": "create function test () return table(a int, ❰a❱ ⟵ argument redefined"}
# test: create function (var return null)
create function test () return int
begin
	declare x int;
	return x;
end;
select test();
[null]
drop function test;
# test: create function (var return)
create function test () return int
begin
	declare x int := 123;
	return x;
end;
select test();
[123]
drop function test;
# test: create function (var redefined)
create function test () return int
begin
	declare x int;
	declare x int;
	return x;
end;
{"msg": "create function test () return int\nbegin\n\tdeclare x int;\n\tdeclare ❰x❱ ⟵ variable redefined"}
# test: create function (arg return)
create function test (x int) return int
begin
	return x;
end;
explain select test(123);
[{
  "main": {
    "00": "push_int            -      0      0     # 123",
    "01": "call_udf            0      -      -     # test()",
    "02": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "var                 0      0      1     ",
      "01": "ret                 0      0      -     "
    },
    "access": []
  }]
}]
select test(123);
[123]
execute test(123);
[123]
drop function test;
# test: create function (arg redefined)
create function test (x int, x int) return int
begin
	return x;
end;
{"msg": "create function test (x int, ❰x❱ ⟵ argument redefined"}
# test: create function (arg/var redefined)
create function test (x int) return int
begin
	declare x int;
end;
{"msg": "create function test (x int) return int\nbegin\n\tdeclare ❰x❱ ⟵ variable redefined"}
# test: create function
create function test (x int) return int
begin
	declare total int := 0;
	declare i int := 0;
	while i < x do
		total := total + i;
		i := i + 1;
	end;
	return total;
end;
explain select test(10);
[{
  "main": {
    "00": "push_int            -      0      0     # 10",
    "01": "call_udf            0      -      -     # test()",
    "02": "ret                 0      0      -     "
  },
  "access": [["test", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "push_nulls          2      0      0     ",
      "01": "int                 0      -      0     # 0",
      "02": "var_set             0      0      0     ",
      "03": "int                 0      -      0     # 0",
      "04": "var_set             1      0      0     ",
      "05": "var                 0      1      0     ",
      "06": "var                 1      0      1     ",
      "07": "ltii                2      0      1     ",
      "08": "jntr                18     2      0     ",
      "09": "var                 0      0      0     ",
      "10": "var                 1      1      0     ",
      "11": "addii               2      0      1     ",
      "12": "var_set             0      0      2     ",
      "13": "var                 0      1      0     ",
      "14": "int                 1      -      0     # 1",
      "15": "addii               2      0      1     ",
      "16": "var_set             1      0      2     ",
      "17": "jmp                 5      0      0     ",
      "18": "var                 0      0      0     ",
      "19": "ret                 0      0      -     "
    },
    "access": []
  }]
}]
select test(10);
[45]
explain execute test(10);
[{
  "function": "test",
  "main": {
    "00": "push_nulls          2      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "int                 0      -      0     # 0",
    "04": "var_set             1      0      0     ",
    "05": "var                 0      1      0     ",
    "06": "var                 1      0      1     ",
    "07": "ltii                2      0      1     ",
    "08": "jntr                18     2      0     ",
    "09": "var                 0      0      0     ",
    "10": "var                 1      1      0     ",
    "11": "addii               2      0      1     ",
    "12": "var_set             0      0      2     ",
    "13": "var                 0      1      0     ",
    "14": "int                 1      -      0     # 1",
    "15": "addii               2      0      1     ",
    "16": "var_set             1      0      2     ",
    "17": "jmp                 5      0      0     ",
    "18": "var                 0      0      0     ",
    "19": "ret                 0      0      -     "
  },
  "access": []
}]
execute test(10);
[45]
# test: create function (json)
create function reverse(array json) return json
begin
	declare rev json;
	select [] -> self::push(it) into rev from (array) it;
	return rev;
end;
explain select [1,2,3]::reverse;
[{
  "main": {
    "00": "push_json           0      0      0     ",
    "01": "call_udf            0      -      -     # reverse()",
    "02": "ret                 0      0      -     "
  },
  "access": [["reverse", "call"]],
  "calls": [{
    "function": "reverse",
    "main": {
      "00": "push_nulls          1      0      0     ",
      "01": "set                 0      1      1     ",
      "02": "json                1      0      0     ",
      "03": "var                 2      0      1     ",
      "04": "json_open           3      2      15    ",
      "05": "push_bool           1      0      0     ",
      "06": "set_get             4      0      0     ",
      "07": "self                5      0      4     ",
      "08": "push                5      0      0     ",
      "09": "json_read           5      3      0     ",
      "10": "push                5      0      0     ",
      "11": "call                5      -      2     # push()",
      "12": "push                5      0      0     ",
      "13": "set_agg             0      4      2     ",
      "14": "json_next           3      5      0     ",
      "15": "free                2      0      0     ",
      "16": "push_bool           1      0      0     ",
      "17": "set_get             2      0      0     ",
      "18": "push_nulls          1      0      0     ",
      "19": "set_agg             0      2      2     ",
      "20": "free                1      0      0     ",
      "21": "set_agg_merge       0      2      0     ",
      "22": "set                 1      1      0     ",
      "23": "store_open          2      0      28    ",
      "24": "store_read          3      2      0     ",
      "25": "push                3      0      0     ",
      "26": "set_add             1      0      0     ",
      "27": "store_next          2      24     0     ",
      "28": "free                2      0      0     ",
      "29": "free                0      0      0     ",
      "30": "var_set             0      0      1     ",
      "31": "free                1      0      0     ",
      "32": "var                 0      0      0     ",
      "33": "ret                 0      0      -     "
    },
    "access": []
  }]
}]
select [1,2,3]::reverse;
[[3, 2, 1]]
select [1,2,3]::reverse::reverse;
[[1, 2, 3]]
explain execute reverse([1,2,3]);
[{
  "function": "reverse",
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "set                 0      1      1     ",
    "02": "json                1      0      0     ",
    "03": "var                 2      0      1     ",
    "04": "json_open           3      2      15    ",
    "05": "push_bool           1      0      0     ",
    "06": "set_get             4      0      0     ",
    "07": "self                5      0      4     ",
    "08": "push                5      0      0     ",
    "09": "json_read           5      3      0     ",
    "10": "push                5      0      0     ",
    "11": "call                5      -      2     # push()",
    "12": "push                5      0      0     ",
    "13": "set_agg             0      4      2     ",
    "14": "json_next           3      5      0     ",
    "15": "free                2      0      0     ",
    "16": "push_bool           1      0      0     ",
    "17": "set_get             2      0      0     ",
    "18": "push_nulls          1      0      0     ",
    "19": "set_agg             0      2      2     ",
    "20": "free                1      0      0     ",
    "21": "set_agg_merge       0      2      0     ",
    "22": "set                 1      1      0     ",
    "23": "store_open          2      0      28    ",
    "24": "store_read          3      2      0     ",
    "25": "push                3      0      0     ",
    "26": "set_add             1      0      0     ",
    "27": "store_next          2      24     0     ",
    "28": "free                2      0      0     ",
    "29": "free                0      0      0     ",
    "30": "var_set             0      0      1     ",
    "31": "free                1      0      0     ",
    "32": "var                 0      0      0     ",
    "33": "ret                 0      0      -     "
  },
  "access": []
}]
execute reverse([1,2,3]);
[[3, 2, 1]]
drop function reverse;
create function reverse(array json) return json
begin
	declare rev json := [];
	for it in (array) do
		rev := rev::push(it);
	end;
	return rev;
end;
show functions extended;
[{
  "db": "main",
  "name": "test",
  "text": "begin\n\tdeclare total int := 0;\n\tdeclare i int := 0;\n\twhile i < x do\n\t\ttotal := total + i;\n\t\ti := i + 1;\n\tend;\n\treturn total;\nend",
  "type": 2,
  "args": [{
    "name": "x",
    "type": 2,
    "type_size": 4,
    "deleted": false,
    "constraints": [["default", null]]
  }],
  "returning": []
}, {
  "db": "main",
  "name": "reverse",
  "text": "begin\n\tdeclare rev json := [];\n\tfor it in (array) do\n\t\trev := rev::push(it);\n\tend;\n\treturn rev;\nend",
  "type": 5,
  "args": [{
    "name": "array",
    "type": 5,
    "type_size": 0,
    "deleted": false,
    "constraints": [["default", null]]
  }],
  "returning": []
}]
explain select [1,2,3]::reverse;
[{
  "main": {
    "00": "push_json           0      0      0     ",
    "01": "call_udf            0      -      -     # reverse()",
    "02": "ret                 0      0      -     "
  },
  "access": [["reverse", "call"]],
  "calls": [{
    "function": "reverse",
    "main": {
      "00": "push_nulls          1      0      0     ",
      "01": "json                0      0      0     ",
      "02": "var_set             0      0      0     ",
      "03": "free                0      0      0     ",
      "04": "var                 0      0      1     ",
      "05": "json_open           1      0      13    ",
      "06": "push_var            0      0      0     ",
      "07": "json_read           2      1      0     ",
      "08": "push                2      0      0     ",
      "09": "call                2      -      2     # push()",
      "10": "var_set             0      0      2     ",
      "11": "free                2      0      0     ",
      "12": "json_next           1      6      0     ",
      "13": "free                0      0      0     ",
      "14": "var                 0      0      0     ",
      "15": "ret                 0      0      -     "
    },
    "access": []
  }]
}]
select [1,2,3]::reverse;
[[3, 2, 1]]
explain execute reverse([1,2,3]);
[{
  "function": "reverse",
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "json                0      0      0     ",
    "02": "var_set             0      0      0     ",
    "03": "free                0      0      0     ",
    "04": "var                 0      0      1     ",
    "05": "json_open           1      0      13    ",
    "06": "push_var            0      0      0     ",
    "07": "json_read           2      1      0     ",
    "08": "push                2      0      0     ",
    "09": "call                2      -      2     # push()",
    "10": "var_set             0      0      2     ",
    "11": "free                2      0      0     ",
    "12": "json_next           1      6      0     ",
    "13": "free                0      0      0     ",
    "14": "var                 0      0      0     ",
    "15": "ret                 0      0      -     "
  },
  "access": []
}]
execute reverse([1,2,3]);
[[3, 2, 1]]
drop function reverse;
drop function test;
# test: create or replace function (not exists)
create or replace function test() return int
begin
	return 123;
end;
show functions extended;
[{
  "db": "main",
  "name": "test",
  "text": "begin\n\treturn 123;\nend",
  "type": 2,
  "args": [],
  "returning": []
}]
select test();
[123]
# test: create or replace function
create or replace function test() return int
begin
	return 321;
end;
show functions extended;
[{
  "db": "main",
  "name": "test",
  "text": "begin\n\treturn 321;\nend",
  "type": 2,
  "args": [],
  "returning": []
}]
select test();
[321]
# test: create or replace function (return type mismatch)
create or replace function test() return string
begin
	return 'string';
end;
{"msg": "function replacement 'test' return type mismatch"}
select test();
[321]
# test: create or replace function (arg mismatch)
create or replace function test(id int) return int
begin
	return id;
end;
{"msg": "function replacement 'test' arguments mismatch"}
select test();
[321]
# test: create or replace function (with dep)
create function dep () return int
begin
	return select test();
end;
select dep();
[321]
create or replace function test() return int
begin
	return 777;
end;
select dep();
[777]
drop function dep;
drop function test;
# test: drop function
create function test () begin end;
drop function;
{"msg": "drop function❰;❱ ⟵ name expected"}
drop function test;
drop function test;
{"msg": "function 'test': not exists"}
# test: drop function if exists
drop function if exists test;
# test: drop function with udf dep
create function test_dep() begin end;
create function test() begin select test_dep(); end;
explain select test();
[{
  "main": {
    "00": "call_udf            0      -      -     # test()",
    "01": "ret                 0      0      -     "
  },
  "access": [["test", "call"], ["test_dep", "call"]],
  "calls": [{
    "function": "test",
    "main": {
      "00": "call_udf            0      -      -     # test_dep()",
      "01": "ret                 -1     0      -     "
    },
    "access": [["test_dep", "call"]]
  }, {
    "function": "test_dep",
    "main": {
      "00": "ret                 -1     0      -     "
    },
    "access": []
  }]
}]
drop function test_dep;
{"msg": "function 'test' depends on relation 'test_dep"}
# test: drop function after dep drop
drop function test;
drop function test_dep;
# test: alter function statement parsing
alter;
{"msg": "alter❰;❱ ⟵ USER|STORAGE|DATABASE|TABLE|INDEX|FUNCTION expected"}
alter function;
{"msg": "alter function❰;❱ ⟵ name expected"}
alter function 123;
{"msg": "alter function ❰123❱ ⟵ name expected"}
alter function if;
{"msg": "alter function if❰;❱ ⟵ EXISTS expected"}
alter function if exists;
{"msg": "alter function if exists❰;❱ ⟵ name expected"}
alter function if exists 123;
{"msg": "alter function if exists ❰123❱ ⟵ name expected"}
# test: alter function if exists
create function test() begin end;
alter function test rename to test2;
alter function if exists test rename to test2;
show functions;
[{
  "db": "main",
  "name": "test2"
}]
# test: alter function rename
alter function test rename;
{"msg": "alter function test rename❰;❱ ⟵ name expected"}
alter function test rename to;
{"msg": "alter function test rename to❰;❱ ⟵ name expected"}
alter function test rename to asf junk;
{"msg": "alter function test rename to asf ❰junk❱ ⟵ ; expected"}
alter function test2 rename to abc;
select show('function', 'abc', true).name;
["abc"]
# test: alter function rename function exists
create function test() begin end;
alter function abc rename to test;
{"msg": "function 'test': already exists"}
drop function test;
# test: alter function rename with udf dep
create function test_dep() begin end;
create function test() begin select test_dep(); end;
alter function test_dep rename to test_dep2;
{"msg": "function 'test' depends on relation 'test_dep"}
# test: alter function rename after after dep drop
drop function test;
alter function test_dep rename to test_dep2;
drop function test_dep2;
# test: recursion direct
create function test(x int) return int
begin
	select test(123);
end;
{"msg": "create function test(x int) return int\nbegin\n\tselect ❰test❱ ⟵ function not found"}
disconnect S0;
close E0;
