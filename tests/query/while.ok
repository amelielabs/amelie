open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }];
connect E0 S0 127.0.0.1:3485;
# test: while parsing
while end;
{"msg": "while ❰end❱ ⟵ bad expression"}
while 1 end;
{"msg": "while 1 ❰end❱ ⟵ DO expected"}
while do end;
{"msg": "while ❰do❱ ⟵ bad expression"}
# test: while
explain begin
	declare i int := 0;
	while i < 3 do
		i := i + 1;
	end;
	select i;
end;
[{
  "main": {
    "00": "push_nulls          1      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "free                0      0      0     ",
    "04": "var                 0      0      0     ",
    "05": "int                 1      -      0     # 3",
    "06": "ltii                2      0      1     ",
    "07": "jntr                14     2      0     ",
    "08": "var                 0      0      0     ",
    "09": "int                 1      -      0     # 1",
    "10": "addii               2      0      1     ",
    "11": "var_set             0      0      2     ",
    "12": "free                2      0      0     ",
    "13": "jmp                 4      0      0     ",
    "14": "var                 0      0      0     ",
    "15": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	while i < 3 do
		i := i + 1;
	end;
	select i;
end;
[3]
# test: while while
explain begin
	declare i int := 0;
	declare j int := 0;
	declare n int := 0;
	while i < 3 do
		j := 0;
		while j < 3 do
			j := j + 1;
			n := n + 1;
		end;
		i := i + 1;
	end;
	select i, j, n;
end;
[{
  "main": {
    "00": "push_nulls          3      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "free                0      0      0     ",
    "04": "int                 0      -      0     # 0",
    "05": "var_set             1      0      0     ",
    "06": "free                0      0      0     ",
    "07": "int                 0      -      0     # 0",
    "08": "var_set             2      0      0     ",
    "09": "free                0      0      0     ",
    "10": "var                 0      0      0     ",
    "11": "int                 1      -      0     # 3",
    "12": "ltii                2      0      1     ",
    "13": "jntr                38     2      0     ",
    "14": "int                 0      -      0     # 0",
    "15": "var_set             1      0      0     ",
    "16": "free                0      0      0     ",
    "17": "var                 0      1      0     ",
    "18": "int                 1      -      0     # 3",
    "19": "ltii                2      0      1     ",
    "20": "jntr                32     2      0     ",
    "21": "var                 0      1      0     ",
    "22": "int                 1      -      0     # 1",
    "23": "addii               2      0      1     ",
    "24": "var_set             1      0      2     ",
    "25": "free                2      0      0     ",
    "26": "var                 0      2      0     ",
    "27": "int                 1      -      0     # 1",
    "28": "addii               2      0      1     ",
    "29": "var_set             2      0      2     ",
    "30": "free                2      0      0     ",
    "31": "jmp                 17     0      0     ",
    "32": "var                 0      0      0     ",
    "33": "int                 1      -      0     # 1",
    "34": "addii               2      0      1     ",
    "35": "var_set             0      0      2     ",
    "36": "free                2      0      0     ",
    "37": "jmp                 10     0      0     ",
    "38": "set                 0      3      0     ",
    "39": "var                 1      0      0     ",
    "40": "push                1      0      0     ",
    "41": "var                 1      1      0     ",
    "42": "push                1      0      0     ",
    "43": "var                 1      2      0     ",
    "44": "push                1      0      0     ",
    "45": "set_add             0      0      0     ",
    "46": "ret                 0      0      -     "
  },
  "access": []
}]
begin
	declare i int := 0;
	declare j int := 0;
	declare n int := 0;
	while i < 3 do
		j := 0;
		while j < 3 do
			j := j + 1;
			n := n + 1;
		end;
		i := i + 1;
	end;
	select i, j, n;
end;
[[3, 3, 9]]
# test: while if
begin
	declare i int := 0;
	declare n int := 0;
	while i < 4 do
		if i % 2 = 0 then
			n := n + 1;
		end;
		i := i + 1;
	end;
	select n;
end;
[2]
# test: while var
create table test (id int primary key);
insert into test values (4);
explain begin
	declare i int := 0;
	declare x int := 0;
	declare n int := 0;
	select id into x from test;
	while i < x do
		if i % 2 = 0 then
			n := n + 1;
		end;
		i := i + 1;
	end;
	select n, x;
end;
[{
  "main": {
    "00": "push_nulls          3      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "free                0      0      0     ",
    "04": "int                 0      -      0     # 0",
    "05": "var_set             1      0      0     ",
    "06": "free                0      0      0     ",
    "07": "int                 0      -      0     # 0",
    "08": "var_set             2      0      0     ",
    "09": "free                0      0      0     ",
    "10": "send_all            0      0      20    # public.test (last)",
    "11": "recv                1      0      -1    ",
    "12": "var_set             1      0      1     ",
    "13": "free                1      0      0     ",
    "14": "var                 0      0      0     ",
    "15": "var                 1      1      0     ",
    "16": "ltii                2      0      1     ",
    "17": "jntr                35     2      0     ",
    "18": "var                 0      0      0     ",
    "19": "int                 1      -      0     # 2",
    "20": "modii               2      0      1     ",
    "21": "int                 0      -      0     # 0",
    "22": "equii               1      2      0     ",
    "23": "jntr                29     1      0     ",
    "24": "var                 0      2      0     ",
    "25": "int                 1      -      0     # 1",
    "26": "addii               2      0      1     ",
    "27": "var_set             2      0      2     ",
    "28": "free                2      0      0     ",
    "29": "var                 0      0      0     ",
    "30": "int                 1      -      0     # 1",
    "31": "addii               2      0      1     ",
    "32": "var_set             0      0      2     ",
    "33": "free                2      0      0     ",
    "34": "jmp                 14     0      0     ",
    "35": "set                 0      2      0     ",
    "36": "var                 1      2      0     ",
    "37": "push                1      0      0     ",
    "38": "var                 1      1      0     ",
    "39": "push                1      0      0     ",
    "40": "set_add             0      0      0     ",
    "41": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set                 0      1      0     ",
    "01": "table_open_part     1      0      6     # public.test (primary)",
    "02": "table_readi32       2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_add             0      0      0     ",
    "05": "table_next          1      2      0     ",
    "06": "free                1      0      0     ",
    "07": "ret                 0      0      -     "
  },
  "access": [["public.test", "ro"]]
}]
begin
	declare i int := 0;
	declare x int := 0;
	declare n int := 0;
	select id into x from test;
	while i < x do
		if i % 2 = 0 then
			n := n + 1;
		end;
		i := i + 1;
	end;
	select n, x;
end;
[[2, 4]]
# test: while select
while select 123 do end;
{"msg": "while ❰select❱ ⟵ unexpected subquery"}
# test: while do insert
begin
	declare i int := 0;
	declare x int := 0;
	select max(id) into x from test;
	while i < x do
		insert into test values (i);
		i := i + 1;
	end;
	select x;
end;
[4]
select * from test;
[0, 1, 2, 3, 4]
# test: while do insert returning
explain begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	while i < x do
		insert into test values (i) returning *;
		i := i + 1;
	end;
	select x;
end;
[{
  "main": {
    "00": "push_nulls          2      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "free                0      0      0     ",
    "04": "send_all            0      0      25    # public.test",
    "05": "recv_aggs           1      0      21    ",
    "06": "set                 2      1      0     ",
    "07": "store_open          3      1      12    ",
    "08": "agg                 4      3      0     ",
    "09": "push                4      0      0     ",
    "10": "set_add             2      0      0     ",
    "11": "store_next          3      8      0     ",
    "12": "free                3      0      0     ",
    "13": "free                1      0      0     ",
    "14": "var_set             0      0      2     ",
    "15": "free                2      0      0     ",
    "16": "var                 0      0      0     ",
    "17": "int                 1      -      0     # 1",
    "18": "addii               2      0      1     ",
    "19": "var_set             0      0      2     ",
    "20": "free                2      0      0     ",
    "21": "var                 0      0      0     ",
    "22": "int                 1      -      0     # 10",
    "23": "addii               2      0      1     ",
    "24": "var_set             1      0      2     ",
    "25": "free                2      0      0     ",
    "26": "var                 0      0      0     ",
    "27": "var                 1      1      0     ",
    "28": "ltii                2      0      1     ",
    "29": "jntr                40     2      0     ",
    "30": "push_var            0      0      1     ",
    "31": "set_ptr             1      -      0     ",
    "32": "send_shard          0      1      1     # public.test",
    "33": "var                 1      0      0     ",
    "34": "int                 2      -      0     # 1",
    "35": "addii               3      1      2     ",
    "36": "var_set             0      0      3     ",
    "37": "free                3      0      0     ",
    "38": "recv                1      0      -1    ",
    "39": "jmp                 26     0      0     ",
    "40": "close               0      0      0     ",
    "41": "var                 0      1      0     ",
    "42": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set_ordered         0      1      1     ",
    "01": "table_open_part     1      1      9     # public.test (primary)",
    "02": "bool                2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_get             2      0      0     ",
    "05": "table_readi32       3      1      0     ",
    "06": "push                3      0      0     ",
    "07": "set_agg             0      2      21    ",
    "08": "table_next          1      2      0     ",
    "09": "free                1      0      0     ",
    "10": "bool                1      1      0     ",
    "11": "push                1      0      0     ",
    "12": "set_get             1      0      0     ",
    "13": "null                2      0      0     ",
    "14": "push                2      0      0     ",
    "15": "set_agg             0      1      21    ",
    "16": "set_sort            0      0      0     ",
    "17": "ret                 0      0      -     ",
    "18": "set                 0      1      0     ",
    "19": "table_prepare       1      -      0     # public.test",
    "20": "jmp                 27     0      0     ",
    "21": "string              2      41     0     # unique key constraint violation",
    "22": "push                2      0      0     ",
    "23": "call                2      -      1     # public.error()",
    "24": "table_readi32       2      1      0     ",
    "25": "push                2      0      0     ",
    "26": "set_add             0      0      0     ",
    "27": "upsert              1      21     24    ",
    "28": "free                1      0      0     ",
    "29": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	while i < x do
		insert into test values (i) returning *;
		i := i + 1;
	end;
	select x;
end;
[15]
select * from test;
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
# test: while do insert returning into
explain begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	declare l int := 0;

	while i < x do
		insert into test values (i) returning id into l;
		i := i + 1;
	end;
	select x, l;
end;
[{
  "main": {
    "00": "push_nulls          3      0      0     ",
    "01": "int                 0      -      0     # 0",
    "02": "var_set             0      0      0     ",
    "03": "free                0      0      0     ",
    "04": "send_all            0      0      25    # public.test",
    "05": "recv_aggs           1      0      21    ",
    "06": "set                 2      1      0     ",
    "07": "store_open          3      1      12    ",
    "08": "agg                 4      3      0     ",
    "09": "push                4      0      0     ",
    "10": "set_add             2      0      0     ",
    "11": "store_next          3      8      0     ",
    "12": "free                3      0      0     ",
    "13": "free                1      0      0     ",
    "14": "var_set             0      0      2     ",
    "15": "free                2      0      0     ",
    "16": "var                 0      0      0     ",
    "17": "int                 1      -      0     # 1",
    "18": "addii               2      0      1     ",
    "19": "var_set             0      0      2     ",
    "20": "free                2      0      0     ",
    "21": "var                 0      0      0     ",
    "22": "int                 1      -      0     # 10",
    "23": "addii               2      0      1     ",
    "24": "var_set             1      0      2     ",
    "25": "free                2      0      0     ",
    "26": "int                 0      -      0     # 0",
    "27": "var_set             2      0      0     ",
    "28": "free                0      0      0     ",
    "29": "var                 0      0      0     ",
    "30": "var                 1      1      0     ",
    "31": "ltii                2      0      1     ",
    "32": "jntr                45     2      0     ",
    "33": "push_var            0      0      1     ",
    "34": "set_ptr             1      -      0     ",
    "35": "send_shard          0      1      1     # public.test",
    "36": "var                 1      0      0     ",
    "37": "int                 2      -      0     # 1",
    "38": "addii               3      1      2     ",
    "39": "var_set             0      0      3     ",
    "40": "free                3      0      0     ",
    "41": "recv                1      0      -1    ",
    "42": "var_set             2      0      1     ",
    "43": "free                1      0      0     ",
    "44": "jmp                 29     0      0     ",
    "45": "close               0      0      0     ",
    "46": "set                 0      2      0     ",
    "47": "var                 1      1      0     ",
    "48": "push                1      0      0     ",
    "49": "var                 1      2      0     ",
    "50": "push                1      0      0     ",
    "51": "set_add             0      0      0     ",
    "52": "ret                 0      0      -     "
  },
  "pushdown": {
    "00": "set_ordered         0      1      1     ",
    "01": "table_open_part     1      1      9     # public.test (primary)",
    "02": "bool                2      1      0     ",
    "03": "push                2      0      0     ",
    "04": "set_get             2      0      0     ",
    "05": "table_readi32       3      1      0     ",
    "06": "push                3      0      0     ",
    "07": "set_agg             0      2      21    ",
    "08": "table_next          1      2      0     ",
    "09": "free                1      0      0     ",
    "10": "bool                1      1      0     ",
    "11": "push                1      0      0     ",
    "12": "set_get             1      0      0     ",
    "13": "null                2      0      0     ",
    "14": "push                2      0      0     ",
    "15": "set_agg             0      1      21    ",
    "16": "set_sort            0      0      0     ",
    "17": "ret                 0      0      -     ",
    "18": "set                 0      1      0     ",
    "19": "table_prepare       1      -      0     # public.test",
    "20": "jmp                 27     0      0     ",
    "21": "string              2      41     0     # unique key constraint violation",
    "22": "push                2      0      0     ",
    "23": "call                2      -      1     # public.error()",
    "24": "table_readi32       2      1      0     ",
    "25": "push                2      0      0     ",
    "26": "set_add             0      0      0     ",
    "27": "upsert              1      21     24    ",
    "28": "free                1      0      0     ",
    "29": "ret                 0      0      -     "
  },
  "access": [["public.test", "rw"]]
}]
begin
	declare i int := 0;
	select max(id) into i from test;

	i := i + 1;
	declare x int := i + 10;
	declare l int := 0;

	while i < x do
		insert into test values (i) returning id into l;
		i := i + 1;
	end;
	select x, l;
end;
[[25, 24]]
select * from test;
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24]
# test: while utility
while true do show all; end;
{"msg": "while true do ❰show❱ ⟵ utility statement cannot be used here"}
# test: cte while
with a as (while true do end) select 1;
{"msg": "with a as (❰while❱ ⟵ statement cannot be used inside CTE"}
with a as (select 1) while true do end;
{"msg": "with a as (select 1) ❰while❱ ⟵ statement cannot be used inside CTE"}
disconnect S0;
close E0;
