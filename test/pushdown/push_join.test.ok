open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485
create shared table ref (id int primary key, data int default 0)
insert into ref (id) values (1), (2), (3)
create table test (id int primary key, data int default 0)
insert into test (id) values (1), (2), (3)
# test: select from table, shared
explain select test.*, ref.* from test, ref
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      4      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 17     0      0     ",
      "03": "table_open          1      20     5     # public.ref (primary)",
      "04": "jmp                 15     0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "table_readi32       1      0      1     ",
      "08": "push                1      0      0     ",
      "09": "table_readi32       1      1      0     ",
      "10": "push                1      0      0     ",
      "11": "table_readi32       1      1      1     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          1      5      0     ",
      "15": "table_close         1      0      0     ",
      "16": "table_next          0      3      0     ",
      "17": "table_close         0      0      0     ",
      "18": "result              0      0      0     ",
      "19": "ret                 0      0      0     "
    }
  }
}]
select test.*, ref.* from test, ref
[[1, 0, 1, 0], [1, 0, 2, 0], [1, 0, 3, 0], [2, 0, 1, 0], [2, 0, 2, 0], [2, 0, 3, 0], [3, 0, 1, 0], [3, 0, 2, 0], [3, 0, 3, 0]]
# test: select from shared, table
explain select test.*, ref.* from ref, test
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      4      0     ",
      "01": "table_open          0      0      3     # public.ref (primary)",
      "02": "jmp                 17     0      0     ",
      "03": "table_open          1      19     5     # public.test (primary)",
      "04": "jmp                 15     0      0     ",
      "05": "table_readi32       1      1      0     ",
      "06": "push                1      0      0     ",
      "07": "table_readi32       1      1      1     ",
      "08": "push                1      0      0     ",
      "09": "table_readi32       1      0      0     ",
      "10": "push                1      0      0     ",
      "11": "table_readi32       1      0      1     ",
      "12": "push                1      0      0     ",
      "13": "set_add             0      0      0     ",
      "14": "table_next          1      5      0     ",
      "15": "table_close         1      0      0     ",
      "16": "table_next          0      3      0     ",
      "17": "table_close         0      0      0     ",
      "18": "result              0      0      0     ",
      "19": "ret                 0      0      0     "
    }
  }
}]
select test.*, ref.* from ref, test
[[1, 0, 1, 0], [1, 0, 2, 0], [1, 0, 3, 0], [2, 0, 1, 0], [2, 0, 2, 0], [2, 0, 3, 0], [3, 0, 1, 0], [3, 0, 2, 0], [3, 0, 3, 0]]
# test: select from table, table
explain select t.* from test, test t
{"msg": "FROM: only one distributed table can be part of JOIN"}
select t.* from test, test t
{"msg": "FROM: only one distributed table can be part of JOIN"}
# test: select from table join shared
explain select test.id, ref.id from test join ref on true
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 15     0      0     ",
      "03": "table_open          1      20     5     # public.ref (primary)",
      "04": "jmp                 13     0      0     ",
      "05": "bool                1      1      0     ",
      "06": "jntr                12     1      0     ",
      "07": "table_readi32       1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "table_readi32       1      1      0     ",
      "10": "push                1      0      0     ",
      "11": "set_add             0      0      0     ",
      "12": "table_next          1      5      0     ",
      "13": "table_close         1      0      0     ",
      "14": "table_next          0      3      0     ",
      "15": "table_close         0      0      0     ",
      "16": "result              0      0      0     ",
      "17": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test join ref on true
[[1, 1], [1, 2], [1, 3], [2, 1], [2, 2], [2, 3], [3, 1], [3, 2], [3, 3]]
# test: select from table join shared on
explain select test.id, ref.id from test join ref on test.id = ref.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 19     0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_open_lookup   1      20     7     # public.ref (primary)",
      "06": "jmp                 17     0      0     ",
      "07": "table_readi32       1      0      0     ",
      "08": "table_readi32       2      1      0     ",
      "09": "equii               3      1      2     ",
      "10": "jntr                6      3      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "table_readi32       1      1      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "jmp                 6      0      0     ",
      "17": "table_close         1      0      0     ",
      "18": "table_next          0      3      0     ",
      "19": "table_close         0      0      0     ",
      "20": "result              0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test join ref on test.id = ref.id
[[1, 1], [2, 2], [3, 3]]
# test: select from table join shared on #2
explain select test.id, ref.id from test join ref on test.id = ref.id join ref ref2 on test.id = ref2.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 29     0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_open_lookup   1      20     7     # public.ref (primary)",
      "06": "jmp                 27     0      0     ",
      "07": "table_readi32       1      0      0     ",
      "08": "push                1      0      0     ",
      "09": "table_open_lookup   2      39     11    # public.ref (primary)",
      "10": "jmp                 25     0      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "table_readi32       2      1      0     ",
      "13": "equii               3      1      2     ",
      "14": "table_readi32       1      0      0     ",
      "15": "table_readi32       2      2      0     ",
      "16": "equii               4      1      2     ",
      "17": "and                 1      3      4     ",
      "18": "jntr                10     1      0     ",
      "19": "table_readi32       1      0      0     ",
      "20": "push                1      0      0     ",
      "21": "table_readi32       1      1      0     ",
      "22": "push                1      0      0     ",
      "23": "set_add             0      0      0     ",
      "24": "jmp                 10     0      0     ",
      "25": "table_close         2      0      0     ",
      "26": "jmp                 6      0      0     ",
      "27": "table_close         1      0      0     ",
      "28": "table_next          0      3      0     ",
      "29": "table_close         0      0      0     ",
      "30": "result              0      0      0     ",
      "31": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test join ref on test.id = ref.id join ref ref2 on test.id = ref2.id
[[1, 1], [2, 2], [3, 3]]
# test: select from table join shared on #3
explain select test.id, ref.id from test join ref on test.id = ref.id join ref ref2 on test.id = ref2.id where test.id > 0
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # 0",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 35     0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "table_open_lookup   1      20     9     # public.ref (primary)",
      "08": "jmp                 33     0      0     ",
      "09": "table_readi32       1      0      0     ",
      "10": "push                1      0      0     ",
      "11": "table_open_lookup   2      39     13    # public.ref (primary)",
      "12": "jmp                 31     0      0     ",
      "13": "table_readi32       1      0      0     ",
      "14": "int                 2      -      0     # 0",
      "15": "gtii                3      1      2     ",
      "16": "table_readi32       1      0      0     ",
      "17": "table_readi32       2      1      0     ",
      "18": "equii               4      1      2     ",
      "19": "and                 1      3      4     ",
      "20": "table_readi32       2      0      0     ",
      "21": "table_readi32       3      2      0     ",
      "22": "equii               4      2      3     ",
      "23": "and                 2      1      4     ",
      "24": "jntr                12     2      0     ",
      "25": "table_readi32       1      0      0     ",
      "26": "push                1      0      0     ",
      "27": "table_readi32       1      1      0     ",
      "28": "push                1      0      0     ",
      "29": "set_add             0      0      0     ",
      "30": "jmp                 12     0      0     ",
      "31": "table_close         2      0      0     ",
      "32": "jmp                 8      0      0     ",
      "33": "table_close         1      0      0     ",
      "34": "table_next          0      5      0     ",
      "35": "table_close         0      0      0     ",
      "36": "result              0      0      0     ",
      "37": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test join ref on test.id = ref.id join ref ref2 on test.id = ref2.id where test.id > 0
[[1, 1], [2, 2], [3, 3]]
# test: select from table join shared on #4
explain select test.id, ref.id from test, ref where test.id = ref.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 19     0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_open_lookup   1      20     7     # public.ref (primary)",
      "06": "jmp                 17     0      0     ",
      "07": "table_readi32       1      0      0     ",
      "08": "table_readi32       2      1      0     ",
      "09": "equii               3      1      2     ",
      "10": "jntr                6      3      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "table_readi32       1      1      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "jmp                 6      0      0     ",
      "17": "table_close         1      0      0     ",
      "18": "table_next          0      3      0     ",
      "19": "table_close         0      0      0     ",
      "20": "result              0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test, ref where test.id = ref.id
[[1, 1], [2, 2], [3, 3]]
explain select test.id, ref.id from test, ref where ref.id = test.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 19     0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_open_lookup   1      20     7     # public.ref (primary)",
      "06": "jmp                 17     0      0     ",
      "07": "table_readi32       1      1      0     ",
      "08": "table_readi32       2      0      0     ",
      "09": "equii               3      1      2     ",
      "10": "jntr                6      3      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "table_readi32       1      1      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "jmp                 6      0      0     ",
      "17": "table_close         1      0      0     ",
      "18": "table_next          0      3      0     ",
      "19": "table_close         0      0      0     ",
      "20": "result              0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test, ref where ref.id = test.id
[[1, 1], [2, 2], [3, 3]]
explain select test.id, ref.id from test, ref where ref.id = 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 19     0      0     ",
      "03": "int                 1      -      0     # 1",
      "04": "push                1      0      0     ",
      "05": "table_open_lookup   1      20     7     # public.ref (primary)",
      "06": "jmp                 17     0      0     ",
      "07": "table_readi32       1      1      0     ",
      "08": "int                 2      -      0     # 1",
      "09": "equii               3      1      2     ",
      "10": "jntr                6      3      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "table_readi32       1      1      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "jmp                 6      0      0     ",
      "17": "table_close         1      0      0     ",
      "18": "table_next          0      3      0     ",
      "19": "table_close         0      0      0     ",
      "20": "result              0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test, ref where ref.id = 1
[[1, 1], [2, 1], [3, 1]]
explain select test.id, ref.id from test, ref where ref.id = 1 and test.id = 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_lookup         0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # 1",
      "02": "push                1      0      0     ",
      "03": "table_open_lookup   0      0      5     # public.test (primary)",
      "04": "jmp                 25     0      0     ",
      "05": "int                 1      -      0     # 1",
      "06": "push                1      0      0     ",
      "07": "table_open_lookup   1      20     9     # public.ref (primary)",
      "08": "jmp                 23     0      0     ",
      "09": "table_readi32       1      1      0     ",
      "10": "int                 2      -      0     # 1",
      "11": "equii               3      1      2     ",
      "12": "table_readi32       1      0      0     ",
      "13": "int                 2      -      0     # 1",
      "14": "equii               4      1      2     ",
      "15": "and                 1      3      4     ",
      "16": "jntr                8      1      0     ",
      "17": "table_readi32       1      0      0     ",
      "18": "push                1      0      0     ",
      "19": "table_readi32       1      1      0     ",
      "20": "push                1      0      0     ",
      "21": "set_add             0      0      0     ",
      "22": "jmp                 8      0      0     ",
      "23": "table_close         1      0      0     ",
      "24": "jmp                 4      0      0     ",
      "25": "table_close         0      0      0     ",
      "26": "result              0      0      0     ",
      "27": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test, ref where ref.id = 1 and test.id = 1
[[1, 1]]
explain select test.id, ref.id from test, ref where ref.id >= test.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 19     0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_open          1      20     7     # public.ref (primary)",
      "06": "jmp                 17     0      0     ",
      "07": "table_readi32       1      1      0     ",
      "08": "table_readi32       2      0      0     ",
      "09": "gteii               3      1      2     ",
      "10": "jntr                16     3      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "table_readi32       1      1      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "table_next          1      7      0     ",
      "17": "table_close         1      0      0     ",
      "18": "table_next          0      3      0     ",
      "19": "table_close         0      0      0     ",
      "20": "result              0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test, ref where ref.id >= test.id
[[1, 1], [1, 2], [1, 3], [2, 2], [2, 3], [3, 3]]
# test: select from table join using
explain select test.id, ref.id from test join ref using
{"msg": "USING <(> expected"}
explain select test.id, ref.id from test join ref using(
{"msg": "USING (<column> expected"}
explain select test.id, ref.id from test join ref using(1
{"msg": "USING (<column> expected"}
explain select test.id, ref.id from test join ref using(id
{"msg": "USING (column <)> expected"}
explain select test.id, ref.id from test join ref using(id)
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 19     0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_open_lookup   1      20     7     # public.ref (primary)",
      "06": "jmp                 17     0      0     ",
      "07": "table_readi32       1      0      0     ",
      "08": "table_readi32       2      1      0     ",
      "09": "equii               3      1      2     ",
      "10": "jntr                6      3      0     ",
      "11": "table_readi32       1      0      0     ",
      "12": "push                1      0      0     ",
      "13": "table_readi32       1      1      0     ",
      "14": "push                1      0      0     ",
      "15": "set_add             0      0      0     ",
      "16": "jmp                 6      0      0     ",
      "17": "table_close         1      0      0     ",
      "18": "table_next          0      3      0     ",
      "19": "table_close         0      0      0     ",
      "20": "result              0      0      0     ",
      "21": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test join ref using(id)
[[1, 1], [2, 2], [3, 3]]
# test: select from table join using (not found)
select test.id, ref.id from test join ref using(unknown)
{"msg": "<test.unknown> column not found"}
# test: select from table join using #2
explain select test.id, ref.id from test join ref using (id) join ref ref2 using (id) where test.id > 0
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "content             0      -      -     ",
      "07": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "int                 1      -      0     # 0",
      "02": "push                1      0      0     ",
      "03": "table_open          0      0      5     # public.test (primary)",
      "04": "jmp                 35     0      0     ",
      "05": "table_readi32       1      0      0     ",
      "06": "push                1      0      0     ",
      "07": "table_open_lookup   1      20     9     # public.ref (primary)",
      "08": "jmp                 33     0      0     ",
      "09": "table_readi32       1      1      0     ",
      "10": "push                1      0      0     ",
      "11": "table_open_lookup   2      39     13    # public.ref (primary)",
      "12": "jmp                 31     0      0     ",
      "13": "table_readi32       1      0      0     ",
      "14": "int                 2      -      0     # 0",
      "15": "gtii                3      1      2     ",
      "16": "table_readi32       1      0      0     ",
      "17": "table_readi32       2      1      0     ",
      "18": "equii               4      1      2     ",
      "19": "and                 1      3      4     ",
      "20": "table_readi32       2      1      0     ",
      "21": "table_readi32       3      2      0     ",
      "22": "equii               4      2      3     ",
      "23": "and                 2      1      4     ",
      "24": "jntr                12     2      0     ",
      "25": "table_readi32       1      0      0     ",
      "26": "push                1      0      0     ",
      "27": "table_readi32       1      1      0     ",
      "28": "push                1      0      0     ",
      "29": "set_add             0      0      0     ",
      "30": "jmp                 12     0      0     ",
      "31": "table_close         2      0      0     ",
      "32": "jmp                 8      0      0     ",
      "33": "table_close         1      0      0     ",
      "34": "table_next          0      5      0     ",
      "35": "table_close         0      0      0     ",
      "36": "result              0      0      0     ",
      "37": "ret                 0      0      0     "
    }
  }
}]
select test.id, ref.id from test join ref using (id) join ref ref2 using (id) where test.id > 0
[[1, 1], [2, 2], [3, 3]]
select test.id, ref.id from test join ref using (id) join ref ref2 using (id2) where test.id > 0
{"msg": "<ref.id2> column not found"}
# test: with (select from table) select from table, cte
explain with a as (select * from test) select * from test, a where test.id = a.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_all            1      12     -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "merge_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     ",
      "12": "set                 0      4      0     ",
      "13": "table_open          0      20     15    # public.test (primary)",
      "14": "jmp                 34     0      0     ",
      "15": "cte_get             1      0      0     ",
      "16": "store_open          1      1      18    ",
      "17": "jmp                 32     0      0     ",
      "18": "table_readi32       2      0      0     ",
      "19": "store_read          3      1      0     ",
      "20": "equii               4      2      3     ",
      "21": "jntr                31     4      0     ",
      "22": "table_readi32       2      0      0     ",
      "23": "push                2      0      0     ",
      "24": "table_readi32       2      0      1     ",
      "25": "push                2      0      0     ",
      "26": "store_read          2      1      0     ",
      "27": "push                2      0      0     ",
      "28": "store_read          2      1      1     ",
      "29": "push                2      0      0     ",
      "30": "set_add             0      0      0     ",
      "31": "store_next          1      18     0     ",
      "32": "store_close         1      1      0     ",
      "33": "table_next          0      15     0     ",
      "34": "table_close         0      0      0     ",
      "35": "result              0      0      0     ",
      "36": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select * from test, a where test.id = a.id
[[1, 0, 1, 0], [2, 0, 2, 0], [3, 0, 3, 0]]
# test: with (select from table) select from table, cte (point lookup)
explain with a as (select * from test) select * from test, a where test.id = 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_lookup         1      12     -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "merge_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     ",
      "12": "set                 0      4      0     ",
      "13": "int                 1      -      0     # 1",
      "14": "push                1      0      0     ",
      "15": "table_open_lookup   0      20     17    # public.test (primary)",
      "16": "jmp                 36     0      0     ",
      "17": "cte_get             1      0      0     ",
      "18": "store_open          1      1      20    ",
      "19": "jmp                 34     0      0     ",
      "20": "table_readi32       2      0      0     ",
      "21": "int                 3      -      0     # 1",
      "22": "equii               4      2      3     ",
      "23": "jntr                33     4      0     ",
      "24": "table_readi32       2      0      0     ",
      "25": "push                2      0      0     ",
      "26": "table_readi32       2      0      1     ",
      "27": "push                2      0      0     ",
      "28": "store_read          2      1      0     ",
      "29": "push                2      0      0     ",
      "30": "store_read          2      1      1     ",
      "31": "push                2      0      0     ",
      "32": "set_add             0      0      0     ",
      "33": "store_next          1      20     0     ",
      "34": "store_close         1      1      0     ",
      "35": "jmp                 16     0      0     ",
      "36": "table_close         0      0      0     ",
      "37": "result              0      0      0     ",
      "38": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select * from test, a where test.id = 1
[[1, 0, 1, 0], [1, 0, 2, 0], [1, 0, 3, 0]]
# test: with (select from table) select from cte, table
explain with a as (select * from test) select * from a, test where test.id = a.id
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_all            1      12     -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "merge_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     ",
      "12": "set                 0      4      0     ",
      "13": "cte_get             1      0      0     ",
      "14": "store_open          0      1      16    ",
      "15": "jmp                 36     0      0     ",
      "16": "store_read          2      0      0     ",
      "17": "push                2      0      0     ",
      "18": "table_open_lookup   1      20     20    # public.test (primary)",
      "19": "jmp                 34     0      0     ",
      "20": "table_readi32       2      1      0     ",
      "21": "store_read          3      0      0     ",
      "22": "equii               4      2      3     ",
      "23": "jntr                19     4      0     ",
      "24": "store_read          2      0      0     ",
      "25": "push                2      0      0     ",
      "26": "store_read          2      0      1     ",
      "27": "push                2      0      0     ",
      "28": "table_readi32       2      1      0     ",
      "29": "push                2      0      0     ",
      "30": "table_readi32       2      1      1     ",
      "31": "push                2      0      0     ",
      "32": "set_add             0      0      0     ",
      "33": "jmp                 19     0      0     ",
      "34": "table_close         1      0      0     ",
      "35": "store_next          0      16     0     ",
      "36": "store_close         0      1      0     ",
      "37": "result              0      0      0     ",
      "38": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select * from a, test where test.id = a.id
[[1, 0, 1, 0], [2, 0, 2, 0], [3, 0, 3, 0]]
# test: with (select from table) select from cte, table (point lookup)
explain with a as (select * from test) select * from a, test where test.id = 1
[{
  "bytecode": {
    "coordinator": {
      "00": "send_all            0      0      -     # public.test",
      "01": "recv                0      0      0     ",
      "02": "bool                0      0      0     ",
      "03": "push                0      0      0     ",
      "04": "merge_recv          0      -1     -1    ",
      "05": "cte_set             0      0      0     ",
      "06": "send_lookup         1      12     -     # public.test",
      "07": "recv                1      0      0     ",
      "08": "bool                0      0      0     ",
      "09": "push                0      0      0     ",
      "10": "merge_recv          0      -1     -1    ",
      "11": "cte_set             1      0      0     ",
      "12": "content             1      -      -     ",
      "13": "ret                 0      0      0     "
    },
    "node": {
      "00": "set                 0      2      0     ",
      "01": "table_open          0      0      3     # public.test (primary)",
      "02": "jmp                 9      0      0     ",
      "03": "table_readi32       1      0      0     ",
      "04": "push                1      0      0     ",
      "05": "table_readi32       1      0      1     ",
      "06": "push                1      0      0     ",
      "07": "set_add             0      0      0     ",
      "08": "table_next          0      3      0     ",
      "09": "table_close         0      0      0     ",
      "10": "result              0      0      0     ",
      "11": "ret                 0      0      0     ",
      "12": "set                 0      4      0     ",
      "13": "cte_get             1      0      0     ",
      "14": "store_open          0      1      16    ",
      "15": "jmp                 36     0      0     ",
      "16": "int                 2      -      0     # 1",
      "17": "push                2      0      0     ",
      "18": "table_open_lookup   1      20     20    # public.test (primary)",
      "19": "jmp                 34     0      0     ",
      "20": "table_readi32       2      1      0     ",
      "21": "int                 3      -      0     # 1",
      "22": "equii               4      2      3     ",
      "23": "jntr                19     4      0     ",
      "24": "store_read          2      0      0     ",
      "25": "push                2      0      0     ",
      "26": "store_read          2      0      1     ",
      "27": "push                2      0      0     ",
      "28": "table_readi32       2      1      0     ",
      "29": "push                2      0      0     ",
      "30": "table_readi32       2      1      1     ",
      "31": "push                2      0      0     ",
      "32": "set_add             0      0      0     ",
      "33": "jmp                 19     0      0     ",
      "34": "table_close         1      0      0     ",
      "35": "store_next          0      16     0     ",
      "36": "store_close         0      1      0     ",
      "37": "result              0      0      0     ",
      "38": "ret                 0      0      0     "
    }
  }
}]
with a as (select * from test) select * from a, test where test.id = 1
[[1, 0, 1, 0], [2, 0, 1, 0], [3, 0, 1, 0]]
drop table ref
drop table test
disconnect S0
close E0
