#

open E0 "uuid": "00000000-0000-0000-0000-000000000000", "listen": [{ "host": "127.0.0.1", "port": 3485 }], "backends": 3
connect E0 S0 localhost:3485

# test: create table
create table test (id int serial primary key, data int default 0)
show lsn
select serial("public", "test")

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test")

# test: alter table rename
alter table test rename to test2
show lsn
select serial("public", "test")
select serial("public", "test2")

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test")
select serial("public", "test2")

# test: alter table set aggregated
alter table test2 set aggregated
select system.tables()['public.test2'].aggregated

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select system.tables()['public.test2'].aggregated

# test: alter table column add
insert into test2() values (), (), ()
select * from test2
show lsn
select serial("public", "test2")
alter table test2 add column obj json
select * from test2
select obj from test2

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select * from test2

# test: alter table column rename
alter table test2 rename column data to abc
select * from test2
select data from test2
select abc from test2

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select data from test2
select abc from test2

# test: alter table column drop
alter table test2 drop column abc
select abc from test2
select * from test2

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select * from test2

# test: create index
create index i on test2 (id)
select * from test2 use index (i)

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select * from test2 use index (i)

# test: alter index rename
alter index i on test2 rename to i2
show lsn
select * from test2 use index (i2)

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select * from test2 use index (i2)

# test: drop index
drop index i2 on test2
select * from test2 use index (i)
select * from test2 use index (i2)
select * from test2

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select * from test2 use index (i)
select * from test2 use index (i2)
select * from test2

# test: truncate
truncate test2
select * from test2

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select serial("public", "test2")
select * from test2

# test: drop table
drop table test2
show lsn
select serial("public", "test2")

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
select * from test2
show tables

# test: create schema
create schema test
show schemas
show lsn

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
show schemas

# test: alter schema rename
alter schema test rename to test2
show schemas
show lsn

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
show schemas

# test: drop schema
drop schema test2
show lsn
show schemas

# test: restart
disconnect S0
close E0
open E0
connect E0 S0 localhost:3485

# test: validate state
show lsn
show schemas

disconnect S0
close E0
