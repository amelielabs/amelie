env_open E0 "cluster_shards": 3
connect E0 S0
connect: on_connect
create table a (id int primary key, data int default 0)
create table b (id int primary key, data int default 0)
create table ref (id int primary key, data int default 0) reference
insert into ref values (0, 8), (1, 8), (2, 8);
# test: insert a select a
insert into a (id) values (0), (1), (2), (3); select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: select a select a
explain select * from a; select * from a
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp        7      0      0
 4         cursor_read        0      0      0
 5                send        0      0      0
 6         cursor_next        0      4      0
 7        cursor_close        0      0      0
 8               ready        0     -1      0
 9             int_min        0      0      0
10                push        0      0      0
11         cursor_open        0     17     13      # public.a (primary)
12                 jmp       16      0      0
13         cursor_read        0      0      0
14                send        0      0      0
15         cursor_next        0     13      0
16        cursor_close        0      0      0
17               ready        1     -1      0
18                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp        7      0      0
 4         cursor_read        0      0      0
 5                send        0      0      0
 6         cursor_next        0      4      0
 7        cursor_close        0      0      0
 8               ready        0     -1      0
 9             int_min        0      0      0
10                push        0      0      0
11         cursor_open        0     17     13      # public.a (primary)
12                 jmp       16      0      0
13         cursor_read        0      0      0
14                send        0      0      0
15         cursor_next        0     13      0
16        cursor_close        0      0      0
17               ready        1     -1      0
18                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp        7      0      0
 4         cursor_read        0      0      0
 5                send        0      0      0
 6         cursor_next        0      4      0
 7        cursor_close        0      0      0
 8               ready        0     -1      0
 9             int_min        0      0      0
10                push        0      0      0
11         cursor_open        0     17     13      # public.a (primary)
12                 jmp       16      0      0
13         cursor_read        0      0      0
14                send        0      0      0
15         cursor_next        0     13      0
16        cursor_close        0      0      0
17               ready        1     -1      0
18                 ret        0      0      0

"
select * from a; select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
[2, 0]
[1, 0]
[0, 0]
[3, 0]
# test: select a select a #2
begin; select * from a; select * from a; commit
[0, 0]
[2, 0]
[1, 0]
[3, 0]
[2, 0]
[1, 0]
[0, 0]
[3, 0]
# test: replace a select a
replace into a values (0, 1), (1, 1), (2, 1); select * from a; abort
[0, 1]
[2, 1]
[1, 1]
[3, 0]
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: replace a select a #2
begin; replace into a values (0, 1), (1, 1), (2, 1); select * from a; abort; commit
[0, 1]
[2, 1]
[1, 1]
[3, 0]
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: replace a abort select a
explain replace into a values (0, 1), (1, 1), (2, 1), (3, 1), (4, 1), (5, 1), (6, 1); abort; select * from a
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                recv        0      0      0
 3                 ret        0      0      0


bytecode [shard 0]
--------
 0              insert        -      0      3      # a
 1              insert        -      9      3      # a
 2              insert        -     12      3      # a
 3              insert        -     15      3      # a
 4               ready        0     -1      0
 5               abort        0      0      0
 6             int_min        0      0      0
 7                push        0      0      0
 8         cursor_open        0     21     10      # public.a (primary)
 9                 jmp       13      0      0
10         cursor_read        0      0      0
11                send        0      0      0
12         cursor_next        0     10      0
13        cursor_close        0      0      0
14               ready        2     -1      0
15                 ret        0      0      0


bytecode [shard 1]
--------
 0              insert        -      6      3      # a
 1              insert        -     18      3      # a
 2               ready        0     -1      0
 3               abort        0      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        0     21      8      # public.a (primary)
 7                 jmp       11      0      0
 8         cursor_read        0      0      0
 9                send        0      0      0
10         cursor_next        0      8      0
11        cursor_close        0      0      0
12               ready        2     -1      0
13                 ret        0      0      0


bytecode [shard 2]
--------
 0              insert        -      3      3      # a
 1               ready        0     -1      0
 2               abort        0      0      0
 3             int_min        0      0      0
 4                push        0      0      0
 5         cursor_open        0     21      7      # public.a (primary)
 6                 jmp       10      0      0
 7         cursor_read        0      0      0
 8                send        0      0      0
 9         cursor_next        0      7      0
10        cursor_close        0      0      0
11               ready        2     -1      0
12                 ret        0      0      0

"
replace into a values (0, 1), (1, 1), (2, 1), (3, 1), (4, 1), (5, 1), (6, 1); abort; select * from a
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: replace a abort select a #2
begin; replace into a values (0, 1), (1, 1), (2, 1), (3, 1), (4, 1), (5, 1), (6, 1); abort; select * from a; commit
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
# test: replace a insert b
explain replace into a values (0, 2), (1, 2), (2, 3); insert into b (id) values (10), (20), (30)
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0              insert        -      0      3      # a
 1               ready        0     -1      0
 2              insert        -     12      3      # b
 3              insert        -     15      3      # b
 4               ready        1     -1      0
 5                 ret        0      0      0


bytecode [shard 1]
--------
 0              insert        -      6      3      # a
 1               ready        0     -1      0
 2              insert        -      9      3      # b
 3               ready        1     -1      0
 4                 ret        0      0      0


bytecode [shard 2]
--------
 0              insert        -      3      3      # a
 1               ready        0     -1      0
 2                 ret        0      0      0

"
replace into a values (0, 2), (1, 2), (2, 3); insert into b (id) values (10), (20), (30)
select * from a
[0, 2]
[2, 3]
[1, 2]
[3, 0]
select * from b
[20, 0]
[10, 0]
[30, 0]
# test: update a update b abort
update a set data = 0
explain update a set data = id; update b set data = id; select * from a; select * from b; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                recv        0      0      0
 3                recv        0      0      0
 4                recv        0      0      0
 5                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16             int_min        0      0      0
17                push        0      0      0
18         cursor_open        0     17     20      # public.b (primary)
19                 jmp       30      0      0
20         cursor_read        0      0      0
21                push        0      0      0
22                null        0      0      0
23                push        0      0      0
24          cursor_idx        0      0      0
25                push        0      0      0
26              assign        0      3      1
27                push        0      0      0
28              update        0      0      0
29         cursor_next        0     20      0
30        cursor_close        0      0      0
31               ready        1     -1      0
32             int_min        0      0      0
33                push        0      0      0
34         cursor_open        0     34     36      # public.a (primary)
35                 jmp       39      0      0
36         cursor_read        0      0      0
37                send        0      0      0
38         cursor_next        0     36      0
39        cursor_close        0      0      0
40               ready        2     -1      0
41             int_min        0      0      0
42                push        0      0      0
43         cursor_open        0     51     45      # public.b (primary)
44                 jmp       48      0      0
45         cursor_read        0      0      0
46                send        0      0      0
47         cursor_next        0     45      0
48        cursor_close        0      0      0
49               ready        3     -1      0
50               abort        0      0      0
51                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16             int_min        0      0      0
17                push        0      0      0
18         cursor_open        0     17     20      # public.b (primary)
19                 jmp       30      0      0
20         cursor_read        0      0      0
21                push        0      0      0
22                null        0      0      0
23                push        0      0      0
24          cursor_idx        0      0      0
25                push        0      0      0
26              assign        0      3      1
27                push        0      0      0
28              update        0      0      0
29         cursor_next        0     20      0
30        cursor_close        0      0      0
31               ready        1     -1      0
32             int_min        0      0      0
33                push        0      0      0
34         cursor_open        0     34     36      # public.a (primary)
35                 jmp       39      0      0
36         cursor_read        0      0      0
37                send        0      0      0
38         cursor_next        0     36      0
39        cursor_close        0      0      0
40               ready        2     -1      0
41             int_min        0      0      0
42                push        0      0      0
43         cursor_open        0     51     45      # public.b (primary)
44                 jmp       48      0      0
45         cursor_read        0      0      0
46                send        0      0      0
47         cursor_next        0     45      0
48        cursor_close        0      0      0
49               ready        3     -1      0
50               abort        0      0      0
51                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       14      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      0
 9                push        0      0      0
10              assign        0      3      1
11                push        0      0      0
12              update        0      0      0
13         cursor_next        0      4      0
14        cursor_close        0      0      0
15               ready        0     -1      0
16             int_min        0      0      0
17                push        0      0      0
18         cursor_open        0     17     20      # public.b (primary)
19                 jmp       30      0      0
20         cursor_read        0      0      0
21                push        0      0      0
22                null        0      0      0
23                push        0      0      0
24          cursor_idx        0      0      0
25                push        0      0      0
26              assign        0      3      1
27                push        0      0      0
28              update        0      0      0
29         cursor_next        0     20      0
30        cursor_close        0      0      0
31               ready        1     -1      0
32             int_min        0      0      0
33                push        0      0      0
34         cursor_open        0     34     36      # public.a (primary)
35                 jmp       39      0      0
36         cursor_read        0      0      0
37                send        0      0      0
38         cursor_next        0     36      0
39        cursor_close        0      0      0
40               ready        2     -1      0
41             int_min        0      0      0
42                push        0      0      0
43         cursor_open        0     51     45      # public.b (primary)
44                 jmp       48      0      0
45         cursor_read        0      0      0
46                send        0      0      0
47         cursor_next        0     45      0
48        cursor_close        0      0      0
49               ready        3     -1      0
50               abort        0      0      0
51                 ret        0      0      0

"
update a set data = id; update b set data = id; select * from a; select * from b; abort
[0, 0]
[2, 2]
[1, 1]
[3, 3]
[10, 10]
[20, 20]
[30, 30]
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[0, 0]
[2, 0]
[1, 0]
[3, 0]
select * from b
[20, 0]
[10, 0]
[30, 0]
# test: update a update b
update a set data = 0
update a set data = id; update b set data = id; select * from a; select * from b;
[0, 0]
[2, 2]
[1, 1]
[3, 3]
[10, 10]
[20, 20]
[30, 30]
select * from a
[0, 0]
[2, 2]
[1, 1]
[3, 3]
select * from b
[20, 20]
[10, 10]
[30, 30]
# test: update a join ref update b
update a set data = 0
explain update a, ref set data = ref.data where a.id = ref.id; update b set data = data * 2; select * from a; select * from b;
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                recv        0      0      0
 3                recv        0      0      0
 4                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       24      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       22      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       21      2      0
12         cursor_read        0      0      0
13                push        0      0      0
14                null        0      0      0
15                push        0      0      0
16          cursor_idx        0      1      1
17                push        0      0      0
18              assign        0      3      1
19                push        0      0      0
20              update        0      0      0
21         cursor_next        1      8      0
22        cursor_close        1      0      0
23         cursor_next        0      4      0
24        cursor_close        0      0      0
25               ready        0     -1      0
26             int_min        0      0      0
27                push        0      0      0
28         cursor_open        0     36     30      # public.b (primary)
29                 jmp       42      0      0
30         cursor_read        0      0      0
31                push        0      0      0
32                null        0      0      0
33                push        0      0      0
34          cursor_idx        0      0      1
35                 int        1      2      0
36                 mul        2      0      1
37                push        2      0      0
38              assign        0      3      1
39                push        0      0      0
40              update        0      0      0
41         cursor_next        0     30      0
42        cursor_close        0      0      0
43               ready        1     -1      0
44             int_min        0      0      0
45                push        0      0      0
46         cursor_open        0     53     48      # public.a (primary)
47                 jmp       51      0      0
48         cursor_read        0      0      0
49                send        0      0      0
50         cursor_next        0     48      0
51        cursor_close        0      0      0
52               ready        2     -1      0
53             int_min        0      0      0
54                push        0      0      0
55         cursor_open        0     70     57      # public.b (primary)
56                 jmp       60      0      0
57         cursor_read        0      0      0
58                send        0      0      0
59         cursor_next        0     57      0
60        cursor_close        0      0      0
61               ready        3     -1      0
62                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       24      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       22      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       21      2      0
12         cursor_read        0      0      0
13                push        0      0      0
14                null        0      0      0
15                push        0      0      0
16          cursor_idx        0      1      1
17                push        0      0      0
18              assign        0      3      1
19                push        0      0      0
20              update        0      0      0
21         cursor_next        1      8      0
22        cursor_close        1      0      0
23         cursor_next        0      4      0
24        cursor_close        0      0      0
25               ready        0     -1      0
26             int_min        0      0      0
27                push        0      0      0
28         cursor_open        0     36     30      # public.b (primary)
29                 jmp       42      0      0
30         cursor_read        0      0      0
31                push        0      0      0
32                null        0      0      0
33                push        0      0      0
34          cursor_idx        0      0      1
35                 int        1      2      0
36                 mul        2      0      1
37                push        2      0      0
38              assign        0      3      1
39                push        0      0      0
40              update        0      0      0
41         cursor_next        0     30      0
42        cursor_close        0      0      0
43               ready        1     -1      0
44             int_min        0      0      0
45                push        0      0      0
46         cursor_open        0     53     48      # public.a (primary)
47                 jmp       51      0      0
48         cursor_read        0      0      0
49                send        0      0      0
50         cursor_next        0     48      0
51        cursor_close        0      0      0
52               ready        2     -1      0
53             int_min        0      0      0
54                push        0      0      0
55         cursor_open        0     70     57      # public.b (primary)
56                 jmp       60      0      0
57         cursor_read        0      0      0
58                send        0      0      0
59         cursor_next        0     57      0
60        cursor_close        0      0      0
61               ready        3     -1      0
62                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       24      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       22      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       21      2      0
12         cursor_read        0      0      0
13                push        0      0      0
14                null        0      0      0
15                push        0      0      0
16          cursor_idx        0      1      1
17                push        0      0      0
18              assign        0      3      1
19                push        0      0      0
20              update        0      0      0
21         cursor_next        1      8      0
22        cursor_close        1      0      0
23         cursor_next        0      4      0
24        cursor_close        0      0      0
25               ready        0     -1      0
26             int_min        0      0      0
27                push        0      0      0
28         cursor_open        0     36     30      # public.b (primary)
29                 jmp       42      0      0
30         cursor_read        0      0      0
31                push        0      0      0
32                null        0      0      0
33                push        0      0      0
34          cursor_idx        0      0      1
35                 int        1      2      0
36                 mul        2      0      1
37                push        2      0      0
38              assign        0      3      1
39                push        0      0      0
40              update        0      0      0
41         cursor_next        0     30      0
42        cursor_close        0      0      0
43               ready        1     -1      0
44             int_min        0      0      0
45                push        0      0      0
46         cursor_open        0     53     48      # public.a (primary)
47                 jmp       51      0      0
48         cursor_read        0      0      0
49                send        0      0      0
50         cursor_next        0     48      0
51        cursor_close        0      0      0
52               ready        2     -1      0
53             int_min        0      0      0
54                push        0      0      0
55         cursor_open        0     70     57      # public.b (primary)
56                 jmp       60      0      0
57         cursor_read        0      0      0
58                send        0      0      0
59         cursor_next        0     57      0
60        cursor_close        0      0      0
61               ready        3     -1      0
62                 ret        0      0      0

"
update a, ref set data = ref.data where a.id = ref.id; update b set data = data * 2; select * from a; select * from b
[0, 8]
[2, 8]
[1, 8]
[3, 0]
[10, 20]
[20, 40]
[30, 60]
select * from a
[0, 8]
[2, 8]
[1, 8]
[3, 0]
select * from b
[20, 40]
[10, 20]
[30, 60]
# test: update a join ref update b #2
begin; update a join ref on (a.id = ref.id) set data = ref.data; commit
select * from a
[0, 8]
[2, 8]
[1, 8]
[3, 0]
select * from b
[20, 40]
[10, 20]
[30, 60]
# test: delete a join ref update b abort
explain delete from a, ref where a.id = ref.id; update b set data = data * 2; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                recv        0      0      0
 3                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       16      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       14      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       13      2      0
12              delete        0      0      0
13         cursor_next        1      8      0
14        cursor_close        1      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        0     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     36     22      # public.b (primary)
21                 jmp       34      0      0
22         cursor_read        0      0      0
23                push        0      0      0
24                null        0      0      0
25                push        0      0      0
26          cursor_idx        0      0      1
27                 int        1      2      0
28                 mul        2      0      1
29                push        2      0      0
30              assign        0      3      1
31                push        0      0      0
32              update        0      0      0
33         cursor_next        0     22      0
34        cursor_close        0      0      0
35               ready        1     -1      0
36               abort        0      0      0
37                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       16      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       14      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       13      2      0
12              delete        0      0      0
13         cursor_next        1      8      0
14        cursor_close        1      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        0     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     36     22      # public.b (primary)
21                 jmp       34      0      0
22         cursor_read        0      0      0
23                push        0      0      0
24                null        0      0      0
25                push        0      0      0
26          cursor_idx        0      0      1
27                 int        1      2      0
28                 mul        2      0      1
29                push        2      0      0
30              assign        0      3      1
31                push        0      0      0
32              update        0      0      0
33         cursor_next        0     22      0
34        cursor_close        0      0      0
35               ready        1     -1      0
36               abort        0      0      0
37                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       16      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       14      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       13      2      0
12              delete        0      0      0
13         cursor_next        1      8      0
14        cursor_close        1      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        0     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     36     22      # public.b (primary)
21                 jmp       34      0      0
22         cursor_read        0      0      0
23                push        0      0      0
24                null        0      0      0
25                push        0      0      0
26          cursor_idx        0      0      1
27                 int        1      2      0
28                 mul        2      0      1
29                push        2      0      0
30              assign        0      3      1
31                push        0      0      0
32              update        0      0      0
33         cursor_next        0     22      0
34        cursor_close        0      0      0
35               ready        1     -1      0
36               abort        0      0      0
37                 ret        0      0      0

"
delete from a, ref where a.id = ref.id; update b set data = data * 2; select * from a; abort
[3, 0]
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[0, 8]
[2, 8]
[1, 8]
[3, 0]
select * from b
[20, 40]
[10, 20]
[30, 60]
# test: delete a join ref update b
explain begin; delete from a, ref where a.id = ref.id; update b set data = data * 2; commit
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                 ret        0      0      0


bytecode [shard 0]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       16      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       14      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       13      2      0
12              delete        0      0      0
13         cursor_next        1      8      0
14        cursor_close        1      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        0     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     36     22      # public.b (primary)
21                 jmp       34      0      0
22         cursor_read        0      0      0
23                push        0      0      0
24                null        0      0      0
25                push        0      0      0
26          cursor_idx        0      0      1
27                 int        1      2      0
28                 mul        2      0      1
29                push        2      0      0
30              assign        0      3      1
31                push        0      0      0
32              update        0      0      0
33         cursor_next        0     22      0
34        cursor_close        0      0      0
35               ready        1     -1      0
36                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       16      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       14      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       13      2      0
12              delete        0      0      0
13         cursor_next        1      8      0
14        cursor_close        1      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        0     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     36     22      # public.b (primary)
21                 jmp       34      0      0
22         cursor_read        0      0      0
23                push        0      0      0
24                null        0      0      0
25                push        0      0      0
26          cursor_idx        0      0      1
27                 int        1      2      0
28                 mul        2      0      1
29                push        2      0      0
30              assign        0      3      1
31                push        0      0      0
32              update        0      0      0
33         cursor_next        0     22      0
34        cursor_close        0      0      0
35               ready        1     -1      0
36                 ret        0      0      0


bytecode [shard 2]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      0      4      # public.a (primary)
 3                 jmp       16      0      0
 4             int_min        0      0      0
 5                push        0      0      0
 6         cursor_open        1     17      8      # public.ref (primary)
 7                 jmp       14      0      0
 8          cursor_idx        0      0      0
 9          cursor_idx        1      1      0
10                 equ        2      0      1
11                jntr       13      2      0
12              delete        0      0      0
13         cursor_next        1      8      0
14        cursor_close        1      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        0     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     36     22      # public.b (primary)
21                 jmp       34      0      0
22         cursor_read        0      0      0
23                push        0      0      0
24                null        0      0      0
25                push        0      0      0
26          cursor_idx        0      0      1
27                 int        1      2      0
28                 mul        2      0      1
29                push        2      0      0
30              assign        0      3      1
31                push        0      0      0
32              update        0      0      0
33         cursor_next        0     22      0
34        cursor_close        0      0      0
35               ready        1     -1      0
36                 ret        0      0      0

"
begin delete from a, ref where a.id = ref.id; update b set data = data * 2; select * from a; commit;
[3, 0]
select * from a
[3, 0]
select * from b
[20, 80]
[10, 40]
[30, 120]
# test: upsert a update b abort
explain insert into a values (1, 0), (3, 0) on conflict do update set data = id; update b set data = data * 2; select * from a; abort
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                recv        0      0      0
 3                recv        0      0      0
 4                 ret        0      0      0


bytecode [shard 0]
--------
 0      cursor_prepare        0      -      0      # public.a
 1                 jmp       12      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      0
 7                push        0      0      0
 8              assign        0      3      1
 9                push        0      0      0
10              update        0      0      0
11             jmp_pop        0      0      0
12              upsert        0      3      3
13        cursor_close        0      0      0
14               ready        0     -1      0
15             int_min        0      0      0
16                push        0      0      0
17         cursor_open        0      6     19      # public.b (primary)
18                 jmp       31      0      0
19         cursor_read        0      0      0
20                push        0      0      0
21                null        0      0      0
22                push        0      0      0
23          cursor_idx        0      0      1
24                 int        1      2      0
25                 mul        2      0      1
26                push        2      0      0
27              assign        0      3      1
28                push        0      0      0
29              update        0      0      0
30         cursor_next        0     19      0
31        cursor_close        0      0      0
32               ready        1     -1      0
33             int_min        0      0      0
34                push        0      0      0
35         cursor_open        0     23     37      # public.a (primary)
36                 jmp       40      0      0
37         cursor_read        0      0      0
38                send        0      0      0
39         cursor_next        0     37      0
40        cursor_close        0      0      0
41               ready        2     -1      0
42               abort        0      0      0
43                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      6      4      # public.b (primary)
 3                 jmp       16      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      1
 9                 int        1      2      0
10                 mul        2      0      1
11                push        2      0      0
12              assign        0      3      1
13                push        0      0      0
14              update        0      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        1     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     23     22      # public.a (primary)
21                 jmp       25      0      0
22         cursor_read        0      0      0
23                send        0      0      0
24         cursor_next        0     22      0
25        cursor_close        0      0      0
26               ready        2     -1      0
27               abort        0      0      0
28                 ret        0      0      0


bytecode [shard 2]
--------
 0      cursor_prepare        0      -      0      # public.a
 1                 jmp       12      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      0
 7                push        0      0      0
 8              assign        0      3      1
 9                push        0      0      0
10              update        0      0      0
11             jmp_pop        0      0      0
12              upsert        0      0      3
13        cursor_close        0      0      0
14               ready        0     -1      0
15             int_min        0      0      0
16                push        0      0      0
17         cursor_open        0      6     19      # public.b (primary)
18                 jmp       31      0      0
19         cursor_read        0      0      0
20                push        0      0      0
21                null        0      0      0
22                push        0      0      0
23          cursor_idx        0      0      1
24                 int        1      2      0
25                 mul        2      0      1
26                push        2      0      0
27              assign        0      3      1
28                push        0      0      0
29              update        0      0      0
30         cursor_next        0     19      0
31        cursor_close        0      0      0
32               ready        1     -1      0
33             int_min        0      0      0
34                push        0      0      0
35         cursor_open        0     23     37      # public.a (primary)
36                 jmp       40      0      0
37         cursor_read        0      0      0
38                send        0      0      0
39         cursor_next        0     37      0
40        cursor_close        0      0      0
41               ready        2     -1      0
42               abort        0      0      0
43                 ret        0      0      0

"
insert into a values (1, 0), (3, 0) on conflict do update set data = id; update b set data = data * 2; select * from a; abort
[3, 3]
[1, 0]
query: on_error
{"code": 1, "msg": "aborted"}
select * from a
[3, 0]
select * from b
[20, 80]
[10, 40]
[30, 120]
# test: upsert a update b
explain insert into a values (1, 0), (3, 0) on conflict do update set data = id; update b set data = data * 2; select * from a;
"
bytecode [coordinator]
--------
 0                recv        0      0      0
 1                recv        0      0      0
 2                recv        0      0      0
 3                 ret        0      0      0


bytecode [shard 0]
--------
 0      cursor_prepare        0      -      0      # public.a
 1                 jmp       12      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      0
 7                push        0      0      0
 8              assign        0      3      1
 9                push        0      0      0
10              update        0      0      0
11             jmp_pop        0      0      0
12              upsert        0      3      3
13        cursor_close        0      0      0
14               ready        0     -1      0
15             int_min        0      0      0
16                push        0      0      0
17         cursor_open        0      6     19      # public.b (primary)
18                 jmp       31      0      0
19         cursor_read        0      0      0
20                push        0      0      0
21                null        0      0      0
22                push        0      0      0
23          cursor_idx        0      0      1
24                 int        1      2      0
25                 mul        2      0      1
26                push        2      0      0
27              assign        0      3      1
28                push        0      0      0
29              update        0      0      0
30         cursor_next        0     19      0
31        cursor_close        0      0      0
32               ready        1     -1      0
33             int_min        0      0      0
34                push        0      0      0
35         cursor_open        0     23     37      # public.a (primary)
36                 jmp       40      0      0
37         cursor_read        0      0      0
38                send        0      0      0
39         cursor_next        0     37      0
40        cursor_close        0      0      0
41               ready        2     -1      0
42                 ret        0      0      0


bytecode [shard 1]
--------
 0             int_min        0      0      0
 1                push        0      0      0
 2         cursor_open        0      6      4      # public.b (primary)
 3                 jmp       16      0      0
 4         cursor_read        0      0      0
 5                push        0      0      0
 6                null        0      0      0
 7                push        0      0      0
 8          cursor_idx        0      0      1
 9                 int        1      2      0
10                 mul        2      0      1
11                push        2      0      0
12              assign        0      3      1
13                push        0      0      0
14              update        0      0      0
15         cursor_next        0      4      0
16        cursor_close        0      0      0
17               ready        1     -1      0
18             int_min        0      0      0
19                push        0      0      0
20         cursor_open        0     23     22      # public.a (primary)
21                 jmp       25      0      0
22         cursor_read        0      0      0
23                send        0      0      0
24         cursor_next        0     22      0
25        cursor_close        0      0      0
26               ready        2     -1      0
27                 ret        0      0      0


bytecode [shard 2]
--------
 0      cursor_prepare        0      -      0      # public.a
 1                 jmp       12      0      0
 2         cursor_read        0      0      0
 3                push        0      0      0
 4                null        0      0      0
 5                push        0      0      0
 6          cursor_idx        0      0      0
 7                push        0      0      0
 8              assign        0      3      1
 9                push        0      0      0
10              update        0      0      0
11             jmp_pop        0      0      0
12              upsert        0      0      3
13        cursor_close        0      0      0
14               ready        0     -1      0
15             int_min        0      0      0
16                push        0      0      0
17         cursor_open        0      6     19      # public.b (primary)
18                 jmp       31      0      0
19         cursor_read        0      0      0
20                push        0      0      0
21                null        0      0      0
22                push        0      0      0
23          cursor_idx        0      0      1
24                 int        1      2      0
25                 mul        2      0      1
26                push        2      0      0
27              assign        0      3      1
28                push        0      0      0
29              update        0      0      0
30         cursor_next        0     19      0
31        cursor_close        0      0      0
32               ready        1     -1      0
33             int_min        0      0      0
34                push        0      0      0
35         cursor_open        0     23     37      # public.a (primary)
36                 jmp       40      0      0
37         cursor_read        0      0      0
38                send        0      0      0
39         cursor_next        0     37      0
40        cursor_close        0      0      0
41               ready        2     -1      0
42                 ret        0      0      0

"
insert into a values (1, 0), (3, 0) on conflict do update set data = id; update b set data = data * 2; select * from a;
[3, 3]
[1, 0]
select * from a
[3, 3]
[1, 0]
select * from b
[20, 160]
[10, 80]
[30, 240]
drop table a
drop table b
drop table ref
# test: non-transactional commands
begin; show all; commit
query: on_error
{"code": 1, "msg": "DDL and utility operations are not transactional"}
show all; show all
query: on_error
{"code": 1, "msg": "DDL and utility operations are not transactional"}
disconnect S0
env_close E0
